!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define("exsurge",[],e):"object"==typeof exports?exports.exsurge=e():t.exsurge=e()}(this,function(){return function(t){var e={};function i(s){if(e[s])return e[s].exports;var n=e[s]={i:s,l:!1,exports:{}};return t[s].call(n.exports,n,n.exports,i),n.l=!0,n.exports}return i.m=t,i.c=e,i.d=function(t,e,s){i.o(t,e)||Object.defineProperty(t,e,{configurable:!1,enumerable:!0,get:s})},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=9)}([function(t,e,i){"use strict";i.d(e,"n",function(){return s}),e.b=function(t){return t},e.a=n,e.e=o,e.c=a,e.k=function(t){return s.FromDeviceIndependent(t,s.Centimeters)},e.m=function(t){return s.FromDeviceIndependent(t,s.Millimeters)},e.l=function(t){return s.FromDeviceIndependent(t,s.Inches)},i.d(e,"j",function(){return c}),e.o=function(){function t(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return t()+t()},e.p=function(t){return Object.keys(t).map(e=>`${e}: ${t[e]};`).join("")};var s={DeviceIndepenedent:0,Centimeters:1,Millimeters:2,Inches:3,DIU_PER_INCH:96,DIU_PER_CENTIMETER:96/2.54,ToDeviceIndependent:function(t,e){switch(e){case n:return t*DIU_PER_CENTIMETER;case o:return t*DIU_PER_CENTIMETER/10;case a:return t*DIU_PER_INCH;default:return t}},FromDeviceIndependent:function(t,e){switch(e){case n:return t/DIU_PER_CENTIMETER;case o:return t/DIU_PER_CENTIMETER*10;case a:return t/DIU_PER_INCH;default:return t}},StringToUnitsType:function(t){switch(t.ToLower()){case"in":case"inches":return a;case"cm":case"centimeters":return n;case"mm":case"millimeters":return o;case"di":case"device-independent":default:return DeviceIndepenedent}},UnitsTypeToString:function(t){switch(t){case a:return"in";case n:return"cm";case o:return"mm";case DeviceIndepenedent:default:return"device-independent"}}};function n(t){return s.ToDeviceIndependent(t,s.Centimeters)}function o(t){return s.ToDeviceIndependent(t,s.Millimeters)}function a(t){return s.ToDeviceIndependent(t,s.Inches)}class r{constructor(t,e){this.x=void 0!==t?t:0,this.y=void 0!==e?e:0}clone(){return new r(this.x,this.y)}equals(t){return this.x===t.x&&this.y===t.y}}e.g=r;class h{constructor(t,e,i,s){this.x=void 0!==t?t:1/0,this.y=void 0!==e?e:1/0,this.width=void 0!==i?i:-1/0,this.height=void 0!==s?s:-1/0}clone(){return new h(this.x,this.y,this.width,this.height)}isEmpty(){return this.x===1/0&&this.y===1/0&&this.width===-1/0&&this.height===-1/0}right(){return this.x+this.width}bottom(){return this.y+this.height}equals(t){return this.x===t.x&&this.y===t.y&&this.width===t.width&&this.height===t.height}contains(t){return t instanceof r?t.x>=this.x&&t.x<=this.x+this.width&&t.y>=this.y&&t.y<=this.y+this.height:this.x<=t.x&&this.x+this.width>=t.x+t.width&&this.y<=t.y&&this.y+this.height>=t.y+t.height}union(t){var e=Math.max(this.x+this.width,t.x+t.width),i=Math.max(this.y+this.height,t.y+t.height);this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.width=e-this.x,this.height=i-this.y}}e.h=h;class u{constructor(t,e,i,s){this.left=void 0!==t?t:0,this.top=void 0!==e?e:0,this.right=void 0!==i?i:0,this.bottom=void 0!==s?s:0}clone(){return new u(this.left,this.top,this.right,this.bottom)}equals(t){return this.left===t.left&&this.top===t.top&&this.right===t.right&&this.bottom===t.bottom}}e.d=u;class l{constructor(t,e){this.width=void 0!==t?t:0,this.height=void 0!==e?e:0}clone(){return new l(this.width,this.height)}equals(t){return this.width===t.width&&this.height===t.height}}e.i=l;var c={Do:0,Du:1,Re:2,Me:3,Mi:4,Fa:5,Fu:6,So:7,La:9,Te:10,Ti:11},d=[0,0,1,1,2,3,3,4,4,5,6,6],f=[c.Do,c.Re,c.Mi,c.Fa,c.So,c.La,c.Ti];class g{constructor(t,e){void 0===e&&(e=Math.floor(t/12),t%=12),this.step=t,this.octave=e}toInt(){return 12*this.octave+this.step}transpose(t){return new g(this.toInt()+t)}isHigherThan(t){return this.toInt()>t.toInt()}isLowerThan(t){return this.toInt()<t.toInt()}equals(t){return this.toInt()===t.toInt()}static stepToStaffOffset(t){return d[t]}static staffOffsetToStep(t){for(;t<0;)t=f.length+t;return f[t%f.length]}}e.f=g},function(t,e,i){"use strict";i.d(e,"j",function(){return r}),i.d(e,"p",function(){return h}),i.d(e,"s",function(){return u}),i.d(e,"n",function(){return m}),i.d(e,"m",function(){return y});var s=i(0),n=i(4),o=i(8),a=i(10);let r={None:"None",AcuteAccent:"AcuteAccent",Stropha:"Stropha",StrophaLiquescent:"StrophaLiquescent",BeginningAscLiquescent:"BeginningAscLiquescent",BeginningDesLiquescent:"BeginningDesLiquescent",CustosDescLong:"CustosDescLong",CustosDescShort:"CustosDescShort",CustosLong:"CustosLong",CustosShort:"CustosShort",DoClef:"DoClef",FaClef:"FaClef",Flat:"Flat",Mora:"Mora",Natural:"Natural",OriscusAsc:"OriscusAsc",OriscusDes:"OriscusDes",OriscusLiquescent:"OriscusLiquescent",PodatusLower:"PodatusLower",PodatusUpper:"PodatusUpper",Porrectus1:"Porrectus1",Porrectus2:"Porrectus2",Porrectus3:"Porrectus3",Porrectus4:"Porrectus4",PunctumCavum:"PunctumCavum",PunctumQuadratum:"PunctumQuadratum",PunctumQuadratumAscLiquescent:"PunctumQuadratumAscLiquescent",PunctumQuadratumDesLiquescent:"PunctumQuadratumDesLiquescent",PunctumInclinatum:"PunctumInclinatum",PunctumInclinatumLiquescent:"PunctumInclinatumLiquescent",Quilisma:"Quilisma",Sharp:"Sharp",TerminatingAscLiquescent:"TerminatingAscLiquescent",TerminatingDesLiquescent:"TerminatingDesLiquescent",VerticalEpisemaAbove:"VerticalEpisemaAbove",VerticalEpisemaBelow:"VerticalEpisemaBelow",VirgaLong:"VirgaLong",VirgaShort:"VirgaShort",Virgula:"Virgula",UpperBrace:"UpperBrace"};var h={ns:"http://www.w3.org/2000/svg",xmlns:"http://www.w3.org/2000/xmlns/",xlink:"http://www.w3.org/1999/xlink",svg:function(t,e){var i=document.createElementNS(this.ns,"svg");i.setAttribute("xmlns",this.ns),i.setAttribute("version","1.1"),i.setAttributeNS(this.xmlns,"xmlns:xlink",this.xlink),i.setAttribute("width",t),i.setAttribute("height",e);var s=document.createElementNS(this.ns,"defs");return i.appendChild(s),i.defs=s,i.clearNotations=function(){for(i.removeChild(s);i.hasChildNodes();)i.removeChild(i.lastChild);i.appendChild(s)},i},rect:function(t,e){var i=document.createElementNS(this.ns,"rect");return i.setAttribute("width",t),i.setAttribute("height",e),i},line:function(t,e,i,s){var n=document.createElementNS(this.ns,"line");return n.setAttribute("x1",t),n.setAttribute("y1",e),n.setAttribute("x2",i),n.setAttribute("y2",s),n},g:function(){return document.createElementNS(this.ns,"g")},text:function(){return document.createElementNS(this.ns,"text")},tspan:function(t){var e=document.createElementNS(this.ns,"tspan");return e.textContent=t,e},use:function(t){var e=document.createElementNS(this.ns,"use");return e.setAttributeNS(this.xlink,"xlink:href","#"+t),e},svgFragmentForGlyph:function(t,e){for(var i="",s=0;s<t.paths.length;++s){var n=t.paths[s];i+=h.createFragment(n.data?"path":"g",{d:n.data||void 0,fill:"negative"===n.type?"#fff":e})}return i},nodesForGlyph:function(t,e){for(var i=[],s=0;s<t.paths.length;++s){var n=t.paths[s];i.push(h.createNode(n.data?"path":"g",{d:n.data||void 0,fill:"negative"===n.type?"#fff":e}))}return i},createNode:function(t,e,i){var s=document.createElementNS(this.ns,t);for(var n in e&&e.source&&(s.source=e.source,delete e.source),e)if(e.hasOwnProperty(n)&&void 0!==e[n]){var o=e[n],a=n.match(/^([^:]+):([^:]+)$/);a?s.setAttributeNS(this[a[1]],a[2],o):s.setAttribute(n,o)}if(i)if("string"==typeof i)s.textContent=i;else if(i.constructor===[].constructor)for(var r=0;r<i.length;++r)s.appendChild(i[r]);else s.appendChild(i);return s},createFragment:function(t,e,i){null==i&&(i="");var s="<"+t+" ";for(var n in e)e.hasOwnProperty(n)&&void 0!==e[n]&&(s+=n+'="'+e[n]+'" ');return s+=">"+i+"</"+t+">"},parseFragment:function(t){var e=document.createElement("svg");if(t){var i=this.g();e.innerHTML="<svg>"+t.replace(/\n/,"").replace(/<(\w+)([^<]+?)\/>/g,"<$1$2></$1>")+"</svg>";for(var s=0,n=e.firstChild.childNodes.length;s<n;s++)i.appendChild(e.firstChild.firstChild);return i}},translate:function(t,e,i){return t.setAttribute("transform","translate("+e+","+i+")"),t},scale:function(t,e,i){return t.setAttribute("transform","scale("+e+","+i+")"),t}},u={Svg:0,Canvas:1};e.d=class{constructor(t=u.Svg){this.textMeasuringStrategy=t,this.defs={},this.makeDefs=[],this.defsNode=h.createNode("defs"),this.lyricTextSize=16,this.lyricTextFont="'Palatino Linotype', 'Book Antiqua', Palatino, serif",this.lyricTextColor="#000",this.rubricColor="#d00",this.specialCharProperties={"font-family":"'Exsurge Characters'",fill:this.rubricColor},this.textBeforeSpecialChar="",this.textAfterSpecialChar=".",this.specialCharText=(t=>t),this.fontStyleDictionary={"*":{"font-weight":"bold"},_:{"font-style":"italic"},"^":{fill:this.rubricColor},"%":{"font-variant":"small-caps","font-feature-settings":"'smcp'","-webkit-font-feature-settings":"'smcp'"}},this.alTextSize=this.lyricTextSize,this.alTextFont=this.lyricTextFont,this.alTextColor=this.lyricTextColor,this.alTextStyle="_",this.translationTextSize=this.lyricTextSize,this.translationTextFont=this.lyricTextFont,this.translationTextColor=this.lyricTextColor,this.translationTextStyle="_",this.dropCapTextSize=64,this.dropCapTextFont=this.lyricTextFont,this.dropCapTextColor=this.lyricTextColor,this.dropCapPadding=1,this.annotationTextSize=13,this.annotationTextFont=this.lyricTextFont,this.annotationTextColor=this.lyricTextColor,this.annotationPadding=1,this.minLedgerSeparation=2,this.minSpaceAboveStaff=1,this.minSpaceBelowStaff=2,this.glyphPunctumWidth=n.a.PunctumQuadratum.bounds.width,this.glyphPunctumHeight=n.a.PunctumQuadratum.bounds.height,this.maxExtraSpaceInStaffIntervals=.5,this.activeClef=null,this.neumeLineColor="#000",this.staffLineColor="#000",this.dividerLineColor="#000",this.defaultLanguage=new o.b,this.canvas=document.createElement("canvas"),this.canvasCtxt=this.canvas.getContext("2d"),this.pixelRatio=window.devicePixelRatio||1,t===u.Svg&&(this.svgTextMeasurer=h.svg(0,0),this.svgTextMeasurer.setAttribute("id","TextMeasurer"),this.svgTextMeasurer.setAttribute("style","position:absolute"),document.body.insertBefore(this.svgTextMeasurer,document.body.firstChild)),this.syllableConnector="-",this.setGlyphScaling(1/16),this.interSyllabicMultiplier=2.5,this.accidentalSpaceMultiplier=2,this.interVerbalMultiplier=1,this.drawGuides=!1,this.drawDebuggingBounds=!0,this.activeNotations=null,this.currNotationIndex=-1,this.condensingTolerance=.3,this.autoColor=!0,this.insertFontsInDoc()}setFont(t,e=16){this.lyricTextSize=e,this.lyricTextFont=t,this.alTextSize=e,this.alTextFont=t,this.translationTextSize=e,this.translationTextFont=t,this.dropCapTextSize=4*e,this.dropCapTextFont=t,this.annotationTextSize=2*e/3,this.annotationTextFont=t}setRubricColor(t){this.rubricColor=t,this.specialCharProperties.fill=t,this.fontStyleDictionary["^"].fill=t}createStyleCss(){for(var t=["lyric","aboveLinesText","translation","dropCap","annotation"],e="",i=0;i<t.length;++i){var s=1===i?"al":t[i],n=this[s+"TextColor"],o=this[s+"TextFont"],a=this[s+"TextSize"];e+=`.${t[i]}{fill:${n};font-family:${o};font-size:${a}px;font-kerning:normal}`}return e}createStyleNode(){var t=h.createNode("style",{});return t.textContent=this.createStyleCss(this),t}createStyle(){return"<style>"+this.createStyleCss(this)+"</style>"}updateHyphenWidth(){var t=new x(this,this.syllableConnector,m.SingleSyllable),e=this.minLyricWordSpacing/(this.hyphenWidth||this.minLyricWordSpacing)||1;this.hyphenWidth=t.bounds.width,this.minLyricWordSpacing=e*this.hyphenWidth}setGlyphScaling(t){for(this.glyphScaling=t,this.staffInterval=this.glyphPunctumWidth*this.glyphScaling,this.staffLineWeight=Math.round(this.staffInterval/8),this.neumeLineWeight=this.staffLineWeight,this.dividerLineWeight=this.neumeLineWeight,this.episemaLineWeight=1.25*this.neumeLineWeight,this.updateHyphenWidth(),this.intraNeumeSpacing=this.staffInterval/2;this.defsNode.firstChild;)this.defsNode.removeChild(this.defsNode.firstChild);for(var e=0;e<this.makeDefs.length;++e)this.makeDefs[e]()}calculateHeightFromStaffPosition(t){return-t*this.staffInterval}insertFontsInDoc(){var t=document.getElementById("exsurge-fonts");null===t&&((t=document.createElement("style")).id="exsurge-fonts",t.appendChild(document.createTextNode("@font-face{font-family: 'Exsurge Characters';font-weight: normal;font-style: normal;src: url("+a+") format('opentype');}")),document.head.appendChild(t))}findNextNeume(){if(void 0===this.currNotationIndex)throw"findNextNeume() called without a valid currNotationIndex set";for(var t=this.currNotationIndex+1;t<this.notations.length;t++){var e=this.notations[t];if(e.isNeume&&!e.hasNoWidth)return e}return null}setCanvasSize(t,e,i=1){this.canvas.style.width=t*i+"px",this.canvas.style.height=e*i+"px",i*=this.pixelRatio,this.canvas.width=t*i,this.canvas.height=e*i,this.canvasCtxt.setTransform(i,0,0,i,0,0)}};class l{constructor(){this.bounds=new s.h,this.origin=new s.g(0,0),this.selected=!1,this.highlighted=!1}draw(t){throw"ChantLayout Elements must implement draw(ctxt)"}createSvgNode(t){throw"ChantLayout Elements must implement createSvgNode(ctxt)"}createSvgFragment(t){throw"ChantLayout Elements must implement createSvgFragment(ctxt)"}}e.e=l;e.h=class extends l{constructor(t,e,i){super();var s=t.calculateHeightFromStaffPosition(e),n=t.calculateHeightFromStaffPosition(i);if(s>n){var o=s;s=n,n=o}this.bounds.x=0,this.bounds.y=s,this.bounds.width=t.dividerLineWeight,this.bounds.height=n-s,this.origin.x=this.bounds.width/2,this.origin.y=s}draw(t){var e=t.canvasCtxt;e.fillStyle=t.dividerLineColor,e.fillRect(this.bounds.x,this.bounds.y,t.dividerLineWeight,this.bounds.height)}createSvgNode(t){return h.createNode("rect",{x:this.bounds.x,y:this.bounds.y,width:t.dividerLineWeight,height:this.bounds.height,fill:t.dividerLineColor,class:"dividerLine"})}createSvgFragment(t){return h.createFragment("rect",{x:this.bounds.x,y:this.bounds.y,width:t.dividerLineWeight,height:this.bounds.height,fill:t.dividerLineColor,class:"dividerLine"})}};e.o=class extends l{constructor(t,e,i,s){super();var n=e.staffPosition,o=i.staffPosition;if(n<o){var a=n;n=o,o=a}var r=t.calculateHeightFromStaffPosition(n),h=0;s&&(n-o==1&&Math.abs(n)%2==1&&o>-3&&o--,h+=t.glyphPunctumHeight*t.glyphScaling/2.2),h+=t.calculateHeightFromStaffPosition(o),this.bounds.x=0,this.bounds.y=r,this.bounds.width=t.neumeLineWeight,this.bounds.height=h-r,this.origin.x=0,this.origin.y=0}draw(t){var e=t.canvasCtxt;e.fillStyle=t.neumeLineColor,e.fillRect(this.bounds.x,this.bounds.y,t.neumeLineWeight,this.bounds.height)}createSvgNode(t){return h.createNode("rect",{x:this.bounds.x,y:this.bounds.y,width:t.neumeLineWeight,height:this.bounds.height,fill:t.neumeLineColor,class:"neumeLine"})}createSvgFragment(t){return h.createFragment("rect",{x:this.bounds.x,y:this.bounds.y,width:t.neumeLineWeight,height:this.bounds.height,fill:t.neumeLineColor,class:"neumeLine"})}};e.u=class extends l{constructor(t,e){super();var i,s=e.staffPosition,n=t.calculateHeightFromStaffPosition(s);i=0===Math.abs(s%2)?n+1.8*t.staffInterval:n+2.7*t.staffInterval,this.bounds.x=0,this.bounds.y=n,this.bounds.width=t.neumeLineWeight,this.bounds.height=i-n,this.origin.x=0,this.origin.y=0}draw(t){var e=t.canvasCtxt;e.fillStyle=t.neumeLineColor,e.fillRect(this.bounds.x,this.bounds.y,t.neumeLineWeight,this.bounds.height)}createSvgNode(t){return h.createNode("rect",{x:this.bounds.x,y:this.bounds.y,width:t.neumeLineWeight,height:this.bounds.height,fill:t.neumeLineColor,class:"neumeLine"})}createSvgFragment(t){return h.createFragment("rect",{x:this.bounds.x,y:this.bounds.y,width:t.neumeLineWeight,height:this.bounds.height,fill:t.neumeLineColor,class:"neumeLine"})}};class c extends l{constructor(t,e){super(),this.glyph=null,this.setGlyph(t,e)}setGlyph(t,e){if(this.glyphCode!==e){if(this.glyphCode=null==e||""===e?r.None:e,this.glyph=n.a[this.glyphCode],!t.defs.hasOwnProperty(this.glyphCode)){var i=()=>{t.defs[this.glyphCode]=h.createFragment("g",{id:this.glyphCode,class:"glyph",transform:"scale("+t.glyphScaling+")"},h.svgFragmentForGlyph(this.glyph,t.neumeLineColor)),t.defsNode.appendChild(h.createNode("g",{id:this.glyphCode,class:"glyph",transform:"scale("+t.glyphScaling+")"},h.nodesForGlyph(this.glyph,t.neumeLineColor)))};i(),t.makeDefs.push(i)}this.align=this.glyph.align,this.origin.x=this.glyph.origin.x*t.glyphScaling,this.origin.y=this.glyph.origin.y*t.glyphScaling,this.bounds.x=0,this.bounds.y=-this.origin.y,this.bounds.width=this.glyph.bounds.width*t.glyphScaling,this.bounds.height=this.glyph.bounds.height*t.glyphScaling}}setStaffPosition(t,e){this.bounds.y+=t.calculateHeightFromStaffPosition(e)}draw(t){var e=t.canvasCtxt,i=this.bounds.x+this.origin.x,s=this.bounds.y+this.origin.y;e.translate(i,s),e.scale(t.glyphScaling,t.glyphScaling);for(var n=0;n<this.glyph.paths.length;n++){var o=this.glyph.paths[n];e.fillStyle="negative"===o.type?"#fff":void 0,e.fill(new Path2D(o.data))}e.scale(1/t.glyphScaling,1/t.glyphScaling),e.translate(-i,-s)}createSvgNode(t,e){return h.createNode("use",{source:e,"source-index":e.sourceIndex,"xlink:href":"#"+this.glyphCode,x:this.bounds.x+this.origin.x,y:this.bounds.y+this.origin.y})}createSvgFragment(t,e){return h.createFragment("use",{"source-index":e.sourceIndex,"xlink:href":"#"+this.glyphCode,x:this.bounds.x+this.origin.x,y:this.bounds.y+this.origin.y})}}e.k=c;e.q=class extends l{constructor(t,e,i,n,o){if(super(),e>i){var a=e;e=i,i=a}this.isAbove=o,this.braceHeight=3*t.staffInterval/2,this.bounds=new s.h(e,o?n-this.braceHeight:n,i-e,this.braceHeight),this.origin.x=0,this.origin.y=0}createSvgNode(t){var e=h.createNode("path",{d:this.generatePathString(),stroke:t.neumeLineColor,"stroke-width":t.staffLineWeight+"px",fill:"none",class:"brace"});return this.acuteAccent?h.createNode("g",{class:"accentedBrace"},[e,this.acuteAccent.createSvgNode(t)]):e}createSvgFragment(t){var e=h.createFragment("path",{d:this.generatePathString(),stroke:t.neumeLineColor,"stroke-width":t.staffLineWeight+"px",fill:"none",class:"brace"});return this.acuteAccent?(e+=this.acuteAccent.createSvgFragment(t),h.createFragment("g",{class:"accentedBrace"},e)):e}generatePathString(){var t,e,i,s=this.bounds.x,n=this.bounds.right();e=this.bounds.width/6,i=this.bounds.height,this.isAbove?(t=this.bounds.bottom(),i=-i):t=this.bounds.y;var o=s+e,a=t+i,r=n-e;return"M "+s.toFixed(2)+" "+t.toFixed(2)+" C "+o.toFixed(2)+" "+a.toFixed(2)+" "+r.toFixed(2)+" "+a.toFixed(2)+" "+n.toFixed(2)+" "+t.toFixed(2)}};e.g=class extends l{constructor(t,e,i,n,o=!0,a=!1){if(super(),e>i){var h=e;e=i,i=h}this.isAbove=o,this.braceHeight=t.staffInterval/2,o&&(n-=this.braceHeight);var u=new s.h(e,n,i-e,this.braceHeight);a&&o&&(this.acuteAccent=new c(t,r.AcuteAccent),this.acuteAccent.bounds.x+=u.x+(i-e)/2,this.acuteAccent.bounds.y+=u.y-t.staffInterval/4,u.union(this.acuteAccent.bounds)),this.bounds=u,this.origin.x=0,this.origin.y=0}createSvgNode(t){var e=h.createNode("path",{d:this.generatePathString(),stroke:t.neumeLineColor,"stroke-width":t.staffLineWeight+"px",fill:"none",class:"brace"});return this.acuteAccent?h.createNode("g",{class:"accentedBrace"},[e,this.acuteAccent.createSvgFragment(t)]):e}createSvgFragment(t){var e=h.createFragment("path",{d:this.generatePathString(),stroke:t.neumeLineColor,"stroke-width":t.staffLineWeight+"px",fill:"none",class:"brace"});return this.acuteAccent?(e+=this.acuteAccent.createSvgFragment(t),h.createFragment("g",{class:"accentedBrace"},e)):e}generatePathString(){var t,e,i=this.bounds.x,s=this.bounds.right(),n=this.bounds.width;this.isAbove?(t=this.bounds.bottom(),e=-this.braceHeight):(t=this.bounds.y,e=this.braceHeight);var o=t+.6*e,a=i+.25*n,r=t+.4*e,h=i+.5*n,u=t+e,l=t+.6*e,c=i+.75*n,d=t+.4*e;return"M "+i.toFixed(2)+" "+t.toFixed(2)+" Q "+i.toFixed(2)+" "+o.toFixed(2)+" "+a.toFixed(2)+" "+r.toFixed(2)+" T "+h.toFixed(2)+" "+u.toFixed(2)+" M "+s.toFixed(2)+" "+t.toFixed(2)+" Q "+s.toFixed(2)+" "+l.toFixed(2)+" "+c.toFixed(2)+" "+d.toFixed(2)+" T "+h.toFixed(2)+" "+u.toFixed(2)}};var d=function(t,e){null==e&&(e={}),this.text=t,this.properties=e};function f(t,e,i={}){this.symbol=t,this.startIndex=e,this.properties=i}f.createStackFrame=function(t,e,i){return new f(e,i,t.fontStyleDictionary[e])};var g={"&":"&amp;","<":"&lt;",">":"&gt;"};class p extends l{constructor(t,e,i,s,n,o){super(),this.bounds.x=0,this.bounds.y=0,this.bounds.width=0,this.bounds.height=0,this.origin.x=0,this.origin.y=0,this.fontFamily=i,this.fontSize=s,this.textAnchor=n,this.sourceIndex=o,this.dominantBaseline="baseline",this.generateSpansFromText(t,e),this.recalculateMetrics(t)}generateSpansFromText(t,e){if(e=e.replace(/\s+/g," "),this.text="",this.spans=[],"*"!==e&&"†"!==e){for(var i=[],s=0,n=(t,e)=>t.Symbol===e,o=(t,e)=>{if(""!==t||this.dropCap){this.text+=t;for(var s={},n=0;n<i.length;n++)Object.assign(s,i[n].properties);e&&Object.assign(s,e),this.spans.push(new d(t,s))}},a=/\\?([arv])(?:bar|\/\.)|([*_^%])(?=(?:(.+?)\2)?)/gi,r=null;r=a.exec(e);){var h=r[2];if(r[1])o(t.textBeforeSpecialChar+t.specialCharText(r[1])+t.textAfterSpecialChar,t.specialCharProperties);else if(0===i.length){if("*"===h&&!r[3])continue;o(e.substring(s,r.index)),i.push(f.createStackFrame(t,h,r.index))}else if(i[i.length-1].symbol===h)o(e.substring(s,r.index)),i.pop();else{if(i.filter(n).length>0){s=i[i.length-1].startIndex,i.pop();continue}if("*"===h&&!r[3])continue;o(e.substring(s,r.index)),i.push(f.createStackFrame(t,h,r.index))}s=r.index+r[0].length}s<e.length&&o(e.substring(s,e.length)),0===this.spans.length&&o(e)}else this.spans.push(new d(e))}getCanvasFontForProperties(t={}){var e="";return"italic"===t["font-style"]&&(e+="italic "),"small-caps"===t["font-variant"]&&(e+="small-caps "),"bold"===t["font-weight"]&&(e+="bold "),e+=(t["font-size"]||`${this.fontSize*(this.resize||1)}px`)+" ",e+=t["font-family"]||this.fontFamily}measureSubstring(t,e){if(0===e)return 0;if(e||(e=1/0),e<0){var i=-e;e=1/0}for(var s=t.canvasCtxt,n=0,o=[],a=[this.spans[0]],r=0,h=0;h<this.spans.length;h++){var u=this.spans[h],l=u.text.slice(0,e-r);if(u.properties.newLine){if(i||!0!==this.rightAligned||e!==1/0){if(0==--i)break}else a[a.length-1].properties.xOffset=this.firstLineMaxWidth-n,a.push(u);o.push(n),n=0}if(s.font=this.getCanvasFontForProperties(u.properties),n+=s.measureText(l,this.bounds.x,this.bounds.y).width,(r+=l.length)===e)break}return!i&&n&&a.length&&!0===this.rightAligned&&e===1/0&&(a[a.length-1].properties.xOffset=this.firstLineMaxWidth-n),Math.max(n,...o)}recalculateMetrics(t){if(this.bounds.x=0,this.bounds.y=0,this.origin.x=0,t.textMeasuringStrategy===u.Svg){for(;t.svgTextMeasurer.firstChild;)t.svgTextMeasurer.removeChild(t.svgTextMeasurer.firstChild);t.svgTextMeasurer.appendChild(this.createSvgNode(t)),t.svgTextMeasurer.appendChild(t.createStyleNode());var e=t.svgTextMeasurer.firstChild.getBBox();this.bounds.width=e.width,this.bounds.height=e.height,this.origin.y=-e.y}else if(t.textMeasuringStrategy===u.Canvas){var i=this.spans.reduce((t,e)=>t+(e.properties.newLine?1:0),1);this.bounds.width=this.measureSubstring(t,this.rightAligned?-1:void 0),this.bounds.height=this.fontSize*Math.min(1,i+.2),this.origin.y=this.fontSize}}setMaxWidth(t,e,i=e){if(this.spans.filter(t=>t.properties.newLine).length&&this.recalculateMetrics(t),this.bounds.width>e){this.maxWidth=e;var s=e/this.bounds.width;if(s>=.85)this.resize=s,console.info(s,this.text);else{i<0&&(i=e),this.firstLineMaxWidth=i;for(var n,o=null,a=/\s+|$/g,r=i;(n=a.exec(this.text))&&(!o||n.index>o.index);){var h=this.measureSubstring(t,n.index);if(h>r&&o){for(var u=0,l=0;l<o.index&&u<this.spans.length;){let t=this.spans[u++];l+=t.text.length+(t.properties.newLine?1:0)}if(l>o.index){l-=this.spans[--u].text.length}var c=this.spans[u],f=c.text.slice(0,o.index-l),g=c.text.slice(o.index+o[0].length-l),p=[];if(this.rightAligned=r===i&&i!==e,f&&p.push(new d(f,c.properties)),g?p.push(new d(g,Object.assign({},c.properties,{newLine:!0}))):this.spans[u+1]&&(this.spans[u+1].properties.newLine=!0),this.spans.splice(u,1,...p),this.needsLayout=!0,r=e,n.index===this.text.length||this.measureSubstring(t)<=e)break;h=0,n=o=null}h,o=n}}this.recalculateMetrics(t,!1)}}getCssClasses(){return""}getExtraStyleProperties(t){return{}}static escapeForTspan(t){return String(t).replace(/[&<>]/g,function(t){return g[t]})}draw(t){var e=t.canvasCtxt;"middle"===this.textAnchor?e.textAlign="center":e.textAlign="start";for(var i=0,s=0,n=0;n<this.spans.length;n++){var o=this.spans[n],a=o.properties.xOffset||0;o.properties.newLine?(e.translate(i+a,this.fontSize),i=-a,s-=this.fontSize):a&&(e.translate(i+a,0),i=-a);var r=Object.assign({},this.getExtraStyleProperties(t),o.properties);e.font=this.getCanvasFontForProperties(r),e.fillStyle=r.fill||"#000",e.fillText(o.text,this.bounds.x,this.bounds.y,o.properties.textLength||void 0);var h=e.measureText(o.text,this.bounds.x,this.bounds.y);i-=h.width,e.translate(h.width,0)}e.translate(i,s)}createSvgNode(t){for(var e=[],i=0;i<this.spans.length;i++){var n=this.spans[i],o={};if(o.style=Object(s.p)(n.properties),n.properties.newLine){var a=n.properties.xOffset||0;o.dy="1em",o.x=this.bounds.x+a}else n.properties.xOffset&&(o.x=this.bounds.x+n.properties.xOffset);n.properties.textLength&&(o.textLength=n.properties.textLength,o.lengthAdjust="spacingAndGlyphs",o.y=this.bounds.y),this.resize&&(o["font-size"]=n.properties["font-size"]||this.fontSize*this.resize),e.push(h.createNode("tspan",o,n.text))}var r=Object(s.p)(this.getExtraStyleProperties(t));return h.createNode("text",{source:this,"source-index":this.sourceIndex,x:this.bounds.x,y:this.bounds.y,class:this.getCssClasses().trim(),"text-anchor":this.textAnchor,style:r},e)}createSvgFragment(t){for(var e="",i=0;i<this.spans.length;i++){var n=this.spans[i],o={};if(o.style=Object(s.p)(n.properties),n.properties.newLine){var a=n.properties.xOffset||0;o.dy="1em",o.x=this.bounds.x+a}else n.properties.xOffset&&(o.x=this.bounds.x+n.properties.xOffset);n.properties.textLength&&(o.textLength=n.properties.textLength,o.lengthAdjust="spacingAndGlyphs",o.y=this.bounds.y),this.resize&&(o["font-size"]=n.properties["font-size"]||this.fontSize*this.resize),e+=h.createFragment("tspan",o,p.escapeForTspan(n.text))}var r=Object(s.p)(this.getExtraStyleProperties(t));return h.createFragment("text",{"source-index":this.sourceIndex,x:this.bounds.x,y:this.bounds.y,class:this.getCssClasses().trim(),"text-anchor":this.textAnchor,style:r},e)}}e.r=p;var m={SingleSyllable:0,BeginningSyllable:1,MiddleSyllable:2,EndingSyllable:3,Directive:4},y={getLeft:function(t){if(0===t.length)return NaN;for(var e=Number.MAX_VALUE,i=0;i<t.length;i++)t[i]&&(e=Math.min(e,t[i].notation.bounds.x+t[i].bounds.x));return e},getRight:function(t,e){if(0===t.length)return NaN;for(var i=Number.MIN_VALUE,s=0;s<t.length;s++){let n=t[s];n&&(i=Math.max(i,n.notation.bounds.x+n.bounds.x+n.bounds.width+(e&&n.allowsConnector()&&!n.needsConnector?n.getConnectorWidth():0)))}return i},hasOnlyOneLyric:function(t){return 1===t.filter(t=>t.originalText).length},indexOfLyric:function(t){return t.indexOf(t.filter(t=>t.originalText)[0])},mergeIn:function(t,e){for(var i=0;i<e.length;++i)!e[i].originalText&&t[i]||(t[i]=e[i])},mergeInArray:function(t,e){for(var i=0;i<e.length;++i)this.mergeIn(t,e[i].lyrics)},setNotation:function(t,e){e.lyrics=t;for(var i=0;i<t.length;++i)t[i].notation=e}};class x extends p{constructor(t,e,i,s,n,o){super(t,(t.lyricTextStyle||"")+e,t.lyricTextFont,t.lyricTextSize,"start",o),this.originalText=e,this.notation=s,this.notations=n,this.lyricType=null==i||""===i?m.SingleSyllable:i,this.centerStartIndex=-1,this.centerLength=e.length,this.needsConnector=!1,this.language=null,this.allowsConnector&&(this.connectorSpan=new d(t.syllableConnector))}allowsConnector(){return this.lyricType===m.BeginningSyllable||this.lyricType===m.MiddleSyllable}setForceConnector(t){this.forceConnector=t&&this.allowsConnector()}setNeedsConnector(t,e){if(!0===t||this.forceConnector)this.needsConnector=!0,void 0!==e?this.setConnectorWidth(e):this.bounds.width=this.widthWithoutConnector+this.getConnectorWidth(),this.spans.length>0&&this.spans[this.spans.length-1]!==this.connectorSpan&&this.spans.push(this.connectorSpan);else{this.connectorWidth=0,this.needsConnector=!1,this.bounds.width=this.widthWithoutConnector;var i=this.spans.pop();i&&i!==this.connectorSpan&&this.spans.push(i)}}setConnectorWidth(t){this.connectorWidth=t,this.connectorSpan.properties.textLength=t,this.needsConnector&&(this.bounds.width=this.widthWithoutConnector+this.getConnectorWidth())}getConnectorWidth(){return this.connectorWidth||this.defaultConnectorWidth}generateSpansFromText(t,e){super.generateSpansFromText(t,e)}getLeft(){return this.notation.bounds.x+this.bounds.x}getRight(t){return this.notation.bounds.x+this.bounds.x+this.bounds.width}recalculateMetrics(t,e=!0){e&&(delete this.maxWidth,delete this.firstLineMaxWidth,delete this.rightAligned,delete this.resize,this.spans.forEach(t=>{delete t.properties.xOffset,t.properties.newLine&&(delete t.properties.newLine,t.text=" "+t.text)})),super.recalculateMetrics(t),this.widthWithoutConnector=this.bounds.width,this.connectorWidth=0,this.defaultConnectorWidth=t.hyphenWidth,this.setNeedsConnector();var i,s,n=this.language||t.defaultLanguage,o=this.widthWithoutConnector/2;if(this.centerStartIndex>=0&&(this.centerStartIndex>=this.text.length||this.centerLength<0||this.centerStartIndex+this.centerLength>this.text.length)&&(this.centerStartIndex=-1),0===this.text.length)this.dropCap&&this.originalText&&(o=t.hyphenWidth/2);else if(this.centerStartIndex>=0)t.textMeasuringStrategy===u.Svg?(i=t.svgTextMeasurer.firstChild.getSubStringLength(0,this.centerStartIndex),s=t.svgTextMeasurer.firstChild.getSubStringLength(0,this.centerStartIndex+this.centerLength)):t.textMeasuringStrategy===u.Canvas&&(i=this.measureSubstring(t,this.centerStartIndex),s=this.measureSubstring(t,this.centerStartIndex+this.centerLength)),o=i+(s-i)/2;else if(this.lyricType!==m.Directive){var a=this.text.lastIndexOf(" ")+1;a>0&&!this.text.slice(a).match(/[a-záéíóúýäëïöüÿàèìòùỳāēīōūȳăĕĭŏŭ]/i)&&(a=0);var r=n.findVowelSegment(this.text,a);if(!0!==r.found){var h=this.text.slice(a).match(/[a-z]+/i);h?(r.startIndex=a+h.index,r.length=h[0].length):(r.startIndex=a,r.length=this.text.length-a)}t.textMeasuringStrategy===u.Svg?(i=t.svgTextMeasurer.firstChild.getSubStringLength(0,r.startIndex),s=t.svgTextMeasurer.firstChild.getSubStringLength(0,r.startIndex+r.length)):t.textMeasuringStrategy===u.Canvas&&(i=this.measureSubstring(t,r.startIndex),s=this.measureSubstring(t,r.startIndex+r.length)),o=i+(s-i)/2}this.bounds.x=-o,this.bounds.y=0,this.origin.x=o}generateDropCap(t){if(this.dropCap)return this.dropCap;var e=this.dropCap=new v(t,this.originalText.substring(0,1),this.sourceIndex);return this.sourceIndex++,this.generateSpansFromText(t,this.originalText.substring(1)),this.centerStartIndex--,e}getCssClasses(){var t="lyric ";return this.lyricType===m.Directive&&(t+="directive "),t+super.getCssClasses()}getExtraStyleProperties(t){var e=super.getExtraStyleProperties();return this.lyricType===m.Directive&&!0===t.autoColor&&(e=Object.assign({},e,{fill:t.rubricColor})),e}createSvgNode(t){return super.createSvgNode(t)}createSvgFragment(t){return super.createSvgFragment(t)}}e.l=x;e.a=class extends p{constructor(t,e,i){super(t,(t.alTextStyle||"")+e,t.alTextFont,t.alTextSize,"start",i),this.padding=t.staffInterval/2}getCssClasses(){return"aboveLinesText "+super.getCssClasses()}};e.t=class extends p{constructor(t,e,i){var s="start";"/"===e?(e="",s="end"):e=(t.translationTextStyle||"")+e,super(t,e,t.translationTextFont,t.translationTextSize,s,i),this.padding=t.staffInterval/2}getCssClasses(){return"translation "+super.getCssClasses()}};class v extends p{constructor(t,e,i){super(t,e,(t.dropCapTextStyle||"")+t.dropCapTextFont,t.dropCapTextSize,"middle",i),this.padding=t.staffInterval*t.dropCapPadding}getCssClasses(){return"dropCap "+super.getCssClasses()}}e.i=v;class b extends p{constructor(t,e){super(t,(t.annotationTextStyle||"")+e,t.annotationTextFont,t.annotationTextSize,"middle"),this.padding=t.staffInterval*t.annotationPadding,this.dominantBaseline="hanging"}getCssClasses(){return"annotation "+super.getCssClasses()}}e.b=b;e.c=class extends l{constructor(t,...e){super(),this.annotations=e.map(function(e){return new b(t,e)}),this.padding=Math.max.apply(null,this.annotations.map(function(t){return t.padding}))}updateBounds(t){t||(t=1);for(var e=0;e<this.annotations.length;++e){var i=this.annotations[e];i.bounds.x+=this.bounds.x*t,i.bounds.y+=this.bounds.y*t}}recalculateMetrics(t){this.bounds.x=0,this.bounds.y=0,this.bounds.width=0,this.bounds.height=0,this.origin.x=0,this.origin.y=0;for(var e=0;e<this.annotations.length;++e){var i=this.annotations[e];i.recalculateMetrics(t),this.bounds.width=Math.max(this.bounds.width,i.bounds.width),i.bounds.y+=this.bounds.height,this.bounds.height+=i.bounds.height/1.2,this.origin.y=this.origin.y||i.origin.y}}draw(t){this.updateBounds(),this.annotations.forEach(function(e){e.draw(t)}),this.updateBounds(-1)}createSvgNode(t){this.updateBounds();var e=this.annotations.map(function(e){return e.createSvgNode(t)});return this.updateBounds(-1),e}createSvgFragment(t){this.updateBounds();var e=this.annotations.map(function(e){return e.createSvgFragment(t)}).join("");return this.updateBounds(-1),e}};e.f=class extends l{constructor(){super(),this.leadingSpace=0,this.trailingSpace=-1,this.keepWithNext=!1,this.needsLayout=!0,this.lyrics=[],this.score=null,this.line=null,this.visualizers=[]}hasLyrics(){return 0!==this.lyrics.length}getAllLyricsLeft(){if(0===this.lyrics.length)return this.bounds.right();for(var t=Number.MAX_VALUE,e=0;e<this.lyrics.length;e++)this.lyrics[e]&&(t=Math.min(t,this.lyrics[e].bounds.x));return this.bounds.x+t}getAllLyricsRight(){if(0===this.lyrics.length)return this.bounds.x;for(var t=Number.MIN_VALUE,e=0;e<this.lyrics.length;e++)this.lyrics[e]&&(t=Math.max(t,this.lyrics[e].bounds.x+this.lyrics[e].bounds.width));return this.bounds.x+t}addVisualizer(t){t.ignoreBounds||(this.bounds.isEmpty()?this.bounds=t.bounds.clone():this.bounds.union(t.bounds)),this.visualizers.push(t)}prependVisualizer(t){this.bounds.isEmpty()?this.bounds=t.bounds.clone():this.bounds.union(t.bounds),this.visualizers.unshift(t)}performLayout(t){this.trailingSpace<0&&(this.trailingSpace=t.intraNeumeSpacing*t.interSyllabicMultiplier),this.visualizers=[],this.bounds=new s.h(1/0,1/0,-1/0,-1/0);for(var e=0;e<this.lyrics.length;e++)this.lyrics[e].recalculateMetrics(t);if(this.alText)for(e=0;e<this.alText.length;e++)this.alText[e].recalculateMetrics(t);if(this.translationText)for(e=0;e<this.translationText.length;e++)this.translationText[e].recalculateMetrics(t)}resetDependencies(){}finishLayout(t){this.bounds.x=0;for(var e=0;e<this.lyrics.length;e++)this.lyrics[e].bounds.x=this.origin.x-this.lyrics[e].origin.x;this.needsLayout=!1}draw(t){var e=t.canvasCtxt;e.translate(this.bounds.x,0);for(var i=0;i<this.visualizers.length;i++)this.visualizers[i].draw(t);for(i=0;i<this.lyrics.length;i++)this.lyrics[i].draw(t);if(this.translationText)for(i=0;i<this.translationText.length;i++)this.translationText[i].draw(t);if(this.alText)for(i=0;i<this.alText.length;i++)this.alText[i].draw(t);e.translate(-this.bounds.x,0)}createSvgNode(t){for(var e=[],i=0;i<this.visualizers.length;i++)e.push(this.visualizers[i].createSvgNode(t,this));for(e.length&&(e=[h.createNode("g",{class:"Notations"},e)]),i=0;i<this.lyrics.length;i++)e.push(this.lyrics[i].createSvgNode(t));if(this.translationText)for(i=0;i<this.translationText.length;i++)e.push(this.translationText[i].createSvgNode(t));if(this.alText)for(i=0;i<this.alText.length;i++)e.push(this.alText[i].createSvgNode(t));return h.createNode("g",{source:this,class:"ChantNotationElement "+this.constructor.name,transform:"translate("+this.bounds.x+",0)"},e)}createSvgFragment(t){for(var e="",i=0;i<this.visualizers.length;i++)e+=this.visualizers[i].createSvgFragment(t,this);for(i=0;i<this.lyrics.length;i++)e+=this.lyrics[i].createSvgFragment(t);if(this.translationText)for(i=0;i<this.translationText.length;i++)e+=this.translationText[i].createSvgFragment(t);if(this.alText)for(i=0;i<this.alText.length;i++)e+=this.alText[i].createSvgFragment(t);return h.createFragment("g",{class:"ChantNotationElement "+this.constructor.name,transform:"translate("+this.bounds.x+",0)"},e)}}},function(t,e,i){"use strict";i.d(e,"h",function(){return r}),i.d(e,"j",function(){return h}),i.d(e,"k",function(){return u});var s=i(0),n=i(1),o=i(16),a=(i(5),i(3),i(6)),r={None:0,Large:1,Small:2,Ascending:4,Descending:8,InitioDebilis:16,LargeAscending:5,LargeDescending:9,SmallAscending:6,SmallDescending:10},h={Default:0,Virga:1,Inclinatum:2,Quilisma:3,Stropha:4,Oriscus:5},u={None:0,Ascending:1,Descending:2,Cavum:4,Stemmed:8};e.i=class extends n.e{constructor(t){super(),this.pitch=void 0!==t?t:null,this.glyphVisualizer=null,this.staffPosition=0,this.liquescent=r.None,this.shape=h.Default,this.shapeModifiers=u.None,this.neume=null,this.episemata=[],this.morae=[]}setGlyph(t,e){this.glyphVisualizer?this.glyphVisualizer.setGlyph(t,e):this.glyphVisualizer=new n.k(t,e),this.glyphVisualizer.setStaffPosition(t,this.staffPosition),this.bounds.x=this.glyphVisualizer.bounds.x,this.bounds.y=this.glyphVisualizer.bounds.y,this.bounds.width=this.glyphVisualizer.bounds.width,this.bounds.height=this.glyphVisualizer.bounds.height,this.origin.x=this.glyphVisualizer.origin.x,this.origin.y=this.glyphVisualizer.origin.y}shapeModifierMatches(t){return t===u.None?this.shapeModifier===u.None:this.shapeModifier&0!==t}draw(t){this.glyphVisualizer.bounds.x=this.bounds.x,this.glyphVisualizer.bounds.y=this.bounds.y,this.glyphVisualizer.draw(t)}createSvgNode(t){return this.glyphVisualizer.bounds.x=this.bounds.x,this.glyphVisualizer.bounds.y=this.bounds.y,this.svgNode=this.glyphVisualizer.createSvgNode(t,this),this.svgNode}createSvgFragment(t){return this.glyphVisualizer.bounds.x=this.bounds.x,this.glyphVisualizer.bounds.y=this.bounds.y,this.glyphVisualizer.createSvgFragment(t,this)}};class l extends n.f{constructor(t,e,i=null){super(),this.isClef=!0,this.staffPosition=t,this.octave=e,this.defaultAccidental=i,this.activeAccidental=i,this.keepWithNext=!0}resetAccidentals(){this.activeAccidental=this.defaultAccidental}pitchToStaffPosition(t){}performLayout(t){t.activeClef=this,this.defaultAccidental&&this.defaultAccidental.performLayout(t),super.performLayout(t)}finishLayout(t){if(this.defaultAccidental){var e=this.defaultAccidental.createGlyphVisualizer(t);e.bounds.x+=this.visualizers[0].bounds.right()+t.intraNeumeSpacing,this.addVisualizer(e)}super.finishLayout(t)}static default(){return d}}e.e=l;class c extends l{constructor(t,e,i=null){super(t,e,i),this.leadingSpace=0}pitchToStaffPosition(t){return 7*(t.octave-this.octave)+this.staffPosition+s.f.stepToStaffOffset(t.step)-s.f.stepToStaffOffset(s.j.Do)}staffPositionToPitch(t){var e=t-this.staffPosition,i=Math.floor(e/7),n=s.f.staffOffsetToStep(e);return this.activeAccidental&&this.activeAccidental.staffPosition===t&&(n+=this.activeAccidental.accidentalType),new s.f(n,this.octave+i)}performLayout(t){super.performLayout(t);var e=new n.k(t,n.j.DoClef);e.setStaffPosition(t,this.staffPosition),this.addVisualizer(e),this.finishLayout(t)}clone(){return new c(this.staffPosition,this.octave,this.defaultAccidental)}}e.f=c;var d=new c(1,2);class f extends l{constructor(t,e,i=null){super(t,e,i),this.octave=e,this.leadingSpace=0}pitchToStaffPosition(t){return 7*(t.octave-this.octave)+this.staffPosition+s.f.stepToStaffOffset(t.step)-s.f.stepToStaffOffset(s.j.Fa)}staffPositionToPitch(t){var e=t-this.staffPosition+3,i=Math.floor(e/7),n=s.f.staffOffsetToStep(e);return this.activeAccidental&&this.activeAccidental.staffPosition===t&&(n+=this.activeAccidental.accidentalType),new s.f(n,this.octave+i)}performLayout(t){super.performLayout(t);var e=new n.k(t,n.j.FaClef);e.setStaffPosition(t,this.staffPosition),this.addVisualizer(e),this.finishLayout(t)}clone(){return new f(this.staffPosition,this.octave,this.defaultAccidental)}}e.g=f;e.l=class extends n.f{constructor(){super(),this.trailingSpace=0}performLayout(t){super.performLayout(t),this.addVisualizer(new n.k(t,n.j.None)),this.origin.x=0,this.origin.y=0,this.finishLayout(t)}};class g extends n.f{constructor(t){super(),this.justify=t}performLayout(t){this.bounds=new s.h(0,0,0,0)}clone(){var t=new g;return t.justify=this.justify,t}}e.b=g;e.c=class{constructor(t,e,i){this.source=t,this.notations=e,this.sourceIndex=i}};class p{constructor(t,e=[],i){this.mappings=e,this.lines=[],this.notes=[],this.startingClef=null,this.useDropCap=i,this.dropCap=null,this.annotation=null,this.compiled=!1,this.autoColoring=!0,this.needsLayout=!0,this.bounds=new s.h,this.updateNotations(t)}updateNotations(t){var e,i,s,n;for(this.notations=[],e=0;e<this.mappings.length;e++)for(s=this.mappings[e],i=0;i<s.notations.length;i++)(n=s.notations[i]).score=this,n.mapping=s,this.notations.push(n);this.startingClef=null;var o=new c(1,2);for(e=0;e<this.notations.length;e++){if(this.notations[e].isNeume){this.startingClef=o;break}if(this.notations[e].isClef){this.startingClef=this.notations[e],this.notations.splice(e,1);break}}this.startingClef||(this.startingClef=o),this.useDropCap&&this.recreateDropCap(t),this.needsLayout=!0}recreateDropCap(t){for(var e=0;e<this.notations.length;e++)if(this.notations[e].hasLyrics()&&null!==this.notations[e].lyrics[0])return void(this.dropCap=this.notations[e].lyrics[0].generateDropCap(t))}performLayout(t){if(!1!==this.needsLayout){t.updateHyphenWidth(),t.activeClef=this.startingClef,t.notations=this.notations,t.currNotationIndex=0,this.dropCap&&this.dropCap.recalculateMetrics(t),this.annotation&&this.annotation.recalculateMetrics(t);for(var e=0;e<this.notations.length;e++){var i=this.notations[e];i.needsLayout&&(t.currNotationIndex=e,i.performLayout(t))}this.needsLayout=!1}}performLayoutAsync(t,e){!1!==this.needsLayout?(t.updateHyphenWidth(),t.hyphenWidth/t.lyricTextSize>.6?setTimeout(()=>{this.performLayoutAsync(t,e)},100):(t.activeClef=this.startingClef,t.notations=this.notations,t.currNotationIndex=0,this.dropCap&&this.dropCap.recalculateMetrics(t),this.annotation&&this.annotation.recalculateMetrics(t),setTimeout(()=>this.layoutElementsAsync(t,0,e),0))):e&&setTimeout(()=>e(),0)}layoutElementsAsync(t,e,i){if(e>=this.notations.length)return this.needsLayout=!1,void(i&&setTimeout(()=>i(),0));0===e&&(t.activeClef=this.startingClef);var s=(new Date).getTime()+50;do{var n=this.notations[e];n.needsLayout&&(t.currNotationIndex=e,n.performLayout(t)),e++}while(e<this.notations.length&&(new Date).getTime()<s);setTimeout(()=>this.layoutElementsAsync(t,e,i),0)}layoutChantLines(t,e,i){this.lines=[];var s=0,n=0;t.activeClef=this.startingClef;do{var a=new o.a(this);a.buildFromChantNotationIndex(t,n,e),n=a.notationsStartIndex+a.numNotationsOnLine,a.performLayout(t),this.lines.push(a),a.bounds.y=-a.bounds.y+s,s+=a.bounds.height+1.5*t.staffInterval}while(n<this.notations.length);var r=this.lines[this.lines.length-1];this.bounds.x=0,this.bounds.y=0,this.bounds.width=r.bounds.width,this.bounds.height=s,i&&i(this)}draw(t,e=1){var i=t.canvasCtxt;i.clearRect(0,0,t.canvas.width,t.canvas.height),t.setCanvasSize(this.bounds.width,this.bounds.height,e),i.translate(this.bounds.x,this.bounds.y);for(var s=0;s<this.lines.length;s++)this.lines[s].draw(t);i.translate(-this.bounds.x,-this.bounds.y)}createSvgNode(t){var e=[t.defsNode.cloneNode(!0)];e[0].appendChild(t.createStyleNode());for(var i=0;i<this.lines.length;i++)e.push(this.lines[i].createSvgNode(t));return e=n.p.createNode("g",{},e),(e=n.p.createNode("svg",{xmlns:"http://www.w3.org/2000/svg",version:"1.1",class:"ChantScore",width:this.bounds.width,height:this.bounds.height,viewBox:[0,0,this.bounds.width,this.bounds.height].join(" ")},e)).source=this,this.svg=e,e}createSvg(t){var e="";for(var i in t.defs)t.defs.hasOwnProperty(i)&&(e+=t.defs[i]);e+=t.createStyle(),e=n.p.createFragment("defs",{},e);for(var s=0;s<this.lines.length;s++)e+=this.lines[s].createSvgFragment(t);return e=n.p.createFragment("g",{},e),e=n.p.createFragment("svg",{xmlns:"http://www.w3.org/2000/svg",version:"1.1","xmlns:xlink":"http://www.w3.org/1999/xlink",class:"ChantScore",width:this.bounds.width,height:this.bounds.height},e)}createSvgNodeForEachLine(t){for(var e=[],i=0,s=0;s<this.lines.length;s++){var o=[t.defsNode.cloneNode(!0),this.lines[s].createSvgNode(t,i)];o[0].appendChild(t.createStyleNode());var a=this.lines[s].bounds.height+1.5*t.staffInterval;o=n.p.createNode("g",{},o),o=n.p.createNode("svg",{xmlns:"http://www.w3.org/2000/svg",version:"1.1",class:"ChantScore",width:this.bounds.width,height:a,viewBox:[0,0,this.bounds.width,a].join(" ")},o),e.push(o),i+=a}return e}createSvgForEachLine(t){var e="",i="";for(var s in t.defs)t.defs.hasOwnProperty(s)&&(i+=t.defs[s]);i+=t.createStyle(),i=n.p.createFragment("defs",{},i);for(var o=0,a=0;a<this.lines.length;a++){var r=i+this.lines[a].createSvgFragment(t,o),h=this.lines[a].bounds.height+1.5*t.staffInterval;r=n.p.createFragment("g",{},r),e+=r=n.p.createFragment("svg",{xmlns:"http://www.w3.org/2000/svg",version:"1.1","xmlns:xlink":"http://www.w3.org/1999/xlink",class:"ChantScore",width:this.bounds.width,height:h},r),o+=h}return e}unserializeFromJson(t){this.autoColoring=t["auto-coloring"],null!==t.annotation&&""!==t.annotation?this.annotation=new n.b(ctxt,t.annotation):this.annotation=null;var e="auto"===t["drop-cap"];a.a.parseChantNotations(t.notations,this,e)}serializeToJson(){var t={type:"score","auto-coloring":!0};return null!==this.annotation?t.annotation=this.annotation.unsanitizedText:t.annotation="",t}}e.d=p;e.a=class{constructor(){var t={layout:{units:"mm","default-font":{"font-family":"Crimson","font-size":14},page:{width:8.5,height:11,"margin-left":0,"margin-top":0,"margin-right":0,"margin-bottom":0}},scores:[]};this.copyLayout(this,t),this.scores=t.scores}copyLayout(t,e){t.layout={units:e.layout.units,"default-font":{"font-family":e.layout["default-font"]["font-family"],"font-size":e.layout["default-font"]["font-size"]},page:{width:e.layout.page.width,height:e.layout.page.height,"margin-left":e.layout.page["margin-left"],"margin-top":e.layout.page["margin-top"],"margin-right":e.layout.page["margin-right"],"margin-bottom":e.layout.page["margin-bottom"]}}}unserializeFromJson(t){this.copyLayout(this,t),this.scores=[];for(var e=0;e<t.scores.length;e++){var i=new p;i.unserializeFromJson(t.scores[e]),this.scores.push(i)}}serializeToJson(){var t={};this.copyLayout(t,this),t.scores=[];for(var e=0;e<this.scores.length;e++)t.scores.push(this.scores[e].serializeToJson());return t}}},function(t,e,i){"use strict";i.d(e,"h",function(){return o}),i.d(e,"f",function(){return a}),i.d(e,"d",function(){return r}),i.d(e,"b",function(){return h});i(0);var s=i(1),n=i(2),o={Default:0,Above:1,Below:2};e.a=class extends s.k{constructor(t,e){super(t,s.j.AcuteAccent),this.note=e,this.positionHint=o.Above}performLayout(t){this.bounds.x+=this.bounds.width/2,this.setStaffPosition(t,Math.max(this.note.staffPosition+1,4))}};var a={Default:0,Left:1,Center:2,Right:3};e.e=class extends s.e{constructor(t){super(),this.note=t,this.positionHint=o.Default,this.terminating=!1,this.alignment=a.Default}performLayout(t){var e,i=0,n=.25*t.staffInterval,r=this.note.glyphVisualizer.glyphCode,h=this.note.neume.ledgerLines[0]||{},u=!1;if(r===s.j.PunctumInclinatum){let t=this.note.neume.notes,e=t[t.indexOf(this.note)-1];e&&e.glyphVisualizer.glyphCode===s.j.PunctumInclinatum&&e.staffPosition-this.note.staffPosition==1&&(u=!0)}this.positionHint===o.Below?(i=this.note.bounds.bottom()+n,r===s.j.None&&(i+=t.staffInterval/2),(e=Math.ceil(i/t.staffInterval))%2==0?e=(e+.75+(i-n)/t.staffInterval)/2:(e=(2*Math.ceil(1.5*i/t.staffInterval-.5)+1)/3,Math.abs(e)%2==1&&(Math.abs(e)<4||h.staffPosition===-e?e+=2/3:e+=1/3))):(i=this.note.bounds.y-n,(e=Math.floor(i/t.staffInterval))%2==0?e=(e-.75+(i+n)/t.staffInterval)/2:(e=(2*Math.floor(1.5*i/t.staffInterval-.5)+1)/3,Math.abs(e)%2==1&&(Math.abs(e)<4||h.staffPosition===-e?e-=2/3:e-=1/3))),i=e*t.staffInterval;var l=this.note.bounds.width,c=this.note.bounds.x;r===s.j.Porrectus1||r===s.j.Porrectus2||r===s.j.Porrectus3||r===s.j.Porrectus4?l=t.staffInterval:r===s.j.None?c-=l=t.staffInterval:u?c+=.5*(l*=2/3):r===s.j.PunctumInclinatumLiquescent&&(c+=.25*(l*=2/3)),this.alignment===a.Left?l*=.8:this.alignment===a.Center?(c+=.1*l,l*=.8):this.alignment===a.Right&&(c+=.2*l,l*=.8),this.bounds.x=c,this.bounds.y=i-t.episemaLineWeight/2,this.bounds.width=l,this.bounds.height=t.episemaLineWeight,this.origin.x=0,this.origin.y=0}draw(t){var e=t.canvasCtxt;e.fillStyle=t.neumeLineColor,e.fillRect(this.bounds.x,this.bounds.y,this.bounds.width,this.bounds.height)}createSvgNode(t){return s.p.createNode("rect",{x:this.bounds.x,y:this.bounds.y,width:this.bounds.width,height:this.bounds.height,fill:t.neumeLineColor,class:"horizontalEpisema"})}createSvgFragment(t){return s.p.createFragment("rect",{x:this.bounds.x,y:this.bounds.y,width:this.bounds.width,height:this.bounds.height,fill:t.neumeLineColor,class:"horizontalEpisema"})}};e.g=class extends s.k{constructor(t,e){super(t,s.j.VerticalEpisemaAbove),this.note=e,this.positionHint=o.Default}performLayout(t){var e,i=this.note.glyphVisualizer.glyphCode,n=this.positionHint||o.Below,a=this.note.staffPosition+(n===o.Above?1:-1),r=this.note.episemata.length>0&&(this.note.episemata[0].positionHint||o.Above)===n,h=1,u=0,l=a%2&&(Math.abs(a)<4||(this.note.neume.ledgerLines[0]||{}).staffPosition===a);i===s.j.Porrectus1||i===s.j.Porrectus2||i===s.j.Porrectus3||i===s.j.Porrectus4?e=t.staffInterval/2:i===s.j.None?e=-t.staffInterval/2:(e=this.note.bounds.width/2,i!==s.j.PunctumInclinatum||l||r||(u=.3)),this.positionHint===o.Above?(i=s.j.VerticalEpisemaAbove,h*=-1):i=s.j.VerticalEpisemaBelow,r&&(u=.4),h*=t.staffInterval*(u+(l?.3:-.2)),this.setGlyph(t,i),this.setStaffPosition(t,a),this.bounds.x=this.note.bounds.x+e-this.origin.x,this.bounds.y+=h}};e.i=class extends s.k{constructor(t,e){super(t,s.j.Mora),this.note=e,this.positionHint=o.Default,this.horizontalOffset=t.staffInterval/2+this.origin.x}performLayout(t){var e=this.note.staffPosition;this.setStaffPosition(t,e);var i=0;if(this.horizontalOffset===t.staffInterval/2+this.origin.x){var s,a=this.note.neume.notes.indexOf(this.note);if(a>=0)if(++a,this.note.neume.notes.length>a)(s=this.note.neume.notes[a]).bounds.right()>this.note.bounds.right()?this.horizontalOffset=(s.bounds.right()-this.note.bounds.right()-this.bounds.right())/2:s=null;else if(this.note.neume.notes.length===a)if(0===this.note.neume.trailingSpace){var r=this.note.neume.score.notations.indexOf(this.note.neume);if(r>=0){var h=this.note.neume.score.notations[r+1];h&&h.notes&&(s=h.notes[0])}}else this.note.shape!==n.j.Inclinatum&&(this.note.neume.trailingSpace+=this.origin.x)}this.positionHint===o.Above?i-=e%2==0?1.75*t.staffInterval:.75*t.staffInterval:this.positionHint===o.Below?i+=e%2==0?1.75*t.staffInterval:.75*t.staffInterval:e%2==0?s&&s.staffPosition===e-1&&(i-=.25*t.staffInterval):i-=.75*t.staffInterval,this.bounds.x+=this.horizontalOffset+this.note.bounds.right(),this.bounds.y+=i}};var r={RoundBrace:0,CurlyBrace:1,AccentedCurlyBrace:2},h={Left:0,Right:1};e.c=class extends s.e{constructor(t,e,i,s){super(),this.note=t,this.isAbove=e,this.shape=i,this.attachment=s}getAttachmentX(t){return t||(t=this.note),this.attachment===h.Left?(t.neume?t.neume.bounds.x:0)+t.bounds.x:(t.neume?t.neume.bounds.x:0)+t.bounds.right()}}},function(t,e,i){"use strict";i.d(e,"a",function(){return s});let s={None:{paths:[{type:"positive",data:""}],bounds:{x:0,y:0,width:0,height:0},origin:{x:0,y:0},align:"left"},AcuteAccent:{paths:[{type:"positive",data:"M4 0C-.614.52-.614.52-.803-3.182l60.768-108.422c4.52-7.182 10.543-13.67 18.075-13.67 5.27 0 14.31 1.264 23.346 7.793 7.53 5.223 8.803 11.752 8.803 16.975 0 3.917-.52 11.1-8.05 17.628L4 0z"}],bounds:{x:0,y:0,width:110.992,height:125.794},origin:{x:.803,y:125.274},align:"left"},Stropha:{paths:[{type:"positive",data:"M1.22-73.438c4.165 13.02 12.238 27.084 24.217 42.188L49.657 0 34.812 27.344C18.666 55.47-.084 72.396-21.438 78.124c4.687-3.645 7.03-8.593 7.03-14.843 0-8.853-4.947-20.572-14.843-35.155L-48 0 1.22-73.438z"}],bounds:{x:0,y:0,width:97.657,height:151.562},origin:{x:48,y:73.438},align:"left"},BeginningAscLiquescent:{paths:[{type:"positive",data:"M-50 43.688V-61c4.167 7.292 12.76 10.938 25.78 10.938 9.376 0 20.053-1.563 32.032-4.688C31.773-60.48 45.833-71.677 50-88.344v117.97C43.75 42.645 32.812 51.5 17.187 56.186-.52 61.398-15.886 64-28.906 64-42.97 64-50 57.23-50 43.687z"}],bounds:{x:0,y:0,width:100,height:152.344},origin:{x:50,y:88.344},align:"left"},BeginningDesLiquescent:{paths:[{type:"positive",data:"M-50-56.03c0-13.022 7.03-19.532 21.094-19.532 13.02 0 28.385 2.604 46.093 7.812C32.813-63.583 43.75-54.73 50-41.187V76C45.833 59.854 31.77 48.656 7.812 42.406c-11.98-3.125-22.656-4.687-32.03-4.687-13.022 0-21.615 3.905-25.782 11.718v-105.47z"}],bounds:{x:0,y:0,width:100,height:151.562},origin:{x:50,y:75.562},align:"left"},CustosDescLong:{paths:[{type:"positive",data:"M39.063 273.472c5.73.52 7.29-6.25 4.687-20.312V-65.59c-13.542 2.083-24.22 5.468-32.03 10.156C3.905-50.226 0-43.714 0-35.904V71.91c5.73-5.21 10.677-8.594 14.844-10.157 5.73-1.562 12.24-2.343 19.53-2.343v196.875c0 11.458 1.563 17.187 4.688 17.187"}],bounds:{x:0,y:0,width:46.353,height:339.582},origin:{x:0,y:65.59},align:"left"},CustosDescShort:{paths:[{type:"positive",data:"M34.375 191.923c0 8.333 1.563 12.24 4.688 11.72 3.125-.522 4.687-7.033 4.687-19.533v-250c-13.542 2.084-24.22 5.47-32.03 10.157C3.905-50.525 0-44.015 0-36.203V71.61c5.73-5.208 10.677-8.593 14.844-10.156 5.73-1.562 12.24-2.344 19.53-2.344v132.813z"}],bounds:{x:0,y:0,width:43.75,height:270.053},origin:{x:0,y:65.89},align:"left"},CustosLong:{paths:[{type:"positive",data:"M39.063-269.562c5.73-.52 7.29 6.25 4.687 20.312V69.5c-13.542-2.083-24.22-5.47-32.03-10.156C3.905 54.134 0 47.624 0 39.812V-68c5.73 5.208 10.677 8.594 14.844 10.156 5.73 1.563 12.24 2.344 19.53 2.344v-196.875c0-11.458 1.563-17.187 4.688-17.187z"}],bounds:{x:0,y:0,width:46.353,height:339.582},origin:{x:0,y:270.082},align:"left"},CustosShort:{paths:[{type:"positive",data:"M34.375-188.125c0-8.333 1.563-12.24 4.688-11.72 3.125.522 4.687 7.033 4.687 19.532v250c-13.542-2.083-24.22-5.468-32.03-10.156C3.905 54.324 0 47.813 0 40V-67.813c5.73 5.21 10.677 8.594 14.844 10.157 5.73 1.562 12.24 2.344 19.53 2.343v-132.812z"}],bounds:{x:0,y:0,width:43.75,height:270.052},origin:{x:0,y:200.365},align:"left"},DoClef:{paths:[{type:"positive",data:"M0 98.406V-97.688C0-118 5.99-134.275 17.97-146.516c11.978-12.24 27.603-18.36 46.874-18.36 10.937 0 19.53 3.126 25.78 9.376s9.376 14.583 9.376 25v107.813l-6.25-5.47c-4.167-3.645-10.287-7.42-18.36-11.327-8.072-3.907-16.796-5.86-26.17-5.86-11.46 0-21.486 4.427-30.08 13.282-8.593 8.854-12.89 19.53-12.89 32.03s4.297 23.308 12.89 32.423c8.594 9.115 18.62 13.672 30.08 13.672 9.374 0 18.098-1.822 26.17-5.468 8.073-3.646 14.193-7.292 18.36-10.938l6.25-6.25V132c0 9.896-3.125 18.1-9.375 24.61-6.25 6.51-14.844 9.765-25.78 9.765-19.272 0-34.897-6.25-46.876-18.75C5.99 135.125 0 118.72 0 98.405z"}],bounds:{x:0,y:0,width:100,height:331.251},origin:{x:0,y:164.876},align:"left"},FaClef:{paths:[{type:"positive",data:"M85.156-32v193.75c0 9.375-1.562 14.323-4.687 14.844-1.564 0-2.605-.52-3.126-1.563-.52-1.04-.782-2.603-.78-4.686V56.28c-8.335-8.332-19.793-12.5-34.376-12.5-17.71 0-31.77 3.907-42.188 11.72V-32c0-18.23 14.193-27.344 42.578-27.344 28.385 0 42.578 9.115 42.578 27.344zM98.438 93V-92.156c0-19.27 5.73-34.896 17.187-46.875 11.458-11.98 26.562-17.97 45.313-17.97 10.937 0 19.14 2.865 24.61 8.594 5.467 5.73 8.202 13.542 8.202 23.437v103.126l-5.47-4.687c-3.645-3.647-9.374-7.293-17.186-10.94-7.813-3.645-15.886-5.467-24.22-5.468-11.978 0-22.004 4.167-30.077 12.5-8.073 8.334-12.11 18.36-12.11 30.08 0 11.717 4.037 22.004 12.11 30.858s18.1 13.28 30.078 13.28c8.333 0 16.406-1.822 24.22-5.468 7.81-3.645 13.54-7.03 17.186-10.156l5.47-5.468V125.81c0 9.896-2.865 17.84-8.594 23.83-5.73 5.988-13.802 8.983-24.22 8.983-18.75 0-33.853-6.12-45.31-18.36-11.46-12.24-17.19-27.994-17.19-47.265z"}],bounds:{x:0,y:0,width:193.752,height:333.595},origin:{x:.001,y:157.001},align:"left"},Flat:{paths:[{type:"positive",data:"M7.813-204.406c4.166 0 6.25 5.208 6.25 15.625L12.5-10.657C33.854 13.302 54.167 25.28 73.438 25.28c9.374 0 14.062-4.686 14.062-14.06 0-6.25-1.042-11.72-3.125-16.407-2.083-4.688-7.03-9.766-14.844-15.235-7.81-5.47-13.02-8.984-15.624-10.547L27.344-45.81V-80.97c17.187 0 33.073 4.82 47.656 14.454C89.583-56.88 96.875-47.376 96.875-38c0 67.708-.26 101.562-.78 101.563-38.543 0-69.532-12.24-92.97-36.72C0-52.322-1.042-123.936 0-188c0-10.937 2.604-16.406 7.813-16.406z"}],bounds:{x:0,y:0,width:97.917,height:267.969},origin:{x:1.042,y:204.406},align:"left"},Mora:{paths:[{type:"positive",data:"M47.478-24c6.957 0 12.793 2.288 17.49 6.883C69.662-12.52 72-6.904 72-.267c0 6.64-2.337 12.352-7.033 17.118C60.27 21.618 54.435 24 47.477 24c-6.26 0-11.748-2.383-16.444-7.15C26.337 12.086 24 6.374 24-.265c0-6.638 2.337-12.255 7.033-16.85C35.73-21.713 41.217-24 47.478-24z"}],bounds:{x:0,y:0,width:48,height:48},origin:{x:-24,y:24},align:"left"},Natural:{paths:[{type:"positive",data:"M7.906-166.563c-2.864 0-5.614.52-8.218 1.563v13.28l.78 56.25.782 78.907v85.157c.52 3.646 2.604 5.73 6.25 6.25l23.438-3.906 23.437-3.907v29.69c0 42.186-.26 63.54-.78 64.06l6.25 2.345c1.04.52 2.082.78 3.124.78 2.603 0 4.947-1.3 7.03-3.905L67.656-71.25c-.52-2.604-2.083-3.906-4.687-3.906-7.814 0-17.19 1.04-28.126 3.125l-19.53 3.124.78-38.28V-165c-2.604-1.042-5.323-1.562-8.188-1.563zM55.938-40v71.875l-41.407 7.03c0-48.436.262-72.655.783-72.655L55.938-40z"}],bounds:{x:0,y:0,width:70.311,height:330.469},origin:{x:.312,y:166.563},align:"left"},Sharp:{paths:[{type:"positive",data:"m41.725,-73.773c-5.421,-0.241-10.878,5.856-6.549,12.357L67.061,-20.473 61.264,-12.5 13.436,-71.199c-5.634,-5.934-16.988,1.032-11.232,9.783L50.756,0.182 2.203,61.416c-6.745,7.984 3.442,17.859 11.232,9.783L61.264,12.5l5.797,7.973-31.885,40.943c-5.578,6.844 5.588,16.005 11.594,9.783L77.568,33.154 108.367,71.199c4.894,6.717 17.343,-1.575 11.232,-9.783L87.715,20.473 93.873,12.5 141.34,71.199c6.725,7.67 17.509,-2.248 11.596,-9.783L104.02,0.182 152.936,-61.416c5.52,-7.02-5.541,-16.309-11.596,-9.783L93.873,-12.5l-6.158,-7.973 31.884766,-40.943c5.407,-7.045-5.505,-15.924-11.232,-9.783L77.568,-33.154 46.77,-71.199c-1.435,-1.708-3.238,-2.494-5.044922,-2.574zM77.568,-8.516 84.09,0.182 77.568,8.516 70.684,0.182Z"}],bounds:{x:0,y:0,width:154.646,height:147.987},origin:{x:0,y:74.098},align:"left"},OriscusAsc:{paths:[{type:"positive",data:"M50 30.25c0 12.5-3.125 21.354-9.375 26.562-3.125 2.605-7.813 3.907-14.063 3.907-3.125 0-5.99-.522-8.593-1.564-2.605-1.04-5.6-2.474-8.986-4.297C5.6 53.035 2.734 51.603.39 50.56c-2.343-1.04-5.338-2.474-8.984-4.296-3.646-1.823-6.77-3.256-9.375-4.297-2.603-1.043-5.468-1.564-8.593-1.564-6.25 0-10.937 1.563-14.062 4.688C-46.875 50.824-50 59.677-50 71.656v-106.25c0-13.02 3.125-21.875 9.375-26.562 3.125-2.604 7.813-3.906 14.063-3.907 3.125 0 5.99.52 8.593 1.563 2.605 1.042 5.73 2.474 9.376 4.297 3.646 1.823 6.51 2.995 8.594 3.516l10.938 5.468c6.25 3.126 11.458 4.69 15.624 4.69 6.25 0 10.938-1.564 14.063-4.69C46.875-55.426 50-64.02 50-76V30.25z"}],bounds:{x:0,y:0,width:100,height:147.656},origin:{x:50,y:76},align:"left"},OriscusDes:{paths:[{type:"positive",data:"M-50 30.844v-106.25c0 11.458 3.125 20.052 9.375 25.78 3.125 3.126 7.813 4.69 14.063 4.688 4.687 0 13.41-3.255 26.17-9.765 12.762-6.51 21.746-9.766 26.954-9.766 6.25 0 10.938 1.303 14.063 3.907C46.875-55.874 50-47.02 50-34V72.25c0-11.98-3.125-20.833-9.375-26.563C37.5 42.563 32.812 41 26.562 41 21.875 41 13.023 44.385 0 51.156c-4.167 2.604-8.594 4.948-13.28 7.032-4.69 2.083-9.116 3.124-13.283 3.124-6.25 0-10.937-1.302-14.062-3.906C-46.875 52.198-50 43.344-50 30.844z"}],bounds:{x:0,y:0,width:100,height:147.656},origin:{x:50,y:75.406},align:"left"},OriscusLiquescent:{paths:[{type:"positive",data:"M 19.055,78.887 C 20.242,78.487 21.532,77.890 22.925,77.097 24.318,76.304 26.700882,74.417 30.074,71.438 33.447,68.458 36.524,64.985 39.303,61.019 42.083,57.052 44.563,51.396 46.743,44.05 48.923,36.704 50.013,28.671 50.013,19.950525 L 50.013,-34.226 C 50.013,-54.464 42.074,-64.584 26.195,-64.584 20.248,-64.584 11.519,-61.410 0.007,-55.064 -11.506,-48.717 -20.235,-45.544 -26.182,-45.544 -34.515,-45.544 -40.568,-48.520 -44.340791,-54.473 -48.114,-60.426 -50.000,-67.369 -50.000,-75.303 L -50.000,30.07 C -50.000,49.909 -42.060754,59.829 -26.182,59.829 -21.023,59.829 -12.39,56.455 -0.284,49.709 11.822,42.963 20.648,39.59 26.195,39.59 29.369,40.777 30.362,44.25 29.17479,50.009 27.988,55.768 26.001,62.020829 23.216,68.767 z"}],bounds:{x:0,y:0,width:100,height:147.656},origin:{x:50,y:75.406},align:"left"},PodatusLower:{paths:[{type:"positive",data:"M-4.688-30.28c22.396 0 34.636-.262 36.72-.782 5.728-1.563 8.593-5.21 8.593-10.938H50v97.656c0 2.604-1.302 4.167-3.906 4.688-5.21.52-21.355.78-48.438.78-23.958 0-38.54-.26-43.75-.78-2.604 0-3.906-1.302-3.906-3.906v-82.032c0-3.646 1.302-5.468 3.906-5.468h2.344c2.604.52 15.625.78 39.063.78z"}],bounds:{x:0,y:0,width:100,height:103.124},origin:{x:50,y:42},align:"left"},PodatusUpper:{paths:[{type:"positive",data:"M-46.094-63.78c13.542 0 24.61 2.473 33.203 7.42C-4.298-51.41 0-43.99 0-34.093V62h-9.375c0-10.938-2.604-19.14-7.812-24.61-5.21-5.468-14.844-8.203-28.907-8.202-18.23 0-33.333 4.166-45.312 12.5v-75.782c0-19.79 15.104-29.687 45.312-29.687z"}],bounds:{x:0,y:0,width:91.406,height:125.781},origin:{x:91.406,y:63.781},align:"right"},Porrectus1:{paths:[{type:"positive",data:"M233.594 162.875c-58.855 0-107.032-6.25-144.53-18.75C34.895 125.895-11.46 99.855-50 66V-52.75C-21.354-24.625 26.302 6.885 92.97 41.78 123.697 57.928 163.54 66 212.5 66c21.354 0 34.635-9.896 39.844-29.688V151.94c0 7.29-6.25 10.937-18.75 10.937z"}],bounds:{x:0,y:0,width:302.344,height:215.627},origin:{x:50,y:52.75},align:"left"},Porrectus2:{paths:[{type:"positive",data:"M309.375 259.375c-50.52 0-110.938-22.396-181.25-67.188C48.437 141.667-10.938 94.272-50 50V-68.75C0-3.125 60.417 52.083 131.25 96.875c58.333 36.98 110.677 58.854 157.03 65.625h7.033c16.145 0 26.822-9.896 32.03-29.688v114.844c0 7.812-5.99 11.72-17.968 11.72z"}],bounds:{x:0,y:0,width:377.343,height:328.126},origin:{x:50,y:68.75},align:"left"},Porrectus3:{paths:[{type:"positive",data:"M309.375 355.78c-48.96-16.666-109.115-55.468-180.47-116.405C79.428 198.23 19.793 134.687-50 48.75V-70C20 40 94.104 103.79 135.25 148.063 190 200 230 230 288.28 258.906c4.168 2.083 8.334 3.125 12.5 3.125 12.5 0 21.355-10.937 26.564-32.81v114.06c0 9.376-3.386 14.063-10.156 14.064-2.084 0-4.688-.522-7.813-1.563z"}],bounds:{x:0,y:0,width:377.344,height:427.345},origin:{x:50,y:70},align:"left"},Porrectus4:{paths:[{type:"positive",data:"M350 453.438c-52.754-22.397-120-77.345-201.74-164.844C90.87 227.656 24.784 147.708-50 48.75V-70C-8.84-1.25 58.406 86.51 151.74 193.28c60.868 69.793 119.13 124.22 174.782 163.282 5.797 3.646 11.014 5.47 15.652 5.47 12.173 0 21.45-11.72 27.826-35.157V441.72c0 9.373-3.19 14.06-9.565 14.06-2.9 0-6.377-.78-10.435-2.342z"}],bounds:{x:0,y:0,width:420,height:525.78},origin:{x:50,y:70},align:"left"},PunctumCavum:{paths:[{type:"positive",data:"M0-60.906c33.333 0 50 9.635 50 28.906v94.53C39.062 51.595 22.396 46.126 0 46.126s-39.063 5.47-50 16.406V-32c0-19.27 16.667-28.906 50-28.906z"},{type:"negative",data:"M.08-42.56c9.585.206 20.126.53 27.954 6.822 4.96 3.9 4.71 10.792 4.574 16.482v51.278C22.09 27.066 7.283 26.072.168 26.01c-7.72.23-21.895.935-32.616 4.674.04-19.197-.083-38.395.064-57.59.567-7.5 7.834-12.33 14.62-13.774 5.818-1.498 11.857-1.86 17.844-1.88z"}],bounds:{x:0,y:0,width:100,height:123.438},origin:{x:50,y:60.906},align:"left"},PunctumQuadratum:{paths:[{type:"positive",data:"M0-60.906c33.333 0 50 9.635 50 28.906v94.53C39.062 51.595 22.396 46.126 0 46.126s-39.063 5.47-50 16.406V-32c0-19.27 16.667-28.906 50-28.906z"}],bounds:{x:0,y:0,width:100,height:123.438},origin:{x:50,y:60.906},align:"left"},PunctumQuadratumAscLiquescent:{paths:[{type:"positive",data:"M-50 43.688V-61c4.167 7.292 12.76 10.938 25.78 10.938 9.376 0 20.053-1.563 32.032-4.688C31.773-60.48 45.833-71.677 50-88.344v117.97C43.75 42.645 32.812 51.5 17.187 56.186-.52 61.398-15.886 64-28.906 64-42.97 64-50 57.23-50 43.687z"}],bounds:{x:0,y:0,width:100,height:152.344},origin:{x:50,y:88.344},align:"left"},PunctumQuadratumDesLiquescent:{paths:[{type:"positive",data:"M-50-56.03c0-13.022 7.03-19.532 21.094-19.532 13.02 0 28.385 2.604 46.093 7.812C32.813-63.583 43.75-54.73 50-41.187V76C45.833 59.854 31.77 48.656 7.812 42.406c-11.98-3.125-22.656-4.687-32.03-4.687-13.022 0-21.615 3.905-25.782 11.718v-105.47z"}],bounds:{x:0,y:0,width:100,height:151.562},origin:{x:50,y:75.562},align:"left"},PunctumInclinatum:{paths:[{type:"positive",data:"M0-75.78L50 0 0 75-50 0 0-75.78z"}],bounds:{x:0,y:0,width:100,height:150.78},origin:{x:50,y:75.78},align:"left"},PunctumInclinatumLiquescent:{paths:[{type:"positive",data:"M 0,-53.164 35,-0.117 0,52.383 -35,-0.117 0,-53.164 z"}],bounds:{x:0,y:0,width:100,height:105.546},origin:{x:50,y:53.164},align:"left"},Quilisma:{paths:[{type:"positive",data:"M-50 34.938V-51c5.73 20.833 13.02 31.25 21.875 31.25 7.813 0 12.5-15.625 14.063-46.875 3.645 12.5 6.9 21.224 9.765 26.172s6.9 7.422 12.11 7.422c5.208 0 9.374-14.324 12.5-42.97 5.73 22.917 10.677 34.375 14.843 34.375 5.73 0 10.677-15.885 14.844-47.656v100c0 17.707-3.125 26.56-9.375 26.56-4.688 0-9.115-5.988-13.28-17.968-2.085 21.875-8.074 32.813-17.97 32.813-7.813 0-16.146-7.292-25-21.875-4.688 20.312-10.677 30.47-17.97 30.47-5.207 0-9.244-2.605-12.108-7.814C-48.568 47.698-50 41.708-50 34.938z"}],bounds:{x:0,y:0,width:100,height:150},origin:{x:50,y:89.282},align:"left"},TerminatingAscLiquescent:{paths:[{type:"positive",data:"M-9.375 40.22c0-11.98-4.948-17.97-14.844-17.97-10.936 0-19.53 3.646-25.78 10.938v-53.126c0-6.77 2.604-12.76 7.813-17.968 5.208-5.21 10.677-8.594 16.406-10.157 2.603-.52 5.207-.78 7.81-.78 3.647 0 7.032.78 10.157 2.343C-2.603-43.896 0-39.73 0-34V73.03h-9.375V40.22z"}],bounds:{x:0,y:0,width:49.999,height:121.873},origin:{x:49.999,y:48.843},align:"right"},TerminatingDesLiquescent:{paths:[{type:"positive",data:"M-9.375-48.156V-80.97H0V26.845c0 5.73-2.604 9.896-7.813 12.5-3.125 1.562-6.51 2.343-10.156 2.343-2.603 0-5.207-.26-7.81-.78-5.73-1.563-11.2-4.95-16.407-10.157C-47.398 25.542-50 19.292-50 12v-52.344c6.25 7.292 14.844 10.938 25.78 10.938 9.897 0 14.845-6.25 14.845-18.75z"}],bounds:{x:0,y:0,width:50,height:122.658},origin:{x:50,y:80.97},align:"right"},VerticalEpisemaAbove:{paths:[{type:"positive",data:"M-8-4c2 3 6 4 8 4s6-1 8-4v-52c-2-3-6-4-8-4s-6 1-8 4z"}],bounds:{x:0,y:0,width:16,height:60},origin:{x:8,y:60},align:"left"},VerticalEpisemaBelow:{paths:[{type:"positive",data:"M-8 56c2 3 6 4 8 4s6-1 8-4v-52c-2-3-6-4-8-4s-6 1-8 4z"}],bounds:{x:0,y:0,width:16,height:60},origin:{x:8,y:0},align:"left"},VirgaLong:{paths:[{type:"positive",data:"M50-38v285.156c0 6.77-2.344 10.937-7.03 12.5-1.564 0-2.605-.78-3.126-2.344-.52-1.562-.782-10.156-.782-25.78V54.186C29.168 45.334 16.146 40.907 0 40.907c-22.917 0-39.583 5.208-50 15.624V-38c0-19.27 16.667-28.906 50-28.906S50-57.27 50-38z"}],bounds:{x:0,y:0,width:100,height:326.562},origin:{x:50,y:66.906},align:"left"},VirgaShort:{paths:[{type:"positive",data:"M50-38v211.72c0 7.29-2.344 11.457-7.03 12.5-1.564 0-2.606-.783-3.126-2.345-.52-1.563-.782-10.156-.782-25.78V54.187C29.167 45.332 16.146 40.906 0 40.906c-22.917 0-39.583 5.21-50 15.625V-38c0-19.27 16.667-28.906 50-28.906S50-57.27 50-38z"}],bounds:{x:0,y:0,width:100,height:253.126},origin:{x:50,y:66.906},align:"left"},Virgula:{paths:[{type:"positive",data:"M8.178-55.66c0-22.137 12.092-33.2 36.287-33.2 11.835 0 23.53 5.66 35.108 16.98C91.15-60.547 96.94-41.766 96.94-15.534c0 53.515-31.646 87.487-94.937 101.895-2.048-2.06-3.077-5.146-3.077-9.273 0-1.03.247-1.8.76-2.316 42.71-19.027 64.075-41.678 64.075-67.92 0-11.322-2.325-20.326-6.945-27.016-4.62-6.69-9.52-11.052-14.676-13.11-5.147-2.048-11.836-3.85-20.07-5.403C12.81-39.707 8.18-45.37 8.18-55.66z"}],bounds:{x:0,y:0,width:98.014,height:175.221},origin:{x:1.074,y:88.86},align:"left"}}},function(t,e,i){"use strict";var s=i(0),n=i(1);class o extends n.f{constructor(t=!1){super(),this.auto=t,this.staffPosition=0}performLayout(t){if(super.performLayout(t),this.auto){var e=t.findNextNeume();for(e&&(this.staffPosition=t.activeClef.pitchToStaffPosition(e.notes[0].pitch));this.staffPosition<-6;)this.staffPosition+=7;for(;this.staffPosition>6;)this.staffPosition-=7}var i=new n.k(t,o.getGlyphCode(this.staffPosition));i.setStaffPosition(t,this.staffPosition),this.addVisualizer(i),this.finishLayout(t)}resetDependencies(){this.auto&&(this.needsLayout=!0)}static getGlyphCode(t){return t<=2?Math.abs(t)%2==1?n.j.CustosLong:n.j.CustosShort:Math.abs(t)%2==1?n.j.CustosDescLong:n.j.CustosDescShort}}e.c=o;class a extends n.f{constructor(){super(),this.isDivider=!0,this.resetsAccidentals=!0}}e.d=a;e.i=class extends a{performLayout(t){super.performLayout(t),this.addVisualizer(new n.h(t,2,4)),this.origin.x=this.bounds.width/2,this.finishLayout(t)}};e.h=class extends a{performLayout(t){super.performLayout(t),this.addVisualizer(new n.h(t,-2,2)),this.origin.x=this.bounds.width/2,this.finishLayout(t)}};e.g=class extends a{performLayout(t){super.performLayout(t),this.addVisualizer(new n.h(t,-3,3)),this.origin.x=this.bounds.width/2,this.finishLayout(t)}};e.e=class extends a{constructor(t){super();var e=--t%2;this.staffPosition=t-2*e}performLayout(t){super.performLayout(t),this.addVisualizer(new n.h(t,this.staffPosition-3,this.staffPosition)),this.origin.x=this.bounds.width/2,this.finishLayout(t)}};e.f=class extends a{performLayout(t){super.performLayout(t);var e=new n.h(t,-3,3);e.bounds.x=0,this.addVisualizer(e);var i=new n.h(t,-3,3);i.bounds.x=2*t.intraNeumeSpacing-i.bounds.width,this.addVisualizer(i),this.origin.x=this.bounds.width/2,this.finishLayout(t)}};const r={Flat:-1,Natural:0,Sharp:1};e.b=r;e.a=class extends n.f{constructor(t,e){super(),this.isAccidental=!0,this.keepWithNext=!0,this.staffPosition=t,this.accidentalType=e}performLayout(t){super.performLayout(t),this.addVisualizer(this.createGlyphVisualizer(t)),this.finishLayout(t)}createGlyphVisualizer(t){var e=n.j.Flat;switch(this.accidentalType){case r.Natural:e=n.j.Natural;break;case r.Sharp:e=n.j.Sharp;break;default:e=n.j.Flat}var i=new n.k(t,e);return i.setStaffPosition(t,this.staffPosition),i}adjustStep(t){switch(this.accidentalType){case r.Flat:if(t===s.j.Ti)return s.j.Te;if(t===s.j.Mi)return s.j.Me;break;case r.Sharp:if(t===s.j.Do)return s.j.Du;if(t===s.j.Fa)return s.j.Fu;break;case r.Natural:if(t===s.j.Te)return s.j.Ti;if(t===s.j.Me)return s.j.Mi;if(t===s.j.Du)return s.j.Do;if(t===s.j.Fu)return s.j.Fa}return t}applyToPitch(t){this.pitch.octave===t.octave&&(t.step=this.adjustStep(t.step))}};e.j=class extends a{constructor(){super(),this.resetsAccidentals=!1,this.staffPosition=3}performLayout(t){super.performLayout(t);var e=new n.k(t,n.j.Virgula);e.setStaffPosition(t,this.staffPosition),this.addVisualizer(e),this.origin.x=this.bounds.width/2,this.finishLayout(t)}}},function(t,e,i){"use strict";var s=i(0),n=i(1),o=i(2),a=i(3),r=i(5),h=i(7),u=/(?=.)((?:[^(])*)(?:\(?([^)]*)\)?)?/g,l=/<alt>(.*?)<\/alt>/g,c=/\[(alt:)?(.*?)\]/g,d=/z0|z|Z|::|:|[,;][1-6]?|`|[cf][1-4]|cb3|cb4|\/\/|\/| |\!|-?[a-mA-M][oOwWvVrRsxy#~\+><_\.'012345]*(?:\[[^\]]*\]?)*|\{([^}]+)\}?/g,f=1,g=/^([a-z]+):(.*)/,p=/([ou])(b|cb|cba):([01])(?:([{}])|;(\d*(?:\.\d+)?)mm)/;e.a=class{static createMappingsFromSource(t,e){var i=this.splitWords(e);t.activeClef=o.e.default();var s=this.createMappingsFromWords(t,i,e=>t.activeClef=e);return s.length>0&&s[s.length-1].notations.length>0&&(s[s.length-1].notations[s[s.length-1].notations.length-1].trailingSpace=0),s}static diffDescriptorsAndNewWords(t,e){var i,s={};for(i=0;i<t.length;i++)s[t[i].source]=s[t[i].source]||[],s[t[i].source].push(i);var n,o,a,r,h=[];for(n=o=a=0,r=0;r<e.length;r++){var u=[];for(s[e[r]]=s[e[r]]||[],i=0;i<s[e[r]].length;i++){var l=s[e[r]][i];u[l]=(l&&h[l-1]||0)+1,u[l]>a&&(n=l-(a=u[l])+1,o=r-a+1)}h=u}if(0===a){var c=[];return t.length&&c.push(["-",t]),e.length&&c.push(["+",e]),c}return[].concat(this.diffDescriptorsAndNewWords(t.slice(0,n),e.slice(0,o)),[["=",e.slice(o,o+a)]],this.diffDescriptorsAndNewWords(t.slice(n+a),e.slice(o+a)))}static updateMappingsFromSource(t,e,i){e.pop();var s,n,r,h,u=this.splitWords(i),l=this.diffDescriptorsAndNewWords(e,u),c=0,d=0,f=0;t.activeClef=o.e.default();for(var g=0;g<l.length;g++){var p=l[g][0],m=l[g][1],y=[];if(c>0&&(d=e[c-1].sourceIndex+e[c-1].source.length+1),"="===p){var x=d-e[c].sourceIndex;for(s=0;s<m.length;s++,c++)for((h=e[c]).sourceIndex+=x,n=0;n<h.notations.length;n++){var v=h.notations[n];if(v.resetDependencies(),v.isClef&&(t.activeClef=e[c].notations[n]),v.isAccidental&&(t.activeClef.activeAccidental=v),v.notes)for(r=0;r<v.notes.length;++r){let e=v.notes[r];e.sourceIndex+=x,e.pitch=t.activeClef.staffPositionToPitch(e.staffPosition),e.braceEnd&&e.braceEnd.automatic&&delete e.braceEnd,!this.needToEndBrace||e.braceStart||e.braceEnd?e.braceStart&&e.braceStart.automatic&&(this.needToEndBrace=e.braceStart):(e.braceEnd=new a.c(e,this.needToEndBrace.isAbove,this.needToEndBrace.shape,this.needToEndBrace.attachment===a.b.Left?a.b.Right:a.b.Left),e.braceEnd.automatic=!0,delete this.needToEndBrace)}if(v.translationText){for(r=0;r<v.translationText.length;++r){var b=v.translationText[r];if(delete b.endNeume,v.translationText[r].sourceIndex+=x,"end"===b.textAnchor&&y[0]){var L=y[0].translationText[r];L&&(L.endNeume=v)}}y[0]=v}if(x){for("number"==typeof v.sourceIndex&&(v.sourceIndex+=x),r=0;r<v.lyrics.length;++r)v.lyrics[r].sourceIndex+=x;if(v.alText)for(r=0;r<v.alText.length;++r)v.alText[r].sourceIndex+=x}}}else if("-"===p)e.splice(c,m.length);else if("+"===p)for(s=0;s<m.length;s++){for(f=m[s].length+1,h=this.createMappingFromWord(t,m[s],d,y),n=0;n<h.notations.length;n++)h.notations[n].isClef&&(t.activeClef=h.notations[n]);e.splice(c++,0,h),d+=f}}e.length>0&&e[e.length-1].notations.length>0&&(e[e.length-1].notations[e[e.length-1].notations.length-1].trailingSpace=0)}static createMappingsFromWords(t,e){for(var i=[],s=0,n=0,o=[],a=0;a<e.length;a++){s+=n,n=e[a].length+1;var r=e[a].trim();if(""!==r){var h=this.createMappingFromWord(t,r,s,o);h&&i.push(h)}}return i}static createMappingFromWord(t,e,i,s){for(var a=[],r=[],h=0,d=function(e,i){return new n.a(t,e,i)};g=u.exec(e);)a.push(g);for(var f=0;f<a.length;f++){var g=a[f],p=g[1].replace(/^\s+/,"").replace(/~/g," "),m=[],y=[],x=g[2];0===h&&/[a-z]/i.test(p)&&/[a-m]/i.test(x)&&t.activeClef.resetAccidentals();var v=this.parseNotations(t,x,i+g.index+g[1].length+1);if(0!==v.length){v[0].firstOfSyllable=!!p,r.push(...v);for(var b=l.exec();b=l.exec(p);){let t=b.index;p=p.slice(0,t)+p.slice(t+b[0].length),m.push(d(b[1],i+t+5)),l.exec()}for(b=c.exec();b=c.exec(p);){let e=b.index;p=p.slice(0,e)+p.slice(e+b[0].length),e+=i+1,b[1]?m.push(new n.a(t,b[2],e+b[1].length)):y.push(new n.t(t,b[2],e)),c.exec()}if(""!==p||0!==m.length){for(var L=null,w=0;w<v.length;w++){var S=v[w];if(!(S.isAccidental&&w+1<v.length)){L=S;break}}if(null===L)return new o.c(e,r,i);if(m.length&&(L.alText=m),y.length){for(L.translationText=y,w=0;w<y.length;++w)if("end"===y[w].textAnchor&&s[0]){var C=s[0].translationText[w];C&&(C.endNeume=L)}s[0]=L}if(""!==p){var T;T=S.isNeume||S.constructor===o.l?0===h&&f===a.length-1?n.n.SingleSyllable:0===h&&f<a.length-1?n.n.BeginningSyllable:f===a.length-1?n.n.EndingSyllable:n.n.MiddleSyllable:n.n.Directive,h++;var P=this.createSyllableLyrics(t,p,T,L,v,i+g.index);null!==P&&0!==P.length&&(L.lyrics=P)}}}}return new o.c(e,r,i)}static createSyllableLyrics(t,e,i,s,o,a){for(var r=[],h=e.split("|"),u=0;u<h.length;u++){var l=h[u];u>0&&(l.match(/\s$/)?(l=l.replace(/s+$/,""),i=n.n.EndingSyllable):i=n.n.MiddleSyllable);var c=l.indexOf("{"),d=0;if(c>=0){var f=l.indexOf("}");f>=0&&f>c?(d=f-c-1,l=l.substring(0,c)+l.substring(c+1,f)+l.substring(f+1,l.length)):c=-1}var g=this.makeLyric(t,l,i,s,o,a);c>=0&&(g.centerStartIndex=c,g.centerLength=d),r.push(g)}return s.lyrics=r,r}static makeLyric(t,e,i,s,o,a){var r=!1,h=!1;e.length>1&&("-"===e[e.length-1]?(h=!0,i===n.n.EndingSyllable?i=n.n.MiddleSyllable:i===n.n.SingleSyllable&&(i=n.n.BeginningSyllable),e=e.slice(0,-1)):" "===e[e.length-1]?(i===n.n.MiddleSyllable?i=n.n.EndingSyllable:i===n.n.BeginningSyllable&&(i=n.n.SingleSyllable),e=e.slice(0,-1)):"_"===e[e.length-1]&&(r=!0,e=e.slice(0,-1))),e.match(/^(?:[*†]+|i+j|\d+)\.?$/)&&(i=n.n.Directive);var u=new n.l(t,e,i,s,o,a);return u.elidesToNext=r,h&&u.setForceConnector(!0),u}static parseNotations(t,e,i){if(!e)return[new o.l];for(var s,n=i,a=[],h=[],u=-1,l=e=>{if(h.length>0){for(var s=this.createNeumesFromNotes(t,h,u),n=0;n<s.length;n++)a.push(s[n]);h=[]}if(u=-1,null!==e){let s=a[a.length-1];e.sourceIndex=i,e.isClef?(t.activeClef=e,s&&s.trailingSpace<0&&s.isDivider&&(s.trailingSpace=t.intraNeumeSpacing*t.accidentalSpaceMultiplier)):e.isAccidental?t.activeClef.activeAccidental=e:e.trailingSpace<0&&e instanceof r.c?e.trailingSpace=t.intraNeumeSpacing*t.accidentalSpaceMultiplier:e.resetsAccidentals&&t.activeClef.resetAccidentals(),a.push(e)}},c=new RegExp(d.source,"g");s=c.exec(e);){i=n+s.index;var g=s[0];switch(g){case",":l(new r.i);break;case"`":l(new r.j);break;case";":l(new r.h);break;case";1":case";2":case";3":case";4":case";5":case";6":case",1":case",2":case",3":case",4":case",5":case",6":l(new r.e(parseInt(g[1],10)));break;case":":l(new r.g);break;case"::":l(new r.f);break;case"c1":l(t.activeClef=new o.f(-3,2));break;case"c2":l(t.activeClef=new o.f(-1,2));break;case"c3":l(t.activeClef=new o.f(1,2));break;case"c4":l(t.activeClef=new o.f(3,2));break;case"f1":l(t.activeClef=new o.g(-3,2));break;case"f2":l(t.activeClef=new o.g(-1,2));break;case"f3":l(t.activeClef=new o.g(1,2));break;case"f4":l(t.activeClef=new o.g(3,2));break;case"cb3":l(t.activeClef=new o.f(1,2,new r.a(0,r.b.Flat)));break;case"cb4":l(t.activeClef=new o.f(3,2,new r.a(2,r.b.Flat)));break;case"z":l(new o.b(!0));break;case"Z":l(new o.b(!1));break;case"z0":l(new r.c(!0));break;case"!":u=0,l(null);break;case"/":u=t.intraNeumeSpacing,l(null);break;case"//":case" ":u=2*t.intraNeumeSpacing,l(null);break;default:if(g.length>1&&"+"===g[1]){var p=new r.c;p.staffPosition=this.gabcHeightToExsurgeHeight(g[0]),l(p)}else if(g.length>1&&/[xy#]/.test(g[1])){var m;switch(g[1]){case"y":m=r.b.Natural;break;case"#":m=r.b.Sharp;break;default:m=r.b.Flat}var y=[];this.createNoteFromData(t,t.activeClef,g,y,i);var x=new r.a(y[0].staffPosition,m);x.pitch=this.gabcHeightToExsurgePitch(t.activeClef,g[0]),x.sourceIndex=i,x.trailingSpace=t.intraNeumeSpacing*t.accidentalSpaceMultiplier,t.activeClef.activeAccidental=x,l(x)}else if(g.length>1&&"{"===g[0]){u=0,l(null);let e=this.parseNotations(t,s[f],i+1);e.forEach(t=>{t.hasNoWidth=!0,t.firstWithNoWidth=e[0]}),a.push(...e)}else this.createNoteFromData(t,t.activeClef,g,h,i)}}return l(null),a}static createNeumesFromNotes(t,e,i){for(var s=[],n=0,r=0,u=function(i,a,h=!0){var u;if(!((u=a?r:h?r-1:r-2)<0)){for(;n<=u;){let t=e[n++];i.addNote(t),t.alText&&(i.alText||(i.alText=[]),i.alText.push(t.alText))}return s.push(i),!1===a&&(r--,!1===h&&r--,i.keepWithNext=!0,e[r+1].shape===o.j.Quilisma?i.trailingSpace=0:(i.trailingSpace=t.intraNeumeSpacing,i.allowLineBreakBeforeNext=!0)),l}},l={neume:function(){return new h.n},handle:function(t,e){return t.shape===o.j.Virga?S:t.shape===o.j.Stropha?T:t.shape===o.j.Oriscus?f:t.shape===o.j.Inclinatum?d:t.shapeModifiers&o.k.Cavum?u(new h.n,!0):c}},c={neume:function(){return new h.n},handle:function(t,e,i){if(t.shape){var s=new h.n,n=u(s,!1);return t.staffPosition>e.staffPosition&&(t.staffPosition%2==1||e.staffPosition!==t.staffPosition-1||!e.morae||0===e.morae.length)&&(s.trailingSpace=0),n}return t.staffPosition>e.staffPosition?(t.ictus&&(t.ictus.positionHint=a.h.Above),g):t.staffPosition<e.staffPosition?(e.ictus&&(e.ictus.positionHint=a.h.Above),t.shape===o.j.Inclinatum?m:p):e.morae&&e.morae.length?u(new h.n,!1):P}},d={neume:function(){return new h.m},handle:function(){return k.shape!==o.j.Inclinatum?u(new h.m,!1):d}},f={neume:function(){return new h.g},handle:function(t,e){if(t.shape!==o.j.Default){var i=new h.g,s=u(i,!1);return t.staffPosition>e.staffPosition&&(t.staffPosition%2==1||e.staffPosition!==t.staffPosition-1||!e.morae||0===e.morae.length)&&(i.trailingSpace=0),s}return t.staffPosition>e.staffPosition?(e.shapeModifiers|=o.k.Ascending,u(new h.h,!0)):t.staffPosition<e.staffPosition?(e.shapeModifiers|=o.k.Descending,u(new h.d,!0)):void 0}},g={neume:function(){return new h.j},handle:function(t,e){return t.staffPosition>e.staffPosition?(t.ictus&&(t.ictus.positionHint=a.h.Above),e.ictus&&(e.ictus.positionHint=a.h.Below),e.shape===o.j.Oriscus?v:L):t.staffPosition<e.staffPosition?t.shape===o.j.Inclinatum?x:A:u(new h.j,!1)}},p={neume:function(){return new h.d},handle:function(t,e){return t.shape===o.j.Default&&t.staffPosition>e.staffPosition?(t.ictus&&(t.ictus.positionHint=a.h.Above),y):u(new h.d,!1)}},m={neume:function(){return new h.c},handle:function(t,e){return t.shape!==o.j.Inclinatum?u(new h.c,!1):j}},y={neume:function(){return new h.k},handle:function(t,e){return t.shape===o.j.Default&&t.staffPosition<e.staffPosition?u(new h.l,!0):u(new h.k,!1)}},x={neume:function(){return new h.i},handle:function(t,e){return t.shape!==o.j.Inclinatum?u(new h.i,!1):j}},v={neume:function(){return new h.o},handle:function(t,e){return t.staffPosition<e.staffPosition?b:u(new h.o,!1)}},b={neume:function(){return new h.p},handle:function(t,e){return u(new h.p,!1)}},L={neume:function(){return new h.q},handle:function(t,e){return e.shape===o.j.Virga&&t.shape===o.j.Inclinatum&&t.staffPosition<e.staffPosition?u(new h.j,!1,!1):t.shape===o.j.Default&&t.staffPosition<e.staffPosition?w:u(new h.q,!1)}},w={neume:function(){return new h.r},handle:function(t,e){return u(new h.r,!1)}},S={neume:function(){return new h.x},handle:function(t,e){return t.shape===o.j.Inclinatum&&t.staffPosition<e.staffPosition?m:t.shape===o.j.Virga&&t.staffPosition===e.staffPosition?C:u(new h.x,!1)}},C={neume:function(){return new h.b},handle:function(t,e){return t.shape===o.j.Virga&&t.staffPosition===e.staffPosition?u(new h.w,!0):u(new h.b,!1)}},T={neume:function(){return new h.a},handle:function(t,e){return t.staffPosition===e.staffPosition?P:u(new h.a,!1)}},P={neume:function(){return new h.e},handle:function(t,e){return t.staffPosition===e.staffPosition?e.morae&&e.morae.length?u(new h.e,!1):N:u(new h.a,!1,!1)}},N={neume:function(){return new h.v},handle:function(t,e){return u(new h.e,!1,!1)}},A={neume:function(){return new h.s},handle:function(t,e){return t.shape===o.j.Default&&t.staffPosition>e.staffPosition?(t.ictus&&(t.ictus.positionHint=a.h.Above),I):u(new h.s,!1)}},I={neume:function(){return new h.t},handle:function(t,e){return t.shape===o.j.Default&&t.staffPosition<e.staffPosition?u(new h.u,!0):u(new h.t,!1)}},j=l;r<e.length;){var M=r>0?e[r-1]:null,k=e[r];j=j.handle(k,M,e.length-1-r),r===e.length-1&&j!==l&&u(j.neume(),!0),r++}return s.length>0&&i>=0&&(s[s.length-1].trailingSpace=i,s[s.length-1].keepWithNext=!0,i>=t.intraNeumeSpacing&&(s[s.length-1].allowLineBreakBeforeNext=s[s.length-1].keepWithNext=!0)),s}static createNoteFromData(t,e,i,n,r){var h=new o.i;if(h.sourceIndex=r,i.length<1)throw"Invalid note data: "+i;if("-"===i[0]&&(h.liquescent=o.h.InitioDebilis,i=i.substring(1)),i.length<1)throw"Invalid note data: "+i;var u,l=this.gabcHeightToExsurgePitch(e,i[0]);i[0]===i[0].toUpperCase()&&(h.shape=o.j.Inclinatum),h.staffPosition=this.gabcHeightToExsurgeHeight(i[0]),h.pitch=l;for(var c=n.length,d=h,f=1;f<i.length;f++){var g=i[f],p="\0",m=f+1<i.length;switch(m&&(p=i[f+1]),g){case".":if(u=null,h.morae.length>0&&n.length){var y=n.slice(-1)[0];h.morae.slice(-1)[0].note=y}u=new a.i(t,h),m&&"1"===p?u.positionHint=a.h.Above:m&&"0"===p&&(u.positionHint=a.h.Below),h.morae.push(u);break;case"_":var x=!1;for(u=new a.e(d);m;){if("0"===p)u.positionHint=a.h.Below;else if("1"===p)u.positionHint=a.h.Above;else if("2"===p)u.terminating=!0;else if("3"===p)u.alignment=a.f.Left;else if("4"===p)u.alignment=a.f.Center;else{if("5"!==p)break;u.alignment=a.f.Right}u.alignment!==a.f.Default&&u.positionHint!==a.h.Below&&(x=!0),(m=++f+1<i.length)&&(p=i[f+1])}d&&d.episemata.push(u),d===h&&x?d=h:c>=0&&n.length>0&&(d=n[--c]);break;case"'":u=new a.g(t,h),m&&"1"===p?u.positionHint=a.h.Above:m&&"0"===p?u.positionHint=a.h.Below:h.shape===o.j.Virga&&(u.positionHint=a.h.Above),h.ictus=u;break;case"r":m&&"1"===p?(h.acuteAccent=new a.a(t,h),f++):h.shapeModifiers|=o.k.Cavum;break;case"s":if(h.shape===o.j.Stropha){let t=new o.i;t.sourceIndex=r+f,t.staffPosition=h.staffPosition,t.pitch=h.pitch,n.push(h),h=t,c++}h.shape=o.j.Stropha;break;case"v":if(h.shape===o.j.Virga){let t=new o.i;t.sourceIndex=r+f,t.staffPosition=h.staffPosition,t.pitch=h.pitch,n.push(h),h=t,c++}h.shape=o.j.Virga;break;case"w":h.shape=o.j.Quilisma;break;case"o":h.shape=o.j.Oriscus,m&&"<"===p?(h.shapeModifiers|=o.k.Ascending,f++):m&&">"===p&&(h.shapeModifiers|=o.k.Descending,f++);break;case"O":h.shape=o.j.Oriscus,m&&"<"===p?(h.shapeModifiers|=o.k.Ascending|o.k.Stemmed,f++):m&&">"===p?(h.shapeModifiers|=o.k.Descending|o.k.Stemmed,f++):h.shapeModifiers|=o.k.Stemmed;break;case"~":h.shape===o.j.Inclinatum?h.liquescent|=o.h.Small:h.shape===o.j.Oriscus?h.liquescent|=o.h.Large:h.liquescent|=o.h.Small;break;case"<":h.liquescent|=o.h.Ascending;break;case">":h.liquescent|=o.h.Descending;break;case"x":h.pitch.step===s.j.Mi?h.pitch.step=s.j.Me:h.pitch.step===s.j.Ti&&(h.pitch.step=s.j.Te);break;case"y":h.pitch.step===s.j.Te?h.pitch.step=s.j.Ti:h.pitch.step===s.j.Me?h.pitch.step=s.j.Mi:h.pitch.step===s.j.Du?h.pitch.step=s.j.Do:h.pitch.step===s.j.Fu&&(h.pitch.step=s.j.Fa);break;case"#":h.pitch.step===s.j.Do?h.pitch.step=s.j.Du:h.pitch.step===s.j.Fa&&(h.pitch.step=s.j.Fu);break;case"[":for(var v=++f;f<i.length&&"]"!==i[f];)f++;this.processInstructionForNote(t,h,i.substring(v,f),v)}}!this.needToEndBrace||h.braceStart||h.braceEnd||/[xy#]/.test(g)||(h.braceEnd=new a.c(h,this.needToEndBrace.isAbove,this.needToEndBrace.shape,this.needToEndBrace.attachment===a.b.Left?a.b.Right:a.b.Left),h.braceEnd.automatic=!0,delete this.needToEndBrace),n.push(h)}static processInstructionForNote(t,e,i,s){var o=i.match(g);if(null!==o){var r=o[1],h=o[2];switch(r){case"cs":return;case"alt":return e.alText=new n.a(t,h,e.sourceIndex+s),void(e.alText.alignToNote=!0)}if(null!==(o=i.match(p))){var u="o"===o[1],l=a.d.CurlyBrace;switch(o[2]){case"b":l=a.d.RoundBrace;break;case"cb":l=a.d.CurlyBrace;break;case"cba":l=a.d.AccentedCurlyBrace}var c="1"===o[3]?a.b.Left:a.b.Right;"{"===o[4]||o[5]?e.braceStart=new a.c(e,u,l,c):e.braceEnd=new a.c(e,u,l,c),o[5]&&(e.braceStart.automatic=!0,this.needToEndBrace=e.braceStart)}}}static splitWords(t){return(t=t.trim().replace(/\s/g," ").replace(/\) (?=[^\)]*(?:\(|$))/g,")\n")).split(/\n/g)}static parseSource(t){return this.parseWords(this.splitWords(t))}static parseWords(t){for(var e=[],i=0;i<t.length;i++)e.push(this.parseWord(t[i]));return e}static parseWord(t){var e=[],i=[];for(e.wordLength=t.length;n=u.exec(t);)i.push(n);for(var s=0;s<i.length;s++){var n=i[s],o=n[1].trim().split("|"),a=n[2];e.push({notations:a,lyrics:o})}return e}static gabcHeightToExsurgeHeight(t){return t.toLowerCase().charCodeAt(0)-"a".charCodeAt(0)-6}static gabcHeightToExsurgePitch(t,e){var i=this.gabcHeightToExsurgeHeight(e);return t.staffPositionToPitch(i)}}},function(t,e,i){"use strict";i(0);var s=i(1),n=i(2),o=i(3),a=i(4);class r{constructor(t,e,i=0){this.ctxt=t,this.neume=e,this.x=i,this.lastNote=null,this.lineIsHanging=!1,this.minX=0}lineFrom(t){var e=this.ctxt.notations[this.ctxt.currNotationIndex-1];return 0===this.x&&e&&e.notes&&0===e.trailingSpace?(this.lastNote=e.notes.slice(-1)[0],this.minX=-this.ctxt.neumeLineWeight):(this.lastNote=t,this.lineIsHanging=!0),this}noteAt(t,e,i=!0){if(!t)throw"NeumeBuilder.noteAt: note must be a valid note";if(!e)throw"NeumeBuilder.noteAt: glyph must be a valid glyph code";t.setGlyph(this.ctxt,e);var n="right"===t.glyphVisualizer.align;if(i&&null!==this.lastNote&&(this.lineIsHanging||this.lastNote.glyphVisualizer&&"right"===this.lastNote.glyphVisualizer.align||Math.abs(this.lastNote.staffPosition-t.staffPosition)>1)){var o=new s.o(this.ctxt,this.lastNote,t,this.lineIsHanging);this.neume.addVisualizer(o),o.bounds.x=Math.max(this.minX,this.x-o.bounds.width),n||(this.x=o.bounds.x)}return n&&this.lastNote?t.bounds.x=this.x-t.bounds.width:(t.bounds.x=this.x,this.x+=t.bounds.width),this.neume.addVisualizer(t),this.lastNote=t,this.lineIsHanging=!1,this}virgaAt(t,e=!0){this.noteAt(t,s.j.PunctumQuadratum);var i=new s.u(this.ctxt,t);return this.x-=i.bounds.width,i.bounds.x=this.x,this.neume.addVisualizer(i),this.lastNote=t,this.lineIsHanging=!1,this}advanceBy(t){return this.lastNote=null,this.lineIsHanging=!1,this.x+=t,this}withLineEndingAt(t){if(null!==this.lastNote){var e=new s.o(this.ctxt,this.lastNote,t,!0);return this.neume.addVisualizer(e),this.x-=e.bounds.width,e.bounds.x=this.x,this.neume.addVisualizer(e),this.lastNote=t,this}}withPodatus(t,e){var i,o;return t.liquescent===n.h.InitioDebilis?(i=e.liquescent===n.h.None?s.j.PunctumQuadratum:s.j.PunctumQuadratumDesLiquescent,o=s.j.TerminatingDesLiquescent):e.liquescent&n.h.Small?(o=s.j.BeginningAscLiquescent,i=s.j.TerminatingAscLiquescent):e.liquescent&n.h.Ascending?(o=s.j.PunctumQuadratum,i=s.j.PunctumQuadratumAscLiquescent):e.liquescent&n.h.Descending?(o=s.j.PunctumQuadratum,i=s.j.PunctumQuadratumDesLiquescent):(o=s.j.PodatusLower,i=s.j.PodatusUpper),t.shape===n.j.Quilisma&&(o=s.j.Quilisma),this.noteAt(t,o).noteAt(e,i),this.lastNote=null,this}withClivis(t,e){var i;return t.shape===n.j.Oriscus?this.noteAt(t,s.j.OriscusDes,!1):this.lineFrom(e).noteAt(t,s.j.PunctumQuadratum),i=e.liquescent&n.h.Small?s.j.TerminatingDesLiquescent:e.liquescent===n.h.Ascending?s.j.PunctumQuadratumAscLiquescent:e.liquescent===n.h.Descending?s.j.PunctumQuadratumDesLiquescent:s.j.PunctumQuadratum,this.noteAt(e,i),this.lastNote=null,this}withInclinata(t){for(var e=t[0].staffPosition,i=t[0].staffPosition,o=a.a.PunctumInclinatum.bounds.width*this.ctxt.glyphScaling,r=0;r<t.length;r++,i=e){var h=t[r];h.liquescent&n.h.Small?h.setGlyph(this.ctxt,s.j.PunctumInclinatumLiquescent):h.liquescent&n.h.Large?h.setGlyph(this.ctxt,s.j.Stropha):h.setGlyph(this.ctxt,s.j.PunctumInclinatum),e=h.staffPosition;var u=Math.abs(i-e);switch(u){case 0:u=1.1;break;default:u*=2/3}r>0&&(this.x+=o*u),h.bounds.x=this.x,this.neume.addVisualizer(h)}return this}withPorrectusSwash(t,e){var i;if(null!==this.lastNote&&(this.lineIsHanging||this.lastNote.glyphVisualizer&&"right"===this.lastNote.glyphVisualizer.align||Math.abs(this.lastNote.staffPosition-t.staffPosition)>1)){var n=new s.o(this.ctxt,this.lastNote,t,this.lineIsHanging);this.x=Math.max(this.minX,this.x-n.bounds.width),n.bounds.x=this.x,this.neume.addVisualizer(n)}switch(t.staffPosition-e.staffPosition){case 1:i=s.j.Porrectus1;break;case 2:i=s.j.Porrectus2;break;case 3:i=s.j.Porrectus3;break;case 4:i=s.j.Porrectus4;break;default:i=s.j.None}return t.setGlyph(this.ctxt,i),t.bounds.x=this.x,e.setGlyph(this.ctxt,s.j.None),this.x=t.bounds.right(),e.bounds.x=this.x-e.bounds.width,this.neume.addVisualizer(t),this.neume.addVisualizer(e),this.lastNote=e,this.lineIsHanging=!1,this}}class h extends s.f{constructor(t=[]){super(),this.isNeume=!0,this.notes=t;for(var e=0;e<t.length;e++)t[e].neume=this}addNote(t){t.neume=this,this.notes.push(t)}performLayout(t){super.performLayout(t)}finishLayout(t){this.ledgerLines=this.requiresLedgerLine(),this.positionMarkings();for(var e=0;e<this.notes.length;e++){var i,s=this.notes[e];for(i=0;i<s.episemata.length;i++)s.episemata[i].performLayout(t),this.addVisualizer(s.episemata[i]);for(i=0;i<s.morae.length;i++)s.morae[i].performLayout(t),this.addVisualizer(s.morae[i]);s.ictus&&(s.ictus.performLayout(t),this.addVisualizer(s.ictus)),s.acuteAccent&&(s.acuteAccent.performLayout(t),this.addVisualizer(s.acuteAccent))}this.origin.x=this.notes[0].origin.x,this.origin.y=this.notes[0].origin.y,super.finishLayout(t)}requiresLedgerLine(){var t=!1,e=!1,i=!1,s=!1,n=[];if(!this.notes)return n;for(var o=0;o<this.notes.length;++o){var a=this.notes[o].staffPosition;if(a>=4){if(e=e||a>=5,!1===t&&(t=Math.max(0,o-1)),a>=5)continue}else if(a<=-4&&(s=s||a<=-5,!1===i&&(i=Math.max(0,o-1)),a<=-5))continue;if(e||s){var r=o;n.push({element:this.notes[t||i||0],endElem:this.notes[r],staffPosition:e?5:-5}),t=i=e=s=!1}}return(e||s)&&n.push({element:this.notes[t||i||0],endElem:this.notes[this.notes.length-1],staffPosition:e?5:-5}),n}resetDependencies(){}build(t){return new r(t,this)}positionEpisemata(t,e){var i;for(i=0;i<t.episemata.length;i++)t.episemata[i].positionHint===o.h.Default&&(t.episemata[i].positionHint=e);return t.episemata.length}positionEpisemataAbove(t){return this.positionEpisemata(t,o.h.Above)}positionEpisemataBelow(t){return this.positionEpisemata(t,o.h.Below)}positionPodatusEpisemata(t,e){this.positionEpisemataBelow(t),this.positionEpisemataAbove(e)}positionInclinataMorae(t){if(!((t=t.slice(-2)).length<2||t[1].staffPosition>t[0].staffPosition)){var e,i=t[1],s=t[0];1===Math.abs(i.staffPosition%2)&&s.staffPosition-i.staffPosition==1&&i.morae.length>0&&(e=i.morae.slice(-1)[0]).positionHint===o.h.Default&&(e.positionHint=o.h.Below)}}positionPodatusMorae(t,e){var i;1===Math.abs(t.staffPosition%2)&&(1===t.morae.length?i=t.morae[0]:e.morae.length>1&&(i=e.morae[0]),i&&i.positionHint===o.h.Default&&(i.positionHint=o.h.Below)),t.morae.length>0&&0===e.morae.length&&(t.morae[0].ignoreBounds=!0)}positionPodatusMarkings(t,e){this.positionPodatusEpisemata(t,e),this.positionPodatusMorae(t,e)}positionTorculusMarkings(t,e,i){var s=this.positionClivisMarkings(e,i);return s=this.positionEpisemata(t,s?o.h.Above:o.h.Below)&&s}positionClivisMorae(t,e){var i=t.morae.concat(e.morae);e.morae.length&&(i.length>1&&(i[0].horizontalOffset+=e.bounds.right()-t.bounds.right()),t.staffPosition-e.staffPosition==1&&1===Math.abs(e.staffPosition%2)&&(i.slice(-1)[0].positionHint=o.h.Below))}positionClivisEpisemata(t,e){var i=this.positionEpisemataAbove(t);return this.positionEpisemata(e,i?o.h.Above:o.h.Below),i}positionClivisMarkings(t,e){return this.positionClivisMorae(t,e),this.positionClivisEpisemata(t,e)}positionPorrectusMarkings(t,e,i){this.positionClivisEpisemata(t,e),this.positionPodatusMarkings(e,i)}positionPorrectusFlexusMarkings(t,e,i,s){var n=this.positionEpisemataAbove(t);n=this.positionClivisMarkings(i,s)||n,this.positionEpisemata(e,n?o.h.Above:o.h.Below)}positionMarkings(){}}e.f=h;class u extends h{positionMarkings(){for(var t=o.h.Above,e=0;e<this.notes[0].episemata.length;e++)this.notes[0].episemata[e].positionHint===o.h.Default?this.notes[0].episemata[e].positionHint=t:t=this.notes[0].episemata[e].positionHint,t=t===o.h.Above?o.h.Below:o.h.Above}performLayout(t){super.performLayout(t),this.build(t).noteAt(this.notes[0],u.getNoteGlyphCode(this.notes[0])),this.finishLayout(t)}static getNoteGlyphCode(t){return t.shape===n.j.Stropha?s.j.Stropha:t.liquescent&n.h.Ascending?s.j.PunctumQuadratumAscLiquescent:t.liquescent&n.h.Descending?s.j.PunctumQuadratumDesLiquescent:t.shapeModifiers&n.k.Cavum?s.j.PunctumCavum:s.j.PunctumQuadratum}}e.a=u;e.b=class extends h{positionMarkings(){this.positionEpisemataAbove(this.notes[0]),this.positionEpisemataAbove(this.notes[1])}performLayout(t){super.performLayout(t),this.build(t).virgaAt(this.notes[0]).advanceBy(t.intraNeumeSpacing).virgaAt(this.notes[1]),this.finishLayout(t)}};e.w=class extends h{positionMarkings(){this.positionEpisemataAbove(this.notes[0]),this.positionEpisemataAbove(this.notes[1]),this.positionEpisemataAbove(this.notes[2])}performLayout(t){super.performLayout(t),this.build(t).virgaAt(this.notes[0]).advanceBy(t.intraNeumeSpacing).virgaAt(this.notes[1]).advanceBy(t.intraNeumeSpacing).virgaAt(this.notes[2]),this.finishLayout(t)}};e.c=class extends h{positionMarkings(){for(var t=0;t<this.notes.length;t++)this.positionEpisemataAbove(this.notes[t]);this.positionInclinataMorae(this.notes)}performLayout(t){super.performLayout(t),this.build(t).virgaAt(this.notes[0]).advanceBy(t.intraNeumeSpacing).withInclinata(this.notes.slice(1)),this.finishLayout(t)}};e.d=class extends h{positionMarkings(){this.positionClivisMarkings(this.notes[0],this.notes[1])}performLayout(t){super.performLayout(t);var e=this.notes[0],i=this.notes[1];this.build(t).withClivis(e,i),this.finishLayout(t)}};e.e=class extends h{positionMarkings(){this.positionEpisemataAbove(this.notes[0]),this.positionEpisemataAbove(this.notes[1])}performLayout(t){super.performLayout(t),this.build(t).noteAt(this.notes[0],u.getNoteGlyphCode(this.notes[0])).advanceBy(t.intraNeumeSpacing).noteAt(this.notes[1],u.getNoteGlyphCode(this.notes[1])),this.finishLayout(t)}};e.g=class extends h{positionMarkings(){this.positionEpisemataAbove(this.notes[0])}performLayout(t){super.performLayout(t);var e,i=this.notes[0];if(i.liquescent!==n.h.None)e=s.j.OriscusLiquescent;else if(i.shapeModifiers&n.k.Ascending)e=s.j.OriscusAsc;else if(i.shapeModifiers&n.k.Descending)e=s.j.OriscusDes;else{e=s.j.OriscusDes;var o=t.findNextNeume();o&&t.activeClef.pitchToStaffPosition(o.notes[0].pitch)>i.staffPosition&&(e=s.j.OriscusAsc)}this.build(t).noteAt(i,e),this.finishLayout(t)}resetDependencies(){this.notes[0].shapeModifiers&n.k.Ascending||this.notes[0].shapeModifiers&n.k.Descending||(this.needsLayout=!0)}};e.h=class extends h{performLayout(t){super.performLayout(t);var e,i=this.notes[0],o=this.notes[1],a=i.staffPosition,r=o.staffPosition;e=i.shape===n.j.Oriscus?s.j.OriscusAsc:s.j.PunctumQuadratum;var h=this.build(t).noteAt(i,e);r-a==1?h.virgaAt(o):o.liquescent===n.h.LargeDescending?h.noteAt(o,s.j.PunctumQuadratumDesLiquescent).withLineEndingAt(i):h.noteAt(o,s.j.PunctumQuadratum).withLineEndingAt(i),this.finishLayout(t)}};e.i=class extends h{positionMarkings(){this.positionPodatusEpisemata(this.notes[0],this.notes[1]);for(var t=2;t<this.notes.length;++t)this.positionEpisemataAbove(this.notes[t]);this.positionInclinataMorae(this.notes.slice(1))}performLayout(t){super.performLayout(t),this.build(t).withPodatus(this.notes[0],this.notes[1]).advanceBy(.68*t.intraNeumeSpacing).withInclinata(this.notes.slice(2)),this.finishLayout(t)}};e.j=class extends h{positionMarkings(){this.positionPodatusMarkings(this.notes[0],this.notes[1])}performLayout(t){super.performLayout(t),this.build(t).withPodatus(this.notes[0],this.notes[1]),this.finishLayout(t)}};e.k=class extends h{positionMarkings(){this.positionPorrectusMarkings(this.notes[0],this.notes[1],this.notes[2])}performLayout(t){super.performLayout(t);var e,i=this.notes[0],o=this.notes[1],a=this.notes[2];e=a.liquescent&n.h.Small?s.j.TerminatingAscLiquescent:a.liquescent&n.h.Descending?s.j.PunctumQuadratumDesLiquescent:s.j.PodatusUpper,this.build(t).lineFrom(o).withPorrectusSwash(i,o).noteAt(a,e),this.finishLayout(t)}};e.l=class extends h{positionMarkings(){this.positionPorrectusFlexusMarkings(this.notes[0],this.notes[1],this.notes[2],this.notes[3])}performLayout(t){super.performLayout(t);var e,i=this.notes[0],o=this.notes[1],a=this.notes[2],r=this.notes[3],h=s.j.PunctumQuadratum;r.liquescent&n.h.Small?(h=s.j.PunctumQuadratumDesLiquescent,e=s.j.TerminatingDesLiquescent):e=r.liquescent&n.h.Ascending?s.j.PunctumQuadratumAscLiquescent:r.liquescent&n.h.Descending?s.j.PunctumQuadratumDesLiquescent:s.j.PunctumQuadratum,this.build(t).lineFrom(o).withPorrectusSwash(i,o).noteAt(a,h).noteAt(r,e),this.finishLayout(t)}};e.m=class extends h{positionMarkings(){this.positionInclinataMorae(this.notes)}performLayout(t){super.performLayout(t),this.build(t).withInclinata(this.notes),this.finishLayout(t)}};e.n=class extends h{positionMarkings(){this.positionEpisemataAbove(this.notes[0])}performLayout(t){super.performLayout(t);var e=this.notes[0],i=s.j.PunctumQuadratum;e.liquescent!==n.h.None?e.shape===n.j.Inclinatum?i=s.j.PunctumInclinatumLiquescent:e.shape===n.j.Oriscus?i=s.j.OriscusLiquescent:e.liquescent&n.h.Ascending?i=s.j.PunctumQuadratumAscLiquescent:e.liquescent&n.h.Descending&&(i=s.j.PunctumQuadratumDesLiquescent):i=e.shapeModifiers&n.k.Cavum?s.j.PunctumCavum:e.shape===n.j.Inclinatum?s.j.PunctumInclinatum:e.shape===n.j.Quilisma?s.j.Quilisma:s.j.PunctumQuadratum,this.build(t).noteAt(e,i),this.finishLayout(t)}};e.o=class extends h{positionMarkings(){for(var t=0;t<this.notes.length;t++)this.positionEpisemataBelow(this.notes[t])}performLayout(t){super.performLayout(t);var e=this.notes[0],i=this.notes[1],o=this.notes[2],a=this.build(t).noteAt(e,s.j.PunctumQuadratum);i.shapeModifiers&n.k.Stemmed||a.advanceBy(t.intraNeumeSpacing),a.noteAt(i,s.j.OriscusAsc),o.liquescent&n.h.Small?a.noteAt(o,s.j.TerminatingAscLiquescent):o.liquescent===n.h.Ascending?a.noteAt(o,s.j.PunctumQuadratumAscLiquescent):o.liquescent===n.h.Descending?a.noteAt(o,s.j.PunctumQuadratumDesLiquescent):a.virgaAt(o),this.finishLayout(t)}};e.p=class extends h{positionMarkings(){var t=this.positionTorculusMarkings(this.notes[1],this.notes[2],this.notes[3]);this.positionEpisemata(this.notes[0],t?o.h.Above:o.h.Below)}performLayout(t){super.performLayout(t);var e=this.notes[0],i=this.notes[1],o=this.notes[2],a=this.notes[3],r=this.build(t).noteAt(e,s.j.PunctumQuadratum);i.shapeModifiers&n.k.Stemmed||r.advanceBy(t.intraNeumeSpacing),r.noteAt(i,s.j.OriscusAsc),a.liquescent&n.h.Small?r.noteAt(o,s.j.PunctumQuadratumDesLiquescent):r.noteAt(o,s.j.PunctumQuadratum),a.liquescent&n.h.Small?r.noteAt(a,s.j.TerminatingDesLiquescent):a.liquescent&n.h.Ascending?r.noteAt(a,s.j.PunctumQuadratumAscLiquescent):a.liquescent&n.h.Descending?r.noteAt(a,s.j.PunctumQuadratumDesLiquescent):r.noteAt(a,s.j.PunctumQuadratum),this.finishLayout(t)}};e.q=class extends h{positionMarkings(){this.notes[2].shape===n.j.Virga?(this.positionPodatusMarkings(this.notes[0],this.notes[1]),this.positionEpisemataAbove(this.notes[2])):(this.positionEpisemataBelow(this.notes[0]),this.positionPodatusMarkings(this.notes[1],this.notes[2]))}performLayout(t){super.performLayout(t);var e=this.notes[0],i=this.notes[1],o=this.notes[2];o.shape===n.j.Virga?this.build(t).withPodatus(e,i).virgaAt(o):this.build(t).noteAt(e,e.shape===n.j.Quilisma?s.j.Quilisma:s.j.PunctumQuadratum).withPodatus(i,o),this.finishLayout(t)}};e.r=class extends h{positionMarkings(){this.notes[2].shape===n.j.Virga?(this.positionPodatusMarkings(this.notes[0],this.notes[1]),this.positionClivisMarkings(this.notes[2],this.notes[3])):(this.positionEpisemataBelow(this.notes[0]),this.positionPodatusMarkings(this.notes[1],this.notes[2]),this.positionEpisemataAbove(this.notes[3]))}performLayout(t){super.performLayout(t);var e=this.notes[0],i=this.notes[1],o=this.notes[2],a=this.notes[3];if(o.shape===n.j.Virga)this.build(t).withPodatus(e,i).advanceBy(t.intraNeumeSpacing).withClivis(o,a);else{var r=s.j.PunctumQuadratum;a.liquescent&n.h.Ascending?r=s.j.PunctumQuadratumAscLiquescent:a.liquescent&n.h.Descending&&(r=s.j.PunctumQuadratumDesLiquescent),this.build(t).noteAt(e,s.j.PunctumQuadratum).withPodatus(i,o).advanceBy(t.intraNeumeSpacing).noteAt(a,r)}this.finishLayout(t)}};e.s=class extends h{positionMarkings(){this.positionTorculusMarkings(this.notes[0],this.notes[1],this.notes[2])}performLayout(t){super.performLayout(t);var e,i,o=this.notes[0],a=this.notes[1],r=this.notes[2];e=o.liquescent===n.h.InitioDebilis?s.j.TerminatingDesLiquescent:o.shape===n.j.Quilisma?s.j.Quilisma:s.j.PunctumQuadratum,i=r.liquescent&n.h.Small?s.j.TerminatingDesLiquescent:r.liquescent&n.h.Ascending?s.j.PunctumQuadratumAscLiquescent:r.liquescent&n.h.Descending?s.j.PunctumQuadratumDesLiquescent:s.j.PunctumQuadratum,this.build(t).noteAt(o,e).noteAt(a,s.j.PunctumQuadratum).noteAt(r,i),this.finishLayout(t)}};e.t=class extends h{positionMarkings(){this.positionPorrectusMarkings(this.notes[1],this.notes[2],this.notes[3]),this.positionClivisEpisemata(this.notes[1],this.notes[0])}performLayout(t){super.performLayout(t);var e,i,o=this.notes[0],a=this.notes[1],r=this.notes[2],h=this.notes[3];e=o.liquescent===n.h.InitioDebilis?s.j.TerminatingDesLiquescent:o.shape===n.j.Quilisma?s.j.Quilisma:s.j.PunctumQuadratum,i=h.liquescent&n.h.Small?s.j.TerminatingAscLiquescent:r.liquescent&n.h.Descending?s.j.PunctumQuadratumDesLiquescent:s.j.PodatusUpper,this.build(t).noteAt(o,e).withPorrectusSwash(a,r).noteAt(h,i),this.finishLayout(t)}};e.u=class extends h{positionMarkings(){this.positionPorrectusFlexusMarkings(this.notes[1],this.notes[2],this.notes[3],this.notes[4]),this.positionClivisEpisemata(this.notes[1],this.notes[0])}performLayout(t){super.performLayout(t);var e,i,o=this.notes[0],a=this.notes[1],r=this.notes[2],h=this.notes[3],u=this.notes[4],l=s.j.PunctumQuadratum;e=o.liquescent===n.h.InitioDebilis?s.j.TerminatingDesLiquescent:o.shape===n.j.Quilisma?s.j.Quilisma:s.j.PunctumQuadratum,u.liquescent&n.h.Small?(l=s.j.PunctumQuadratumDesLiquescent,i=s.j.TerminatingDesLiquescent):i=u.liquescent&n.h.Ascending?s.j.PunctumQuadratumAscLiquescent:u.liquescent&n.h.Descending?s.j.PunctumQuadratumDesLiquescent:s.j.PunctumQuadratum,this.build(t).noteAt(o,e).withPorrectusSwash(a,r).noteAt(h,l).noteAt(u,i),this.finishLayout(t)}};e.v=class extends h{positionMarkings(){this.positionEpisemataAbove(this.notes[0]),this.positionEpisemataAbove(this.notes[1]),this.positionEpisemataAbove(this.notes[2])}performLayout(t){super.performLayout(t),this.build(t).noteAt(this.notes[0],u.getNoteGlyphCode(this.notes[0])).advanceBy(t.intraNeumeSpacing).noteAt(this.notes[1],u.getNoteGlyphCode(this.notes[1])).advanceBy(t.intraNeumeSpacing).noteAt(this.notes[2],u.getNoteGlyphCode(this.notes[2])),this.finishLayout(t)}};e.x=class extends h{positionMarkings(){this.positionEpisemataAbove(this.notes[0])}performLayout(t){super.performLayout(t),this.build(t).virgaAt(this.notes[0]),this.finishLayout(t)}}},function(t,e,i){"use strict";i(0);class s{constructor(t){this.name=void 0!==t?t:"<unknown>"}syllabify(t){var e=[];if(void 0===t||""===t)return e;for(var i=t.split(/[\s]+/),s=0,n=i.length;s<n;s++)e.push(this.syllabifyWord(i[s]));return e}}e.a=s;e.b=class extends s{constructor(){super("Latin"),this.diphthongs=["ae","au","oe","aé","áu","oé"],this.possibleDiphthongs=this.diphthongs.concat(["ei","eu","ui","éi","éu","úi"]),this.regexVowel=/(i|(?:[qg]|^)u)?([eé][iu]|[uú]i|[ao][eé]|[aá]u|[aeiouáéíóúäëïöüāēīōūăĕĭŏŭåe̊o̊ůæœǽyýÿ])/i;var t=new Object;t.huius=["hui","us"],t.cuius=["cui","us"],t.huic=["huic"],t.cui=["cui"],t.hui=["hui"],t.euge=["eu","ge"],t.seu=["seu"],this.vowels=["a","e","i","o","u","á","é","í","ó","ú","ä","ë","ï","ö","ü","ā","ē","ī","ō","ū","ă","ĕ","ĭ","ŏ","ŭ","å","e̊","o̊","ů","æ","œ","ǽ","y","ý","ÿ"],this.vowelsThatMightBeConsonants=["i","u"],this.muteConsonantsAndF=["b","c","d","g","p","t","f"],this.liquidConsonants=["l","r"]}isVowel(t){for(var e=0,i=this.vowels.length;e<i;e++)if(this.vowels[e]===t)return!0;return!1}isVowelThatMightBeConsonant(t){for(var e=0,i=this.vowelsThatMightBeConsonants.length;e<i;e++)if(this.vowelsThatMightBeConsonants[e]===t)return!0;return!1}isVowelActingAsConsonant(t){return this.isVowelThatMightBeConsonant(t[0])&&this.isVowel(t[1])}isMuteConsonantOrF(t){for(var e=0,i=this.muteConsonantsAndF.length;e<i;e++)if(this.muteConsonantsAndF[e]===t)return!0;return!1}isLiquidConsonant(t){for(var e=0,i=this.liquidConsonants.length;e<i;e++)if(this.liquidConsonants[e]===t)return!0;return!1}isDiphthong(t){for(var e=0,i=this.diphthongs.length;e<i;e++)if(this.diphthongs[e]===t)return!0;return!1}isPossibleDiphthong(t){for(var e=0,i=this.possibleDiphthongs.length;e<i;e++)if(this.possibleDiphthongs[e]===t)return!0;return!1}syllabifyWord(t){for(var e,i,s,n=[],o=!1,a=!1,r=t.toLowerCase(),h=0,u=function(e){o&&(n.push(t.substr(h,e)),h+=e),o=!1},l=0,c=r.length;l<c;l++){e=r[l],i="*",(s=l+1<c)&&(i=r[l+1]);var d=this.isVowel(e);"i"===e&&(0===l&&s&&this.isVowel(i)?d=!1:a&&s&&this.isVowel(i)&&(d=!1)),"-"===e?(o=!0,a=!1,u(l-h),h++):d?(o=!0,a&&!this.isDiphthong(r[l-1]+""+e)&&(u(l-h),o=!0),a=!0):s&&("q"===e&&"u"===i||"h"===i&&("c"===e||"p"===e||"t"===e)?(u(l-h),l++):a&&this.isVowel(i)?u(l-h):this.isMuteConsonantOrF(e)&&this.isLiquidConsonant(i)?u(l-h):o&&u(l+1-h),a=!1)}return o?n.push(t.substr(h)):h>0&&(n[n.length-1]+=t.substr(h)),n}findVowelSegment(t,e){var i=this.regexVowel.exec(t.slice(e));return i?(i[1]&&(i.index+=i[1].length),{found:!0,startIndex:e+i.index,length:i[2].length}):{found:!1,startIndex:-1,length:-1}}};e.c=class extends s{constructor(){super("Spanish"),this.vowels=["a","e","i","o","u","y","á","é","í","ó","ú","ü"],this.weakVowels=["i","u","ü","y"],this.strongVowels=["a","e","o","á","é","í","ó","ú"],this.diphthongs=["ai","ei","oi","ui","ia","ie","io","iu","au","eu","ou","ua","ue","uo","ái","éi","ói","úi","iá","ié","ió","iú","áu","éu","óu","uá","ué","uó","üe","üi"],this.uDiphthongExceptions=["gue","gui","qua","que","qui","quo"]}isVowel(t){for(var e=0,i=this.vowels.length;e<i;e++)if(this.vowels[e]===t)return!0;return!1}isWeakVowel(t){for(var e=0,i=this.weakVowels.length;e<i;e++)if(this.weakVowels[e]===t)return!0;return!1}isStrongVowel(t){for(var e=0,i=this.strongVowels.length;e<i;e++)if(this.strongVowels[e]===t)return!0;return!1}isDiphthong(t){for(var e=0,i=this.diphthongs.length;e<i;e++)if(this.diphthongs[e]===t)return!0;return!1}createSyllable(t){return t}syllabifyWord(t){for(var e=[],i=!1,s=!1,n=!1,o=0,a=0;a<t.length;a++){var r=t[a].toLowerCase();if(this.isVowel(r)){i=!0;var h=this.isStrongVowel(r);s&&h&&n&&(e.push(this.createSyllable(t.substr(o,a-o))),o=a),s=!0,n=h}else{if(i){if("-"===t[a])e.push(this.createSyllable(t.substr(o,a-o))),o=++a;else{for(var u,l=1,c=a+1;c<t.length&&!this.isVowel(t[c]);c++)l++;1===l?(e.push(this.createSyllable(t.substr(o,a-o))),o=a):2===l?"l"===(u=t[a+1].toLowerCase())||"r"===u||"c"===r&&"h"===u?(e.push(this.createSyllable(t.substr(o,a-o))),o=a++):(e.push(this.createSyllable(t.substr(o,++a-o))),o=a):3===l?("s"===(u=t[a+1].toLowerCase())?(a+=2,e.push(this.createSyllable(t.substr(o,a-o)))):e.push(this.createSyllable(t.substr(o,++a-o))),o=a):4===l&&(e.push(this.createSyllable(t.substr(o,a-o+2))),o=a+2,a+=3)}i=!1}s=!1}}return i?e.push(t.substr(o)):o>0?e[e.length-1]+=t.substr(o):0===e.length&&e.push(this.createSyllable(t)),e}findVowelSegment(t,e){var i,s,n,o=t.toLowerCase();for(i=0,s=this.diphthongs.length;i<s;i++){var a=this.diphthongs[i];if((n=o.indexOf(a,e))>=0){if("u"===a[0]&&n>0){var r=t.substr(n-1,3).toLowerCase();for(j=0,endj=this.uDiphthongExceptions.length;i<endj;j++)if(r===this.uDiphthongExceptions[j])return this.findVowelSegment(t,n+1)}return{found:!0,startIndex:n,length:a.length}}}for(i=0,s=this.vowels.length;i<s;i++)if((n=o.indexOf(this.vowels[i],e))>=0)return{found:!0,startIndex:n,length:1};return{found:!1,startIndex:-1,length:-1}}}},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var s=i(1),n=i(6),o=i(0);i.d(e,"Units",function(){return o.n}),i.d(e,"DeviceIndependent",function(){return o.b}),i.d(e,"Centimeters",function(){return o.a}),i.d(e,"Millimeters",function(){return o.e}),i.d(e,"Inches",function(){return o.c}),i.d(e,"ToCentimeters",function(){return o.k}),i.d(e,"ToMillimeters",function(){return o.m}),i.d(e,"ToInches",function(){return o.l}),i.d(e,"Point",function(){return o.g}),i.d(e,"Rect",function(){return o.h}),i.d(e,"Margins",function(){return o.d}),i.d(e,"Size",function(){return o.i}),i.d(e,"Step",function(){return o.j}),i.d(e,"Pitch",function(){return o.f}),i.d(e,"generateRandomGuid",function(){return o.o}),i.d(e,"getCssForProperties",function(){return o.p});var a=i(8);i.d(e,"Language",function(){return a.a}),i.d(e,"Latin",function(){return a.b}),i.d(e,"Spanish",function(){return a.c});var r=i(4);i.d(e,"Glyphs",function(){return r.a}),i.d(e,"GlyphCode",function(){return s.j}),i.d(e,"QuickSvg",function(){return s.p}),i.d(e,"TextMeasuringStrategy",function(){return s.s}),i.d(e,"ChantContext",function(){return s.d}),i.d(e,"ChantLayoutElement",function(){return s.e}),i.d(e,"DividerLineVisualizer",function(){return s.h}),i.d(e,"NeumeLineVisualizer",function(){return s.o}),i.d(e,"VirgaLineVisualizer",function(){return s.u}),i.d(e,"GlyphVisualizer",function(){return s.k}),i.d(e,"RoundBraceVisualizer",function(){return s.q}),i.d(e,"CurlyBraceVisualizer",function(){return s.g}),i.d(e,"TextElement",function(){return s.r}),i.d(e,"LyricType",function(){return s.n}),i.d(e,"LyricArray",function(){return s.m}),i.d(e,"Lyric",function(){return s.l}),i.d(e,"AboveLinesText",function(){return s.a}),i.d(e,"TranslationText",function(){return s.t}),i.d(e,"DropCap",function(){return s.i}),i.d(e,"Annotation",function(){return s.b}),i.d(e,"Annotations",function(){return s.c}),i.d(e,"ChantNotationElement",function(){return s.f});var h=i(2);i.d(e,"LiquescentType",function(){return h.h}),i.d(e,"NoteShape",function(){return h.j}),i.d(e,"NoteShapeModifiers",function(){return h.k}),i.d(e,"Note",function(){return h.i}),i.d(e,"Clef",function(){return h.e}),i.d(e,"DoClef",function(){return h.f}),i.d(e,"FaClef",function(){return h.g}),i.d(e,"TextOnly",function(){return h.l}),i.d(e,"ChantLineBreak",function(){return h.b}),i.d(e,"ChantMapping",function(){return h.c}),i.d(e,"ChantScore",function(){return h.d}),i.d(e,"ChantDocument",function(){return h.a});var u=i(3);i.d(e,"MarkingPositionHint",function(){return u.h}),i.d(e,"AcuteAccent",function(){return u.a}),i.d(e,"HorizontalEpisemaAlignment",function(){return u.f}),i.d(e,"HorizontalEpisema",function(){return u.e}),i.d(e,"Ictus",function(){return u.g}),i.d(e,"Mora",function(){return u.i}),i.d(e,"BraceShape",function(){return u.d}),i.d(e,"BraceAttachment",function(){return u.b}),i.d(e,"BracePoint",function(){return u.c});var l=i(5);i.d(e,"Custos",function(){return l.c}),i.d(e,"Divider",function(){return l.d}),i.d(e,"QuarterBar",function(){return l.i}),i.d(e,"HalfBar",function(){return l.h}),i.d(e,"FullBar",function(){return l.g}),i.d(e,"DominicanBar",function(){return l.e}),i.d(e,"DoubleBar",function(){return l.f}),i.d(e,"AccidentalType",function(){return l.b}),i.d(e,"Accidental",function(){return l.a}),i.d(e,"Virgula",function(){return l.j});var c=i(7);if(i.d(e,"Neume",function(){return c.f}),i.d(e,"Apostropha",function(){return c.a}),i.d(e,"Bivirga",function(){return c.b}),i.d(e,"Trivirga",function(){return c.w}),i.d(e,"Climacus",function(){return c.c}),i.d(e,"Clivis",function(){return c.d}),i.d(e,"Distropha",function(){return c.e}),i.d(e,"Oriscus",function(){return c.g}),i.d(e,"PesQuassus",function(){return c.h}),i.d(e,"PesSubpunctis",function(){return c.i}),i.d(e,"Podatus",function(){return c.j}),i.d(e,"Porrectus",function(){return c.k}),i.d(e,"PorrectusFlexus",function(){return c.l}),i.d(e,"PunctaInclinata",function(){return c.m}),i.d(e,"Punctum",function(){return c.n}),i.d(e,"Salicus",function(){return c.o}),i.d(e,"SalicusFlexus",function(){return c.p}),i.d(e,"Scandicus",function(){return c.q}),i.d(e,"ScandicusFlexus",function(){return c.r}),i.d(e,"Torculus",function(){return c.s}),i.d(e,"TorculusResupinus",function(){return c.t}),i.d(e,"TorculusResupinusFlexus",function(){return c.u}),i.d(e,"Tristropha",function(){return c.v}),i.d(e,"Virga",function(){return c.x}),i.d(e,"Gabc",function(){return n.a}),"undefined"!=typeof document&&document.registerElement){var d=Object.create(HTMLElement.prototype);d.createdCallback=function(){var t=new s.d;t.setFont("'Crimson Text', serif",19.2);var e=!0;"false"===this.getAttribute("use-drop-cap")&&(e=!1);var i=n.a.loadChantScore(t,this.innerText,e),o=this.getAttribute("annotation");o&&(i.annotation=new s.b(t,o));var a=this,r=0,h=function(){var e=a.parentElement.clientWidth;r!==e&&(r=e,i.performLayout(t,function(){i.layoutChantLines(t,r,function(){a.appendElement(i.createSvgNode(t))})}))};h(),window.addEventListener?window.addEventListener("resize",h,!1):window.attachEvent&&window.attachEvent("onresize",h)},d.attachedCallback=function(){},document.registerElement("chant-visual",{prototype:d})}},function(t,e,i){"use strict";var s=i(11),n=i(12);function o(){this.protocol=null,this.slashes=null,this.auth=null,this.host=null,this.port=null,this.hostname=null,this.hash=null,this.search=null,this.query=null,this.pathname=null,this.path=null,this.href=null}e.parse=v,e.resolve=function(t,e){return v(t,!1,!0).resolve(e)},e.resolveObject=function(t,e){return t?v(t,!1,!0).resolveObject(e):e},e.format=function(t){n.isString(t)&&(t=v(t));return t instanceof o?t.format():o.prototype.format.call(t)},e.Url=o;var a=/^([a-z0-9.+-]+:)/i,r=/:[0-9]*$/,h=/^(\/\/?(?!\/)[^\?\s]*)(\?[^\s]*)?$/,u=["{","}","|","\\","^","`"].concat(["<",">",'"',"`"," ","\r","\n","\t"]),l=["'"].concat(u),c=["%","/","?",";","#"].concat(l),d=["/","?","#"],f=/^[+a-z0-9A-Z_-]{0,63}$/,g=/^([+a-z0-9A-Z_-]{0,63})(.*)$/,p={javascript:!0,"javascript:":!0},m={javascript:!0,"javascript:":!0},y={http:!0,https:!0,ftp:!0,gopher:!0,file:!0,"http:":!0,"https:":!0,"ftp:":!0,"gopher:":!0,"file:":!0},x=i(13);function v(t,e,i){if(t&&n.isObject(t)&&t instanceof o)return t;var s=new o;return s.parse(t,e,i),s}o.prototype.parse=function(t,e,i){if(!n.isString(t))throw new TypeError("Parameter 'url' must be a string, not "+typeof t);var o=t.indexOf("?"),r=-1!==o&&o<t.indexOf("#")?"?":"#",u=t.split(r);u[0]=u[0].replace(/\\/g,"/");var v=t=u.join(r);if(v=v.trim(),!i&&1===t.split("#").length){var b=h.exec(v);if(b)return this.path=v,this.href=v,this.pathname=b[1],b[2]?(this.search=b[2],this.query=e?x.parse(this.search.substr(1)):this.search.substr(1)):e&&(this.search="",this.query={}),this}var L=a.exec(v);if(L){var w=(L=L[0]).toLowerCase();this.protocol=w,v=v.substr(L.length)}if(i||L||v.match(/^\/\/[^@\/]+@[^@\/]+/)){var S="//"===v.substr(0,2);!S||L&&m[L]||(v=v.substr(2),this.slashes=!0)}if(!m[L]&&(S||L&&!y[L])){for(var C,T,P=-1,N=0;N<d.length;N++){-1!==(A=v.indexOf(d[N]))&&(-1===P||A<P)&&(P=A)}-1!==(T=-1===P?v.lastIndexOf("@"):v.lastIndexOf("@",P))&&(C=v.slice(0,T),v=v.slice(T+1),this.auth=decodeURIComponent(C)),P=-1;for(N=0;N<c.length;N++){var A;-1!==(A=v.indexOf(c[N]))&&(-1===P||A<P)&&(P=A)}-1===P&&(P=v.length),this.host=v.slice(0,P),v=v.slice(P),this.parseHost(),this.hostname=this.hostname||"";var I="["===this.hostname[0]&&"]"===this.hostname[this.hostname.length-1];if(!I)for(var j=this.hostname.split(/\./),M=(N=0,j.length);N<M;N++){var k=j[N];if(k&&!k.match(f)){for(var F="",O=0,E=k.length;O<E;O++)k.charCodeAt(O)>127?F+="x":F+=k[O];if(!F.match(f)){var D=j.slice(0,N),z=j.slice(N+1),B=k.match(g);B&&(D.push(B[1]),z.unshift(B[2])),z.length&&(v="/"+z.join(".")+v),this.hostname=D.join(".");break}}}this.hostname.length>255?this.hostname="":this.hostname=this.hostname.toLowerCase(),I||(this.hostname=s.toASCII(this.hostname));var V=this.port?":"+this.port:"",q=this.hostname||"";this.host=q+V,this.href+=this.host,I&&(this.hostname=this.hostname.substr(1,this.hostname.length-2),"/"!==v[0]&&(v="/"+v))}if(!p[w])for(N=0,M=l.length;N<M;N++){var W=l[N];if(-1!==v.indexOf(W)){var H=encodeURIComponent(W);H===W&&(H=escape(W)),v=v.split(W).join(H)}}var R=v.indexOf("#");-1!==R&&(this.hash=v.substr(R),v=v.slice(0,R));var Q=v.indexOf("?");if(-1!==Q?(this.search=v.substr(Q),this.query=v.substr(Q+1),e&&(this.query=x.parse(this.query)),v=v.slice(0,Q)):e&&(this.search="",this.query={}),v&&(this.pathname=v),y[w]&&this.hostname&&!this.pathname&&(this.pathname="/"),this.pathname||this.search){V=this.pathname||"";var U=this.search||"";this.path=V+U}return this.href=this.format(),this},o.prototype.format=function(){var t=this.auth||"";t&&(t=(t=encodeURIComponent(t)).replace(/%3A/i,":"),t+="@");var e=this.protocol||"",i=this.pathname||"",s=this.hash||"",o=!1,a="";this.host?o=t+this.host:this.hostname&&(o=t+(-1===this.hostname.indexOf(":")?this.hostname:"["+this.hostname+"]"),this.port&&(o+=":"+this.port)),this.query&&n.isObject(this.query)&&Object.keys(this.query).length&&(a=x.stringify(this.query));var r=this.search||a&&"?"+a||"";return e&&":"!==e.substr(-1)&&(e+=":"),this.slashes||(!e||y[e])&&!1!==o?(o="//"+(o||""),i&&"/"!==i.charAt(0)&&(i="/"+i)):o||(o=""),s&&"#"!==s.charAt(0)&&(s="#"+s),r&&"?"!==r.charAt(0)&&(r="?"+r),e+o+(i=i.replace(/[?#]/g,function(t){return encodeURIComponent(t)}))+(r=r.replace("#","%23"))+s},o.prototype.resolve=function(t){return this.resolveObject(v(t,!1,!0)).format()},o.prototype.resolveObject=function(t){if(n.isString(t)){var e=new o;e.parse(t,!1,!0),t=e}for(var i=new o,s=Object.keys(this),a=0;a<s.length;a++){var r=s[a];i[r]=this[r]}if(i.hash=t.hash,""===t.href)return i.href=i.format(),i;if(t.slashes&&!t.protocol){for(var h=Object.keys(t),u=0;u<h.length;u++){var l=h[u];"protocol"!==l&&(i[l]=t[l])}return y[i.protocol]&&i.hostname&&!i.pathname&&(i.path=i.pathname="/"),i.href=i.format(),i}if(t.protocol&&t.protocol!==i.protocol){if(!y[t.protocol]){for(var c=Object.keys(t),d=0;d<c.length;d++){var f=c[d];i[f]=t[f]}return i.href=i.format(),i}if(i.protocol=t.protocol,t.host||m[t.protocol])i.pathname=t.pathname;else{for(var g=(t.pathname||"").split("/");g.length&&!(t.host=g.shift()););t.host||(t.host=""),t.hostname||(t.hostname=""),""!==g[0]&&g.unshift(""),g.length<2&&g.unshift(""),i.pathname=g.join("/")}if(i.search=t.search,i.query=t.query,i.host=t.host||"",i.auth=t.auth,i.hostname=t.hostname||t.host,i.port=t.port,i.pathname||i.search){var p=i.pathname||"",x=i.search||"";i.path=p+x}return i.slashes=i.slashes||t.slashes,i.href=i.format(),i}var v=i.pathname&&"/"===i.pathname.charAt(0),b=t.host||t.pathname&&"/"===t.pathname.charAt(0),L=b||v||i.host&&t.pathname,w=L,S=i.pathname&&i.pathname.split("/")||[],C=(g=t.pathname&&t.pathname.split("/")||[],i.protocol&&!y[i.protocol]);if(C&&(i.hostname="",i.port=null,i.host&&(""===S[0]?S[0]=i.host:S.unshift(i.host)),i.host="",t.protocol&&(t.hostname=null,t.port=null,t.host&&(""===g[0]?g[0]=t.host:g.unshift(t.host)),t.host=null),L=L&&(""===g[0]||""===S[0])),b)i.host=t.host||""===t.host?t.host:i.host,i.hostname=t.hostname||""===t.hostname?t.hostname:i.hostname,i.search=t.search,i.query=t.query,S=g;else if(g.length)S||(S=[]),S.pop(),S=S.concat(g),i.search=t.search,i.query=t.query;else if(!n.isNullOrUndefined(t.search)){if(C)i.hostname=i.host=S.shift(),(I=!!(i.host&&i.host.indexOf("@")>0)&&i.host.split("@"))&&(i.auth=I.shift(),i.host=i.hostname=I.shift());return i.search=t.search,i.query=t.query,n.isNull(i.pathname)&&n.isNull(i.search)||(i.path=(i.pathname?i.pathname:"")+(i.search?i.search:"")),i.href=i.format(),i}if(!S.length)return i.pathname=null,i.search?i.path="/"+i.search:i.path=null,i.href=i.format(),i;for(var T=S.slice(-1)[0],P=(i.host||t.host||S.length>1)&&("."===T||".."===T)||""===T,N=0,A=S.length;A>=0;A--)"."===(T=S[A])?S.splice(A,1):".."===T?(S.splice(A,1),N++):N&&(S.splice(A,1),N--);if(!L&&!w)for(;N--;N)S.unshift("..");!L||""===S[0]||S[0]&&"/"===S[0].charAt(0)||S.unshift(""),P&&"/"!==S.join("/").substr(-1)&&S.push("");var I,j=""===S[0]||S[0]&&"/"===S[0].charAt(0);C&&(i.hostname=i.host=j?"":S.length?S.shift():"",(I=!!(i.host&&i.host.indexOf("@")>0)&&i.host.split("@"))&&(i.auth=I.shift(),i.host=i.hostname=I.shift()));return(L=L||i.host&&S.length)&&!j&&S.unshift(""),S.length?i.pathname=S.join("/"):(i.pathname=null,i.path=null),n.isNull(i.pathname)&&n.isNull(i.search)||(i.path=(i.pathname?i.pathname:"")+(i.search?i.search:"")),i.auth=t.auth||i.auth,i.slashes=i.slashes||t.slashes,i.href=i.format(),i},o.prototype.parseHost=function(){var t=this.host,e=r.exec(t);e&&(":"!==(e=e[0])&&(this.port=e.substr(1)),t=t.substr(0,t.length-e.length)),t&&(this.hostname=t)}},function(t,e,i){"use strict";const s=2147483647,n=/^xn--/,o=/[^\0-\x7E]/,a=/[\x2E\u3002\uFF0E\uFF61]/g,r={overflow:"Overflow: input needs wider integers to process","not-basic":"Illegal input >= 0x80 (not a basic code point)","invalid-input":"Invalid input"},h=Math.floor,u=String.fromCharCode;function l(t){throw new RangeError(r[t])}function c(t,e){const i=t.split("@");let s="";i.length>1&&(s=i[0]+"@",t=i[1]);const n=function(t,e){const i=[];let s=t.length;for(;s--;)i[s]=e(t[s]);return i}((t=t.replace(a,".")).split("."),e).join(".");return s+n}function d(t){const e=[];let i=0;const s=t.length;for(;i<s;){const n=t.charCodeAt(i++);if(n>=55296&&n<=56319&&i<s){const s=t.charCodeAt(i++);56320==(64512&s)?e.push(((1023&n)<<10)+(1023&s)+65536):(e.push(n),i--)}else e.push(n)}return e}const f=function(t,e){return t+22+75*(t<26)-((0!=e)<<5)},g=function(t,e,i){let s=0;for(t=i?h(t/700):t>>1,t+=h(t/e);t>455;s+=36)t=h(t/35);return h(s+36*t/(t+38))},p=function(t){const e=[],i=t.length;let n=0,o=128,a=72,r=t.lastIndexOf("-");r<0&&(r=0);for(let i=0;i<r;++i)t.charCodeAt(i)>=128&&l("not-basic"),e.push(t.charCodeAt(i));for(let c=r>0?r+1:0;c<i;){let r=n;for(let e=1,o=36;;o+=36){c>=i&&l("invalid-input");const r=(u=t.charCodeAt(c++))-48<10?u-22:u-65<26?u-65:u-97<26?u-97:36;(r>=36||r>h((s-n)/e))&&l("overflow"),n+=r*e;const d=o<=a?1:o>=a+26?26:o-a;if(r<d)break;const f=36-d;e>h(s/f)&&l("overflow"),e*=f}const d=e.length+1;a=g(n-r,d,0==r),h(n/d)>s-o&&l("overflow"),o+=h(n/d),n%=d,e.splice(n++,0,o)}var u;return String.fromCodePoint.apply(String,e)},m=function(t){const e=[];let i=(t=d(t)).length,n=128,o=0,a=72;for(const i of t)i<128&&e.push(u(i));let r=e.length,c=r;for(r&&e.push("-");c<i;){let i=s;for(const e of t)e>=n&&e<i&&(i=e);const d=c+1;i-n>h((s-o)/d)&&l("overflow"),o+=(i-n)*d,n=i;for(const i of t)if(i<n&&++o>s&&l("overflow"),i==n){let t=o;for(let i=36;;i+=36){const s=i<=a?1:i>=a+26?26:i-a;if(t<s)break;const n=t-s,o=36-s;e.push(u(f(s+n%o,0))),t=h(n/o)}e.push(u(f(t,0))),a=g(o,d,c==r),o=0,++c}++o,++n}return e.join("")},y={version:"2.1.0",ucs2:{decode:d,encode:t=>String.fromCodePoint.apply(String,function(t){if(Array.isArray(t)){for(var e=0,i=Array(t.length);e<t.length;e++)i[e]=t[e];return i}return Array.from(t)}(t))},decode:p,encode:m,toASCII:function(t){return c(t,function(t){return o.test(t)?"xn--"+m(t):t})},toUnicode:function(t){return c(t,function(t){return n.test(t)?p(t.slice(4).toLowerCase()):t})}};t.exports=y},function(t,e,i){"use strict";t.exports={isString:function(t){return"string"==typeof t},isObject:function(t){return"object"==typeof t&&null!==t},isNull:function(t){return null===t},isNullOrUndefined:function(t){return null==t}}},function(t,e,i){"use strict";e.decode=e.parse=i(14),e.encode=e.stringify=i(15)},function(t,e,i){"use strict";function s(t,e){return Object.prototype.hasOwnProperty.call(t,e)}t.exports=function(t,e,i,o){e=e||"&",i=i||"=";var a={};if("string"!=typeof t||0===t.length)return a;var r=/\+/g;t=t.split(e);var h=1e3;o&&"number"==typeof o.maxKeys&&(h=o.maxKeys);var u=t.length;h>0&&u>h&&(u=h);for(var l=0;l<u;++l){var c,d,f,g,p=t[l].replace(r,"%20"),m=p.indexOf(i);m>=0?(c=p.substr(0,m),d=p.substr(m+1)):(c=p,d=""),f=decodeURIComponent(c),g=decodeURIComponent(d),s(a,f)?n(a[f])?a[f].push(g):a[f]=[a[f],g]:a[f]=g}return a};var n=Array.isArray||function(t){return"[object Array]"===Object.prototype.toString.call(t)}},function(t,e,i){"use strict";var s=function(t){switch(typeof t){case"string":return t;case"boolean":return t?"true":"false";case"number":return isFinite(t)?t:"";default:return""}};t.exports=function(t,e,i,r){return e=e||"&",i=i||"=",null===t&&(t=void 0),"object"==typeof t?o(a(t),function(a){var r=encodeURIComponent(s(a))+i;return n(t[a])?o(t[a],function(t){return r+encodeURIComponent(s(t))}).join(e):r+encodeURIComponent(s(t[a]))}).join(e):r?encodeURIComponent(s(r))+i+encodeURIComponent(s(t)):""};var n=Array.isArray||function(t){return"[object Array]"===Object.prototype.toString.call(t)};function o(t,e){if(t.map)return t.map(e);for(var i=[],s=0;s<t.length;s++)i.push(e(t[s],s));return i}var a=Object.keys||function(t){var e=[];for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&e.push(i);return e}},function(t,e,i){"use strict";var s=i(0),n=(i(7),i(1)),o=i(2),a=i(4),r=i(5),h=i(3);e.a=class extends n.e{constructor(t){super(),this.score=t,this.notationsStartIndex=0,this.numNotationsOnLine=0,this.notationBounds=null,this.staffLeft=0,this.staffRight=0,this.startingClef=null,this.custos=null,this.justify=!0,this.ledgerLines=[],this.braces=[],this.nextLine=null,this.previousLine=null,this.lyricLineHeight=0,this.lyricLineBaseline=0,this.numLyricLines=0,this.spaceAfterNotations=0,this.spaceBetweenTextTracks=0,this.lastLyrics=[]}performLayout(t){var e;this.notationBounds=new s.h(this.staffLeft,-(3.1+t.minSpaceAboveStaff)*t.staffInterval,this.staffRight-this.staffLeft,(6.2+t.minSpaceAboveStaff)*t.staffInterval);var i=this.score.notations,n=null===this.extraTextOnlyIndex?this.notationsStartIndex+this.numNotationsOnLine:this.extraTextOnlyIndex,a=this.notationsStartIndex+this.numNotationsOnLine,r=null;for(this.notationBounds.union(this.startingClef.bounds),this.lyricLineHeight=0,this.lyricLineBaseline=0,this.numLyricLines=0,this.altLineHeight=0,this.altLineBaseline=0,this.numAltLines=0,this.translationLineHeight=0,this.translationLineBaseline=0,this.numTranslationLines=0,e=this.notationsStartIndex;e<n;e++)r=i[e],this.notationBounds.union(r.bounds),r.lyrics.length&&(this.numLyricLines<r.lyrics.length||this.numLyricLines>0&&this.lyricLineHeight*this.lyricLineBaseline==0)&&(r.lyrics[0].bounds.height>this.lyricLineHeight&&(this.lyricLineHeight=r.lyrics[0].bounds.height),r.lyrics[0].origin.y>this.lyricLineBaseline&&(this.lyricLineBaseline=r.lyrics[0].origin.y),r.lyrics.length>this.numLyricLines&&(this.numLyricLines=r.lyrics.length)),r.alText&&this.numAltLines<r.alText.length&&(r.alText[0].bounds.height>this.altLineHeight&&(this.altLineHeight=r.alText[0].bounds.height),r.alText[0].origin.y>this.altLineBaseline&&(this.altLineBaseline=r.alText[0].origin.y),r.alText.length>this.numAltLines&&(this.numAltLines=r.alText.length)),r.translationText&&this.numTranslationLines<r.translationText.length&&(r.translationText[0].bounds.height>this.translationLineHeight&&(this.translationLineHeight=r.translationText[0].bounds.height),r.translationText[0].origin.y>this.translationLineBaseline&&(this.translationLineBaseline=r.translationText[0].origin.y),r.translationText.length>this.numTranslationLines&&(this.numTranslationLines=r.translationText.length));for(this.custos&&this.notationBounds.union(this.custos.bounds),e=0;e<this.braces.length;e++)this.notationBounds.union(this.braces[e].bounds);for(e=this.notationsStartIndex;e<n;e++){r=i[e];for(var h=this.notationBounds.y+this.notationBounds.height,u=0;u<r.lyrics.length;u++)r.lyrics[u].bounds.y=h+this.lyricLineBaseline,h+=this.lyricLineHeight;if(r.translationText)for(u=0;u<r.translationText.length;u++)r.translationText[u].bounds.y=h+this.translationLineBaseline,h+=this.translationLineHeight;if(r.alText)for(h=this.notationBounds.y-2,u=0;u<r.alText.length;u++)h-=this.altLineHeight,r.alText[u].bounds.y=h+this.altLineBaseline}this.extraTextOnlyHeight=0;var l,c=this.extraTextOnlyLyricIndex;if(null===this.extraTextOnlyIndex){let t=i[n-1];t.constructor===o.b&&(t=i[n-2]),t.constructor===o.l&&1===t.lyrics.length&&t.lyrics[0].bounds.height>this.lyricLineHeight&&(this.extraTextOnlyHeight=t.lyrics[c].bounds.height-this.lyricLineHeight)}else{let t=null,s=0;for(h=this.notationBounds.y+this.notationBounds.height+(this.numLyricLines-1)*this.lyricLineHeight,h+=this.numTranslationLines*this.translationLineHeight,e=this.extraTextOnlyIndex;e<a;e++)(r=i[e]).lyrics[c]&&((t=r.lyrics[c]).lineWidth&&(s=this.staffRight-t.lineWidth),t.bounds.y=t.origin.y+h+this.lyricLineBaseline,r.bounds.x+=s);t&&(this.extraTextOnlyHeight=t.origin.y+t.bounds.height-1.2*t.fontSize)}if(this.startingClef.hasLyrics())for(h=this.notationBounds.y+this.notationBounds.height,u=0;u<this.startingClef.lyrics.length;u++)this.startingClef.lyrics[u].bounds.y=h+this.lyricLineBaseline,h+=this.lyricLineHeight;if(0===this.notationsStartIndex&&(null!==this.score.dropCap&&(l=this.notationBounds.y+this.notationBounds.height+this.lyricLineBaseline,this.score.dropCap.bounds.x=this.staffLeft/2,this.score.dropCap.bounds.y=l),null!==this.score.annotation)){if(this.score.annotation.bounds.x=this.staffLeft/2,this.score.annotation.bounds.y=3*-t.staffInterval,null!==this.score.dropCap){var d=this.score.dropCap.bounds.y-this.score.annotation.bounds.height-.65*this.score.dropCap.fontSize;d<this.score.annotation.bounds.y?this.score.annotation.bounds.y=d:this.score.annotation.bounds.y=(this.score.annotation.bounds.y+d)/2;var f=this.score.annotation.bounds.y-this.notationBounds.y;f<0&&(this.notationBounds.y=this.score.annotation.bounds.y,this.notationBounds.height-=f)}this.score.annotation.bounds.y+=.65*this.score.annotation.origin.y}this.notationBounds.height+=Math.max(t.minSpaceBelowStaff*t.staffInterval,this.lyricLineHeight*this.numLyricLines+this.altLineHeight*this.numAltLines+this.translationLineHeight*this.numTranslationLines+this.extraTextOnlyHeight);var g=this.notationBounds.height;this.notationBounds.y-=2+this.altLineHeight*this.numAltLines,this.bounds.x=0,this.bounds.y=this.notationBounds.y,this.bounds.width=this.notationBounds.right(),this.bounds.height=g,this.origin=new s.g(this.staffLeft,-this.notationBounds.y)}draw(t){var e=t.canvasCtxt;e.translate(this.bounds.x,this.bounds.y);var i,s,n=this.staffLeft,o=this.staffRight;for(e.lineWidth=t.staffLineWeight,e.strokeStyle=t.staffLineColor,i=-3;i<=3;i+=2)s=t.staffInterval*i,e.beginPath(),e.moveTo(n,s),e.lineTo(o,s),e.stroke();for(i=0;i<this.ledgerLines.length;i++){var a=this.ledgerLines[i];s=t.calculateHeightFromStaffPosition(a.staffPosition),e.beginPath(),e.moveTo(a.x1,s),e.lineTo(a.x2,s),e.stroke()}0===this.notationsStartIndex&&(null!==this.score.dropCap&&this.score.dropCap.draw(t),null!==this.score.annotation&&this.score.annotation.draw(t));var r=this.score.notations,h=this.notationsStartIndex+this.numNotationsOnLine;for(i=this.notationsStartIndex;i<h;i++)r[i].draw(t);this.startingClef.draw(t),this.custos&&this.custos.draw(t),e.translate(-this.bounds.x,-this.bounds.y)}createSvgNode(t,e=0){var i,s=[],o=this.staffLeft,a=this.staffRight;for(i=-3;i<=3;i+=2)s.push(n.p.createNode("line",{x1:o,y1:t.staffInterval*i,x2:a,y2:t.staffInterval*i,stroke:t.staffLineColor,"stroke-width":t.staffLineWeight,class:"staffLine"}));for(i=0;i<this.ledgerLines.length;i++){var r=this.ledgerLines[i],h=t.calculateHeightFromStaffPosition(r.staffPosition);s.push(n.p.createNode("line",{x1:r.x1,y1:h,x2:r.x2,y2:h,stroke:t.staffLineColor,"stroke-width":t.staffLineWeight,class:"ledgerLine"}))}for(i=0;i<this.braces.length;i++)s.push(this.braces[i].createSvgNode(t));0===this.notationsStartIndex&&(null!==this.score.dropCap&&s.push(this.score.dropCap.createSvgNode(t)),null!==this.score.annotation&&(s=s.concat(this.score.annotation.createSvgNode(t)))),s.push(this.startingClef.createSvgNode(t));var u=this.score.notations,l=this.notationsStartIndex+this.numNotationsOnLine;for(i=this.notationsStartIndex;i<l;i++)s.push(u[i].createSvgNode(t));return this.custos&&s.push(this.custos.createSvgNode(t)),n.p.createNode("g",{class:"chantLine",transform:"translate("+this.bounds.x+","+(this.bounds.y-e)+")"},s)}createSvgFragment(t,e=0){var i,s="",o=this.staffLeft,a=this.staffRight;for(i=-3;i<=3;i+=2)s+=n.p.createFragment("line",{x1:o,y1:t.staffInterval*i,x2:a,y2:t.staffInterval*i,stroke:t.staffLineColor,"stroke-width":t.staffLineWeight,class:"staffLine"});for(i=0;i<this.ledgerLines.length;i++){var r=this.ledgerLines[i],h=t.calculateHeightFromStaffPosition(r.staffPosition);s+=n.p.createFragment("line",{x1:r.x1,y1:h,x2:r.x2,y2:h,stroke:t.staffLineColor,"stroke-width":t.staffLineWeight,class:"ledgerLine"})}for(i=0;i<this.braces.length;i++)s+=this.braces[i].createSvgFragment(t);0===this.notationsStartIndex&&(null!==this.score.dropCap&&(s+=this.score.dropCap.createSvgFragment(t)),null!==this.score.annotation&&(s+=this.score.annotation.createSvgFragment(t))),s+=this.startingClef.createSvgFragment(t);var u=this.score.notations,l=this.notationsStartIndex+this.numNotationsOnLine;for(i=this.notationsStartIndex;i<l;i++)s+=u[i].createSvgFragment(t);return this.custos&&(s+=this.custos.createSvgFragment(t)),n.p.createFragment("g",{class:"chantLine",transform:"translate("+this.bounds.x+","+(this.bounds.y-e)+")"},s)}generateCurlyBraceDrawable(t,e,i,s,o){var a,r=i-e,h=e+.5*r,u=s+(a=o?-t.staffInterval/2:t.staffInterval/2),l="M "+e+" "+s+" Q "+e+" "+(s+.6*a)+" "+(e+.25*r)+" "+(s+.4*a)+" T "+h+" "+u+" M "+i+" "+s+" Q "+i+" "+(s+.6*a)+" "+(e+.75*r)+" "+(s+.4*a)+" T "+h+" "+u;return n.p.createFragment("path",{d:l,stroke:t.neumeLineColor,"stroke-width":t.neumeLineWeight+"px",fill:"none"})}buildFromChantNotationIndex(t,e,i){var s=this.score.notations,h=null,u=null,l=null,c=[],d=[];if(this.notationsStartIndex=e,this.numNotationsOnLine=0,this.staffLeft=0,this.paddingLeft=0,this.extraTextOnlyIndex=null,this.extraTextOnlyLyricIndex=0,this.staffRight=i>0?i:1/0,0===this.notationsStartIndex){var f=0;null!==this.score.dropCap&&(f=this.score.dropCap.bounds.width+2*this.score.dropCap.padding),null!==this.score.annotation&&(f=Math.max(f,this.score.annotation.bounds.width+2*this.score.annotation.padding)),this.staffLeft+=f,null!==this.score.dropCap&&(this.paddingLeft=(f-this.score.dropCap.bounds.width)/2)}else if((u=s[e-1]).constructor===r.f&&u.hasLyrics()&&(u.lyrics.length>1||!u.lyrics[0].text.match(/^(i\.?)+j\.?/))){var g=(h=u.lyrics.map(function(e){var i=new n.l(t,e.originalText,e.lyricType,e.notation,e.notations,e.sourceIndex);return i.elidesToNext=e.elidesToNext,e.bounds.y=Number.MAX_SAFE_INTEGER,i})).map(function(t){return t.bounds.x}).reduce(function(t,e){return t<e?t:e});h.forEach(function(t){t.bounds.x-=g})}s[e].isClef&&(t.activeClef=s[e].clone(),e++,this.notationsStartIndex++),this.startingClef=t.activeClef.clone(),this.startingClef.performLayout(t),this.startingClef.bounds.x=this.staffLeft;var p=this.startingClef;h&&n.m.setNotation(h,p);var m,y,x,v,b=this.staffRight-a.a.CustosLong.bounds.width*t.glyphScaling,L=null,w=s.length-1;for(p.hasLyrics()&&n.m.mergeIn(this.lastLyrics,p.lyrics),t.lastStartBrace&&!t.lastStartBrace.note&&(t.lastStartBrace.note=this.startingClef),m=e;m<=w;m++){var S;u=p,p.constructor!==o.l&&(l=p),p=s[m],S=m===w||p.constructor===r.c||u.constructor===r.c&&p.isDivider||p.constructor===o.b&&l.constructor===r.c?this.staffRight:m===w-1?Math.max(b,this.staffRight-s[w].bounds.width):b;var C=!p.isDivider&&p.constructor!==o.b&&p.constructor!==r.c&&w-m>1&&!l.keepWithNext&&l.bounds.right()>=b;C=C||null!==this.extraTextOnlyIndex&&p.constructor!==o.l&&p.constructor!==o.b&&p.constructor!==r.c&&p.hasLyrics(),p.constructor===o.l&&u===l&&(x=this.lastLyrics.slice(),v=m),p.hasLyrics()&&p.lyrics[0].needsLayout&&p.lyrics[0].recalculateMetrics(t);var T,P=!C&&this.positionNotationElement(t,this.lastLyrics,l,p,S,d),N=p.constructor===o.l&&n.m.hasOnlyOneLyric(p.lyrics)&&(!1===P||null!==this.extraTextOnlyIndex);if(N&&null===this.extraTextOnlyIndex&&(T=n.m.indexOfLyric(p.lyrics),v===m&&s[m].lyrics[T].text.length<=1)){var A=s[m+1];N=A&&A.constructor===o.l&&A.lyrics[T]&&A.lyrics[T].text.length>0}if(N){var I;if(T=this.extraTextOnlyLyricIndex,null===this.extraTextOnlyIndex){this.extraTextOnlyIndex=v,T=this.extraTextOnlyLyricIndex=n.m.indexOfLyric(p.lyrics),this.lastLyricsBeforeTextOnly=x,this.lastLyrics=[],m=v-1,this.numNotationsOnLine=v-this.notationsStartIndex,s[v].lyrics[T].origin.y=0;continue}m!==this.extraTextOnlyIndex&&(p.lyrics[T].origin.y=this.lastLyrics[T].origin.y),delete p.lyrics[T].lineWidth,P&&m!==this.extraTextOnlyIndex||(p.bounds.x=p.lyrics[T].origin.x,p.lyrics[T].origin.y+=(this.lastLyrics[T]||p.lyrics[T]).bounds.height,p.lyrics[T].setMaxWidth(t,this.staffRight,this.staffRight-(n.m.getRight(this.lastLyrics)+t.minLyricWordSpacing||0)),I=p),I&&(I.lyrics[T].lineWidth=p.lyrics[T].getRight())}else if(!1===P){for(;this.numNotationsOnLine>0&&(p.isDivider||p.constructor===r.c);)p=s[--m],this.numNotationsOnLine--;for(L&&console.info(s[m-1],L),y=m-1;y>this.notationsStartIndex;y--){var j=s[y];if(p=s[y+1],j.firstWithNoWidth)this.numNotationsOnLine--;else if(L)this.numNotationsOnLine--,j===L&&(L=null);else if(!p||!p.notes||p.notes[0].shape!==o.j.Quilisma&&p.notes[0].shape!==o.j.Inclinatum){if(!0!==j.keepWithNext)break;j.allowLineBreakBeforeNext&&!this.maxNumNotationsOnLine&&(this.maxNumNotationsOnLine=this.numNotationsOnLine),this.numNotationsOnLine--}else this.numNotationsOnLine--}if(0===this.numNotationsOnLine&&(numNotationsOnLine=1),p=this.findNeumesToJustify(c),this.lastLyrics=c,this.maxNumNotationsOnLine&&this.getWhitespaceOnRight(t)/this.toJustify.length>t.staffInterval*t.maxExtraSpaceInStaffIntervals&&(n.m.mergeInArray(c,s.slice(this.notationsStartIndex+this.numNotationsOnLine,this.notationsStartIndex+this.maxNumNotationsOnLine)),this.numNotationsOnLine=this.maxNumNotationsOnLine,delete this.maxNumNotationsOnLine),s[y].isDivider&&s[y-1].constructor===r.c){for(c=[],m=y-2;m>=this.notationsStartIndex;m--)if(s[m].hasLyrics()){n.m.mergeIn(c,s[m].lyrics);break}d.sum-=d.pop().condensable,d.sum-=d.pop().condensable,this.positionNotationElement(t,c,s[y-2],s[y],this.staffRight,d),this.custos=s[y-1],this.custos.bounds.x=this.staffRight-this.custos.bounds.width-this.custos.leadingSpace}break}if(p.hasLyrics()&&n.m.mergeIn(this.lastLyrics,p.lyrics),L&&p===L.translationText[0].endNeume?L=null:p.translationText&&p.translationText.length&&p.translationText[0].endNeume&&(L=p),p.line=this,this.numNotationsOnLine++,p.isClef&&(t.activeClef=p),p.constructor===o.b&&i>0){this.justify=p.justify||null!==this.extraTextOnlyIndex,this.justify&&this.findNeumesToJustify(c);break}p.constructor===r.c?this.custos=p:p.isNeume&&(this.custos=null)}for(var M=this.notationsStartIndex+this.numNotationsOnLine-1,k=s[M];M&&(k.constructor===o.b||k.constructor===r.c||k.constructor===o.l);)k=s[--M];var F=this.notationsStartIndex+this.numNotationsOnLine===s.length;if((this.justify&&null!==this.extraTextOnlyIndex||i>0&&F)&&(this.toJustify||this.findNeumesToJustify(c),this.justify=(!F||k.isDivider)&&this.getWhitespaceOnRight(t)/(this.toJustify.length||1)<=t.staffInterval*t.maxExtraSpaceInStaffIntervals),!this.custos)for(m=this.notationsStartIndex+this.numNotationsOnLine;m<s.length;m++)if(s[m].isNeume){this.custos=new r.c(!0),t.currNotationIndex=m-1,this.custos.performLayout(t),this.justify?this.custos.bounds.x=this.staffRight-this.custos.bounds.width-this.custos.leadingSpace:this.custos.bounds.x=l.bounds.right()+l.trailingSpace;break}if(this.lastLyricsBeforeTextOnly&&(this.lastLyrics=this.lastLyricsBeforeTextOnly,delete this.lastLyricsBeforeTextOnly),i>0){var O=this.getWhitespaceOnRight(),E=this.staffRight;O<0&&(E-=O)}for(m=0;this.lastLyrics&&this.lastLyrics[m];){let e=this.lastLyrics[m];if(e.allowsConnector()&&(e.setNeedsConnector(!0,0),i>0&&t.minLyricWordSpacing<t.hyphenWidth&&(O=E-e.getRight())<0)){var D=Math.max(t.hyphenWidth+O,this.lastLyrics.length>1?t.intraNeumeSpacing:t.minLyricWordSpacing);e.setConnectorWidth(D)}++m}i<=0&&(this.staffRight=s[this.notationsStartIndex+this.numNotationsOnLine-1].bounds.right(),this.justify=!1),this.justifyElements(t,this.justify,d),this.centerDividers(),this.finishLayout(t)}centerDividers(){for(var t,e=null===this.extraTextOnlyIndex?this.notationsStartIndex+this.numNotationsOnLine:this.extraTextOnlyIndex,i=this.notationsStartIndex;i<e;i++)if((t=this.score.notations[i])&&t.isDivider){var s=1,n=this.score.notations[i-s],a=i+s===e?this.custos:this.score.notations[i+s];if(n===a&&a===this.custos)n=this.score.notations[i-2];else{for(;a&&a.constructor===o.l;)a=i+ ++s===e?this.custos:this.score.notations[i+s];for(s=1;n&&n.constructor===o.l;){if(i-++s<this.notationsStartIndex){n=null;break}n=this.score.notations[i-s]}}if(n&&a){var h=t.bounds.x;if(t.bounds.x=(n.bounds.right()+a.bounds.x-t.bounds.width)/2,t.hasLyrics()){var u=h-t.bounds.x;for(s=t.lyrics.length-1;s>=0;s--)t.lyrics[s].bounds.x+=u,t.lyrics[s].needsLayout=!0}}else i!==e-1||!this.justify||t.constructor!==r.f&&t.constructor!==r.g||(t.bounds.x=this.staffRight-t.bounds.width)}}findNeumesToJustify(t){this.toJustify=[];for(var e,i=null,s=null,a=null,r=null===this.extraTextOnlyIndex?this.notationsStartIndex+this.numNotationsOnLine:this.extraTextOnlyIndex,h=this.notationsStartIndex;h<r;h++){e=a;var u=(a=(s=(i=this.score.notations[h]).isAccidental&&this.score.notations[++h])||i).hasLyrics();i&&e&&(null!==e&&(n.m.mergeIn(t,e.lyrics),!0===e.keepWithNext)||!i.isDivider&&t.length&&t[0].allowsConnector()&&u||a.constructor!==o.b&&(a!==this.custos||u)&&(0===h&&this.score.useDropCap&&u||this.toJustify.push(i)))}return null!==a&&n.m.mergeIn(t,a.lyrics),(s=this.score.notations[r])&&s.hasLyrics()&&(s.lyrics[0].lyricType===n.n.BeginningSyllable||s.lyrics[0].lyricType===n.n.SingleSyllable)&&this.toJustify.push(this.custos),a}getWhitespaceOnRight(t){var e=this.score.notations,i=null===this.extraTextOnlyIndex?this.notationsStartIndex+this.numNotationsOnLine:this.extraTextOnlyIndex,s=e[i-1],o=s?s.bounds.right()+s.trailingSpace:0,r=this.lastLyricsBeforeTextOnly||this.lastLyrics,h=r.length?n.m.getRight(r):0;return this.custos?(o+=this.custos.bounds.width+this.custos.leadingSpace,this.custos.hasLyrics()&&(h=n.m.getRight(this.custos.lyrics))):t&&i<e.length&&(o+=a.a.CustosLong.bounds.width*t.glyphScaling),this.staffRight-Math.max(h,o)}justifyElements(t,e,i){var s,a=this.toJustify||[],r=this.score.notations,h=this.notationsStartIndex+this.numNotationsOnLine,u=r[this.notationsStartIndex+this.numNotationsOnLine-1],l=this.staffRight<1/0&&this.custos&&u.keepWithNext&&this.custos.bounds.x-u.bounds.right()-u.trailingSpace;if(l>0){for(s=0;this.lastLyrics&&this.lastLyrics[s];){let e=this.lastLyrics[s];if(e.allowsConnector()){var c=e.getConnectorWidth();if(t.minLyricWordSpacing<c){var d=Math.max(c-l,this.lastLyrics.length>1?t.intraNeumeSpacing:t.minLyricWordSpacing);e.setConnectorWidth(d)}}++s}this.custos.bounds.x=u.bounds.right()+u.trailingSpace}var f=this.getWhitespaceOnRight();if(!(Math.abs(f)<.5||f>0&&(e&&0===a.length||!e))){var g,p;this.condensableSpaces=i;var m=0,y=f/a.length,x=0,v=0;f<0&&(a=i.filter(t=>t.condensable>0),x=f/i.sum,y=0);var b=a[v++],L=!1;for(s=this.notationsStartIndex;s<h;s++)p=g,g=r[s],null!==this.extraTextOnlyIndex&&s>=this.extraTextOnlyIndex&&g.constructor===o.l||(x||g!==this.custos?(x?b&&b.notation===g&&(m+=x*b.condensable,b=a[v++]):b===g?(p.hasNoWidth?L=!0:m+=y,b=a[v++]):L&&!p.hasNoWidth&&(L=!1,m+=y),g.bounds.x+=m):g.hasLyrics()?(g.bounds.x=Math.min(g.bounds.x+(this.staffRight-n.m.getRight(g.lyrics)),this.staffRight-g.bounds.width),m+=y):g.bounds.x=Math.min(g.bounds.x+m,this.staffRight-g.bounds.width));l>0&&(this.custos.bounds.x=u.bounds.right()+u.trailingSpace)}}handleEndBrace(t,e,i){var s=t.lastStartBrace;if(s){var o,a=s.notationIndex,r=this.score.notations,u=t.intraNeumeSpacing/2,l=s.note;o=s.isAbove?Math.min(t.calculateHeightFromStaffPosition(4),...[l,e].concat(r.slice(a,i+1)).map(t=>t.bounds.y-u)):Math.max(t.calculateHeightFromStaffPosition(-4),...[l,e].concat(r.slice(a,i+1)).map(t=>t.bounds.bottom()+u));var c=!1;s.shape===h.d.RoundBrace?this.braces.push(new n.q(t,s.getAttachmentX(l),e.braceEnd.getAttachmentX(e),o,s.isAbove)):(s.shape===h.d.AccentedCurlyBrace&&(c=!0),this.braces.push(new n.g(t,s.getAttachmentX(l),e.braceEnd.getAttachmentX(e),o,s.isAbove,c))),delete t.lastStartBrace}}finishLayout(t){this.ledgerLines=[];for(var e=this.score.notations,i=this.notationsStartIndex+this.numNotationsOnLine,s=(e,i=e,s=e.staffPosition,n=(e.neume?e.neume.bounds.x:0))=>{if(s>=5||s<=-5){var o=n+e.bounds.x-t.intraNeumeSpacing,a=n+i.bounds.x+i.bounds.width+t.intraNeumeSpacing;s-=s>0?(s-1)%2:(s+1)%2;var r=t.staffInterval*t.minLedgerSeparation;if(this.ledgerLines.length>0&&this.ledgerLines[this.ledgerLines.length-1].x2+r>=o){var h=(o-this.ledgerLines[this.ledgerLines.length-1].x2)/2;this.ledgerLines[this.ledgerLines.length-1].x2+=h,o-=h}a>this.staffRight&&(a=this.staffRight),this.ledgerLines.push({x1:o,x2:a,staffPosition:s})}},o=[],a=null,u=Number.MAX_VALUE,l=Number.MIN_VALUE,c=(e,i,s)=>{e.setMaxWidth(t,this.staffRight),e.bounds.x=0,s&&(e.bounds.x=(e.bounds.x+s-e.bounds.width)/2);var n=i.bounds.x+e.bounds.right()-this.staffRight;n>0&&(e.bounds.x-=n),i.bounds.x+e.bounds.x<0&&(e.bounds.x=-i.bounds.x)},d=this.notationsStartIndex;d<i;d++){var f=e[d];if(u=Math.min(u,f.bounds.y),l=Math.max(l,f.bounds.bottom()),f.constructor!==r.c){if(f.alText)for(var g=0;g<f.alText.length;g++)c(f.alText[g],f);if(f.translationText)for(g=0;g<f.translationText.length;g++){var p=f.translationText[g];if(p.endNeume){var m=p.endNeume.hasLyrics()?p.endNeume.bounds.x+Math.max(...p.endNeume.lyrics.map(t=>t.bounds.right())):p.endNeume.bounds.right();c(p,f,m-=f.bounds.x)}else c(p,f)}if(f.isNeume){for(g=0;g<f.ledgerLines.length;g++){var y=f.ledgerLines[g];s(y.element,y.endElem,y.staffPosition)}for(g=0;g<f.notes.length;g++){var x,v=f.notes[g];for(0===v.episemata.length&&(o=[]),x=0;x<v.episemata.length;x++){var b=v.episemata[x],L=0;if(o.length>0&&(L=f.bounds.x+b.bounds.x-(o[o.length-1].note.neume.bounds.x+o[o.length-1].bounds.right())),0===o.length||o[o.length-1].positionHint!==b.positionHint||!0===o[o.length-1].terminating||o[o.length-1].alignment===h.f.Left||o[o.length-1].alignment===h.f.Center||b.alignment===h.f.Right||b.alignment===h.f.Center||L>2*t.intraNeumeSpacing&&v.glyphVisualizer.glyphCode!==n.j.None)o=[b];else{var w;if(w=b.positionHint===h.h.Below?Math.max(b.bounds.y,o[o.length-1].bounds.y):Math.min(b.bounds.y,o[o.length-1].bounds.y),b.bounds.y!==w)b.bounds.y=w;else for(var S=0;S<o.length;S++)o[S].bounds.y=w;var C=f.bounds.x+b.bounds.x-(o[o.length-1].note.neume.bounds.x+o[o.length-1].bounds.x);C<0&&(C*=-1,o[o.length-1].bounds.x-=C),o[o.length-1].bounds.width=C,o.push(b)}}v.braceEnd&&this.handleEndBrace(t,v,d),v.braceStart&&(t.lastStartBrace=a=v.braceStart,a.notationIndex=d)}}}else s(f)}if(null!==a&&this.custos){var T=e[i],P=T.notes&&T.notes[0],N=e[i+1],A=N&&N.notes&&N.notes[0],I=P&&P.braceEnd||T.isAccidental&&A&&A.braceEnd;I?(this.custos.braceEnd=I,this.handleEndBrace(t,this.custos,d)):(this.braceStart=a,this.custos.braceEnd=new h.c(this.custos,a.isAbove,a.shape,h.b.Right),this.handleEndBrace(t,this.custos,d-1),t.lastStartBrace=new h.c(null,a.isAbove,a.shape,h.b.Left),t.lastStartBrace.notationIndex=d)}this.custos&&s(this.custos)}positionNotationElement(t,e,i,s,a,r=[]){r.hasOwnProperty("sum")||(r.sum=0);var h,u={notation:s},l=!1;if(s.hasNoWidth&&s.firstWithNoWidth!==s||!i.firstWithNoWidth?s.bounds.x=i.bounds.right():(s.bounds.x=i.firstWithNoWidth.bounds.x,l=!0),s.constructor===o.l&&null===this.extraTextOnlyIndex||!s.hasLyrics()&&i.trailingSpace<0?(s.trailingSpace=i.trailingSpace,s.hasLyrics()&&(s.trailingSpace-=s.lyrics[0].bounds.width),s.constructor===o.l&&1===s.lyrics.length&&s.lyrics[0].setMaxWidth(t,this.staffRight,this.staffRight-n.m.getRight(e)-t.minLyricWordSpacing)):l||(s.bounds.x+=i.trailingSpace),s.hasLyrics()&&!i.isDivider&&!i.isAccidental&&this.numNotationsOnLine>0&&(s.lyrics[0].lyricType===n.n.SingleSyllable||s.lyrics[0].lyricType===n.n.BeginningSyllable)&&(s.bounds.x+=t.intraNeumeSpacing*t.interVerbalMultiplier),s.hasNoWidth||l?u.total=u.condensable=0:null!==this.extraTextOnlyIndex&&s.constructor===o.l?(s.bounds.x=0,u.total=u.condensable=0):(u.total=s.bounds.x-i.bounds.right(),u.condensable=u.total*t.condensingTolerance),0===e.length){var c=s.bounds.right()+s.trailingSpace;for(h=0;h<s.lyrics.length;h++){let t=s.lyrics[h],e=t.allowsConnector()&&t.dropCap&&t.originalText&&!t.text;t.setNeedsConnector(e);let i=this.staffLeft-this.paddingLeft;t.getLeft()<i&&(s.bounds.x-=t.getLeft()-i),u.condensable=Math.min(u.condensable,t.getLeft()-i),c=Math.max(c,t.getRight())}return!(c>a+r.sum+u.condensable||(r.push(u),r.sum+=u.condensable,0))}if(s.firstOfSyllable&&e.length&&!s.hasLyrics()&&(s.bounds.x=Math.max(s.bounds.x,e[0].getRight()),u.total=s.bounds.x-i.bounds.right(),u.condensable=u.total*t.condensingTolerance),!1===s.hasLyrics())return!(s.bounds.right()+s.trailingSpace>a+r.sum+u.condensable||(r.push(u),r.sum+=u.condensable,0));do{var d=!1,f=!1;for(h=0;h<s.lyrics.length;h++){if(!s.lyrics[h].originalText)continue;var g=0;let i=[],n=null;if(h<e.length&&e[h]){g=e[h].getRight();let t=r.map(t=>t.notation).lastIndexOf(e[h].notation);(i=r.slice(t+1)).sum=i.map(t=>t.condensable).reduce((t,e)=>t+e,0)}s.lyrics[h].setNeedsConnector(!1);var p=s.lyrics[h].getLeft();if(e[h]&&!1!==e[h].allowsConnector())if(g+.1>p-i.sum-u.condensable){let t=g-p;if(t<-.1){let e=t/(i.sum+u.condensable),s=0;i.forEach(t=>{s+=e*t.condensable,t.notation.bounds.x+=s})}s.bounds.x+=t,n=0,f=!0,d=t>.5}else{if(t.minLyricWordSpacing<t.hyphenWidth){var m=p-g;if(m<t.hyphenWidth){var y=e.length>1?t.intraNeumeSpacing:t.minLyricWordSpacing;e[h].setConnectorWidth(Math.max(y,m))}}if(e[h].setNeedsConnector(!0),(g=e[h].getRight())+.1>p){let t=g-p;s.bounds.x+=t,n=0,d=t>.5}else n=p-g}else if(g+t.minLyricWordSpacing>p){let e=g+t.minLyricWordSpacing-p;s.bounds.x+=e,n=0,d=e>.5}else n=p-g-t.minLyricWordSpacing;if(null!==n&&n<i.sum+u.condensable){let t=i.length+1;u.condensable=n/t,i.sum&&(n-=u.condensable,i.forEach(t=>{t.condensable=n*(t.condensable/i.sum)}),r.sum=r.map(t=>t.condensable).reduce((t,e)=>t+e,0))}}}while(s.lyrics.length>1&&d&&f);for(h=Math.min(s.lyrics.length,e.length)-1;h>=0;h--){let i=e[h];i.needsConnector&&i.connectorWidth&&((m=(p=s.lyrics[h].getLeft())-(g=i.getRight()-i.connectorWidth))>=t.hyphenWidth&&(m=0),i.setConnectorWidth(m))}if(s.bounds.right()+s.trailingSpace<a+r.sum+u.condensable&&n.m.getRight(s.lyrics,!0)<=this.staffRight+r.sum+u.condensable){if(i.isAccidental){let t=s.bounds.x-i.bounds.width-i.trailingSpace-i.bounds.x;if(i.bounds.x+=t,Math.abs(t)>.1){let t=r[r.length-1];r.sum-=t.condensable,t.condensable=0}}return r.push(u),r.sum+=u.condensable,!0}return!1}}}])});